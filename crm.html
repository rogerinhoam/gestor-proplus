<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R.M. Estética Automotiva - CRM</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="app-container">
        <!-- Navigation -->
        <nav class="navbar">
            <div class="nav-brand">
                <i class="fas fa-car"></i>
                <span>R.M. Estética PRO+</span>
            </div>
            <div class="nav-tabs">
                <a href="index.html" class="nav-tab">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Painel</span>
                </a>
                <a href="crm.html" class="nav-tab active">
                    <i class="fas fa-users"></i>
                    <span>CRM</span>
                </a>
                <a href="despesas.html" class="nav-tab">
                    <i class="fas fa-chart-pie"></i>
                    <span>Despesas</span>
                </a>
            </div>
            <div class="nav-status">
                <div class="status-indicator online" id="networkStatus">
                    <i class="fas fa-wifi"></i>
                    <span>Online</span>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <div class="crm-header">
                <h1>CRM - Gestão de Relacionamento</h1>
                <p>Análise de clientes inativos e gestão de follow-ups</p>
            </div>

            <div class="crm-filters">
                <h3>Clientes Inativos</h3>
                <div class="period-filters">
                    <button class="period-btn active" data-period="15">15 dias</button>
                    <button class="period-btn" data-period="30">30 dias</button>
                    <button class="period-btn" data-period="60">60 dias</button>
                    <button class="period-btn" data-period="90">90 dias</button>
                    <button class="period-btn" data-period="180">180 dias</button>
                </div>
            </div>

            <div class="inactive-clients-container">
                <div class="inactive-clients-list" id="inactiveClientsList">
                    <!-- Inactive clients will be populated here -->
                </div>
            </div>

            <div class="section-card">
                <h2>Registrar Interação</h2>
                <form id="interactionForm" class="interaction-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="interactionClient">Cliente *</label>
                            <select id="interactionClient" required>
                                <option value="">Selecione um cliente</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="interactionType">Tipo de Interação *</label>
                            <select id="interactionType" required>
                                <option value="">Selecione o tipo</option>
                                <option value="Ligação">Ligação</option>
                                <option value="WhatsApp">WhatsApp</option>
                                <option value="Email">Email</option>
                                <option value="Visita">Visita</option>
                                <option value="Outro">Outro</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="interactionNotes">Observações *</label>
                        <textarea id="interactionNotes" rows="4" placeholder="Descreva os detalhes da interação..." required></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="followUpDate">Data do Follow-up</label>
                            <input type="date" id="followUpDate">
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i>
                                Registrar Interação
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <div class="section-card">
                <h2>Histórico de Interações</h2>
                <div class="interactions-list" id="interactionsList">
                    <!-- Interactions will be populated here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Carregando...</p>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://bezbszbkaifcanqsmdbi.supabase.co/';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV5bXVuc2F2bnBmY3N1em5ydWdpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3ODU3ODgsImV4cCI6MjA2NjM2MTc4OH0.Kz__-jB9SsD-w7SuwlYCWPuEOcOX9epRE9CB5jd4eFY';

        // Global State
        let state = {
            clientes: [],
            servicos: [],
            orcamentos: [],
            crm_interactions: [],
            filtros: {
                periodoCrm: 15
            },
            loading: false,
            online: navigator.onLine
        };

        // Supabase Client
        class SupabaseClient {
            constructor(url, key) {
                this.url = url;
                this.key = key;
                this.headers = {
                    'apikey': key,
                    'Authorization': `Bearer ${key}`,
                    'Content-Type': 'application/json'
                };
            }

            async query(table, options = {}) {
                const { select = '*', filter = '', order = '', limit = '' } = options;
                let url = `${this.url}/rest/v1/${table}?select=${select}`;
                
                if (filter) url += `&${filter}`;
                if (order) url += `&order=${order}`;
                if (limit) url += `&limit=${limit}`;

                const response = await fetch(url, {
                    headers: this.headers
                });

                if (!response.ok) {
                    throw new Error(`Erro na consulta: ${response.statusText}`);
                }

                return response.json();
            }

            async insert(table, data) {
                const response = await fetch(`${this.url}/rest/v1/${table}`, {
                    method: 'POST',
                    headers: this.headers,
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error(`Erro ao inserir: ${response.statusText}`);
                }

                return response.json();
            }
        }

        const supabase = new SupabaseClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Utility Functions
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        function formatDate(date) {
            return new Date(date).toLocaleDateString('pt-BR');
        }

        function showNotification(message, type = 'info', duration = 5000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const typeIcons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };

            const typeTitles = {
                success: 'Sucesso',
                error: 'Erro',
                warning: 'Aviso',
                info: 'Informação'
            };

            toast.innerHTML = `
                <div class="toast-header">
                    <div class="toast-title">
                        <i class="${typeIcons[type]}"></i>
                        ${typeTitles[type]}
                    </div>
                    <button class="toast-close" onclick="closeToast(this)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="toast-message">${message}</div>
            `;

            container.appendChild(toast);
            
            requestAnimationFrame(() => {
                toast.classList.add('show');
            });

            setTimeout(() => {
                closeToast(toast.querySelector('.toast-close'));
            }, duration);
        }

        function closeToast(button) {
            const toast = button.closest('.toast');
            toast.classList.remove('show');
            setTimeout(() => {
                toast.remove();
            }, 300);
        }

        function showLoading() {
            state.loading = true;
            document.getElementById('loadingOverlay').classList.add('visible');
        }

        function hideLoading() {
            state.loading = false;
            document.getElementById('loadingOverlay').classList.remove('visible');
        }

        function updateNetworkStatus() {
            const statusElement = document.getElementById('networkStatus');
            const isOnline = navigator.onLine;
            
            if (isOnline !== state.online) {
                state.online = isOnline;
                
                if (isOnline) {
                    statusElement.className = 'status-indicator online';
                    statusElement.innerHTML = '<i class="fas fa-wifi"></i><span>Online</span>';
                    showNotification('Conexão restabelecida', 'success');
                    fetchAllData();
                } else {
                    statusElement.className = 'status-indicator offline';
                    statusElement.innerHTML = '<i class="fas fa-wifi-slash"></i><span>Offline</span>';
                    showNotification('Você está offline', 'error');
                }
            }
        }

        async function fetchAllData() {
            try {
                showLoading();
                
                const [clientes, servicos, orcamentos, crm_interactions] = await Promise.all([
                    supabase.query('clientes'),
                    supabase.query('servicos'),
                    supabase.query('orcamentos', { order: 'created_at.desc' }),
                    supabase.query('crm_interactions', { order: 'created_at.desc' })
                ]);

                state.clientes = clientes;
                state.servicos = servicos;
                state.orcamentos = orcamentos;
                state.crm_interactions = crm_interactions;

                renderCRM();
                
            } catch (error) {
                // Use mock data when API fails
                state.clientes = [
                    {"id": "1", "nome": "João Silva", "telefone": "(11) 99999-9999", "carro": "Honda Civic", "placa": "ABC-1234"},
                    {"id": "2", "nome": "Maria Santos", "telefone": "(11) 88888-8888", "carro": "Toyota Corolla", "placa": "DEF-5678"}
                ];
                state.orcamentos = [
                    {
                        "id": "1",
                        "cliente_id": "1",
                        "valor_total": 80.00,
                        "status": "Finalizado",
                        "created_at": "2025-06-15T10:00:00Z"
                    }
                ];
                state.crm_interactions = [];
                
                showNotification('Usando dados de exemplo (API indisponível)', 'warning');
                renderCRM();
            } finally {
                hideLoading();
            }
        }

        function renderCRM() {
            renderInactiveClients();
            renderInteractionForm();
            renderInteractionsList();
        }

        function renderInactiveClients() {
            const period = state.filtros.periodoCrm;
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - period);

            const inactiveClients = state.clientes.filter(client => {
                const lastOrder = state.orcamentos
                    .filter(o => o.cliente_id === client.id && o.status === 'Finalizado')
                    .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))[0];

                if (!lastOrder) return true;
                
                return new Date(lastOrder.created_at) < cutoffDate;
            });

            const container = document.getElementById('inactiveClientsList');
            
            container.innerHTML = inactiveClients.map(client => {
                const ltv = state.orcamentos
                    .filter(o => o.cliente_id === client.id && o.status === 'Finalizado')
                    .reduce((sum, o) => sum + (o.valor_total || 0), 0);

                const lastOrder = state.orcamentos
                    .filter(o => o.cliente_id === client.id && o.status === 'Finalizado')
                    .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))[0];

                return `
                    <div class="inactive-client-item">
                        <div class="inactive-client-header">
                            <div class="inactive-client-name">${client.nome}</div>
                            <div class="client-ltv">LTV: ${formatCurrency(ltv)}</div>
                        </div>
                        <div class="inactive-client-details">
                            <div class="detail-item">
                                <div class="detail-label">Telefone:</div>
                                <div class="detail-value">${client.telefone || 'N/A'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Último Serviço:</div>
                                <div class="detail-value last-service-date">
                                    ${lastOrder ? formatDate(lastOrder.created_at) : 'Nunca'}
                                </div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Carro:</div>
                                <div class="detail-value">${client.carro || 'N/A'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Ações:</div>
                                <div class="detail-value">
                                    <button class="btn btn-sm btn-primary" onclick="selectClientForInteraction('${client.id}')">
                                        <i class="fas fa-phone"></i> Contatar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderInteractionForm() {
            const clientsOptions = state.clientes.map(client => 
                `<option value="${client.id}">${client.nome}</option>`
            ).join('');
            
            document.getElementById('interactionClient').innerHTML = 
                '<option value="">Selecione um cliente</option>' + clientsOptions;
        }

        function selectClientForInteraction(clientId) {
            document.getElementById('interactionClient').value = clientId;
            document.getElementById('interactionClient').focus();
        }

        async function saveInteraction(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const interactionData = {
                cliente_id: formData.get('cliente_id'),
                interaction_type: formData.get('interaction_type'),
                notes: formData.get('notes'),
                follow_up_date: formData.get('follow_up_date') || null,
                created_at: new Date().toISOString()
            };

            if (!interactionData.cliente_id || !interactionData.interaction_type || !interactionData.notes.trim()) {
                showNotification('Todos os campos obrigatórios devem ser preenchidos', 'error');
                return;
            }

            try {
                showLoading();
                await supabase.insert('crm_interactions', interactionData);
                showNotification('Interação registrada com sucesso!', 'success');
                
                document.getElementById('interactionForm').reset();
                await fetchAllData();
                
            } catch (error) {
                showNotification(`Erro ao registrar interação: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        function renderInteractionsList() {
            const container = document.getElementById('interactionsList');
            
            container.innerHTML = state.crm_interactions.map(interaction => {
                const client = state.clientes.find(c => c.id === interaction.cliente_id);
                return `
                    <div class="interaction-item">
                        <div class="interaction-header">
                            <div class="interaction-client">${client ? client.nome : 'Cliente não encontrado'}</div>
                            <div class="interaction-date">${formatDate(interaction.created_at)}</div>
                        </div>
                        <div class="interaction-details">
                            <div class="detail-item">
                                <div class="detail-label">Tipo:</div>
                                <div class="detail-value">${interaction.interaction_type}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Observações:</div>
                                <div class="detail-value">${interaction.notes}</div>
                            </div>
                            ${interaction.follow_up_date ? `
                                <div class="detail-item">
                                    <div class="detail-label">Follow-up:</div>
                                    <div class="detail-value">${formatDate(interaction.follow_up_date)}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            window.addEventListener('online', updateNetworkStatus);
            window.addEventListener('offline', updateNetworkStatus);

            // Form submission
            document.getElementById('interactionForm').addEventListener('submit', saveInteraction);

            // Period buttons
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    state.filtros.periodoCrm = parseInt(this.dataset.period);
                    renderInactiveClients();
                });
            });

            // Initialize
            fetchAllData();
        });

        // Global functions
        window.selectClientForInteraction = selectClientForInteraction;
        window.closeToast = closeToast;
    </script>
</body>
</html>