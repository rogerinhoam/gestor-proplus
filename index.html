<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>R.M. Estética Automotiva – CRM Pro+</title>
  <meta name="description" content="Sistema completo de CRM para gestão de estética automotiva com PWA">
  <meta name="theme-color" content="#ef4444">

  <!-- MANIFEST (injetado por JS) -->
  <link rel="manifest" href="">

  <!-- Ícone principal -->
  <link rel="icon" href="data:image/png;base64,/* base64 do icon_192 */" type="image/png">

  <!-- ===== CSS Unificado ===== -->
  <style>
    /* RESET & VARIÁVEIS */
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --primary:#ef4444;--dark:#1e293b;--bg:#0f172a;--text:#f1f5f9;
      --border:#334155;--radius:.5rem;--spacing:1rem;--transition:.3s
    }
    body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);overflow-x:hidden}
    h1,h2,h3,h4{font-weight:600}

    /* HEADER */
    .header{background:var(--dark);display:flex;justify-content:space-between;align-items:center;padding:var(--spacing)}
    .header .logo{color:var(--primary);font-size:1.25rem}
    .header .sync{color:var(--text);font-size:.875rem}

    /* NAVEGAÇÃO DESKTOP */
    .desktop-nav{background:var(--dark);display:flex;gap:.5rem}
    .nav-tab{background:none;border:none;color:var(--text);padding:.75rem;cursor:pointer;transition:var(--transition)}
    .nav-tab.active{background:var(--bg);border-bottom:2px solid var(--primary);color:var(--primary)}

    /* NAVEGAÇÃO MOBILE */
    .mobile-nav{display:none;position:fixed;bottom:0;width:100%;background:var(--dark);border-top:1px solid var(--border)}
    .mobile-nav-item{flex:1;padding:.5rem;text-align:center;color:var(--text);cursor:pointer}
    .mobile-nav-item.plus{background:var(--primary);color:#fff;border-radius:50%;width:3rem;height:3rem;margin:-1.5rem auto 0;display:flex;align-items:center;justify-content:center}

    /* MAIN & TABS */
    .main{padding:var(--spacing)}
    .tab-content{display:none;animation:fadeIn .3s ease}
    .tab-content.active{display:block}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

    /* MÉTRICAS */
    .metric-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:var(--spacing);margin-bottom:var(--spacing)}
    .metric-card{background:var(--dark);border:1px solid var(--border);border-radius:var(--radius);padding:var(--spacing);display:flex;align-items:center;gap:.5rem;position:relative;overflow:hidden;transition:var(--transition)}
    .metric-card:hover{transform:translateY(-2px);box-shadow:0 4px 6px rgba(0,0,0,.3)}
    .metric-card.blue{color:#3b82f6}.metric-card.green{color:#10b981}.metric-card.orange{color:#f59e0b}.metric-card.purple{color:#8b5cf6}
    .metric-icon{font-size:1.5rem;opacity:.8}
    .metric-body h3{font-size:1.5rem;margin-bottom:.25rem}

    /* CARD GRID */
    .card-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:var(--spacing)}
    .card{background:var(--dark);border:1px solid var(--border);border-radius:var(--radius);padding:var(--spacing);transition:var(--transition)}
    .card:hover{transform:translateY(-2px);box-shadow:0 4px 6px rgba(0,0,0,.3)}
    .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem}
    .card-title{font-size:1.125rem;color:var(--text)}
    .card-info{display:flex;flex-direction:column;gap:.25rem;color:var(--text)}
    .card-actions{display:flex;gap:.5rem;justify-content:flex-end}

    button.btn{padding:.5rem 1rem;border:none;border-radius:var(--radius);cursor:pointer;transition:var(--transition)}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-secondary{background:var(--dark);color:var(--text)}
    .btn-danger{background:#ef4444;color:#fff}
    .btn-sm{padding:.25rem .5rem;font-size:.75rem}

    /* SEARCH */
    .search-bar{position:relative;margin-bottom:var(--spacing);max-width:300px}
    .search-bar input{width:100%;padding:.5rem .5rem .5rem 2rem;border:1px solid var(--border);border-radius:var(--radius);background:var(--bg);color:var(--text)}
    .search-bar i{position:absolute;left:.5rem;top:50%;transform:translateY(-50%);color:var(--text)}

    /* TIMELINE */
    .timeline{position:relative;padding-left:2rem}
    .timeline::before{content:'';position:absolute;left:1rem;top:0;bottom:0;width:2px;background:var(--border)}
    .timeline-item{position:relative;margin-bottom:var(--spacing)}
    .timeline-item::before{content:'';position:absolute;left:0;top:.25rem;width:1rem;height:1rem;border-radius:50%;background:var(--primary);border:2px solid var(--dark)}
    .timeline-content{background:var(--dark);border:1px solid var(--border);border-radius:var(--radius);padding:var(--spacing)}
    .timeline-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem}
    .timeline-title{font-size:1rem;color:var(--text)}
    .timeline-date{font-size:.75rem;color:var(--text)}

    /* DASHBOARD ACTIVITIES */
    .activity-item{display:flex;align-items:center;gap:.5rem;padding:.5rem 0;border-bottom:1px solid var(--border)}
    .activity-icon{width:1.5rem;height:1.5rem;display:flex;align-items:center;justify-content:center;border-radius:50%;font-size:.875rem}
    .activity-content p{margin:0;color:var(--text)}
    .activity-content time{font-size:.75rem;color:var(--text)}
    .activity-icon.cliente{background:rgba(59,130,246,.1);color:#3b82f6}
    .activity-icon.servico{background:rgba(16,185,129,.1);color:#10b981}
    .activity-icon.orcamento{background:rgba(245,158,11,.1);color:#f59e0b}

    /* MODALS & FORMS */
    .modal-backdrop{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:1000;animation:fadeIn .3s}
    .modal{background:var(--dark);border:1px solid var(--border);border-radius:var(--radius);max-width:500px;width:90%;max-height:90vh;overflow:auto;animation:slideIn .3s}
    .modal-large{max-width:800px}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding:var(--spacing);border-bottom:1px solid var(--border)}
    .modal-header h3{color:var(--text)}
    .modal-close{background:none;border:none;color:var(--text);font-size:1.25rem;cursor:pointer}
    .modal-body{padding:var(--spacing)}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
    .form-group{display:flex;flex-direction:column}
    .form-group.full-width{grid-column:1/-1}
    .form-group label{color:var(--text);font-size:.875rem;margin-bottom:.25rem}
    .form-group input,.form-group select,.form-group textarea{padding:.5rem;border:1px solid var(--border);border-radius:var(--radius);background:var(--bg);color:var(--text)}
    .form-actions{display:flex;justify-content:space-between;align-items:center;padding:var(--spacing);border-top:1px solid var(--border)}

    @keyframes slideIn{from{transform:translateY(-20px);opacity:0}to{transform:translateY(0);opacity:1}}

    /* QUOTES */
    .quote-service-item{display:grid;grid-template-columns:2fr 80px 80px 32px;gap:.5rem;align-items:center;padding:.5rem;background:var(--bg);border-radius:var(--radius);margin-bottom:.5rem}
    .quote-total{background:var(--bg);padding:var(--spacing);border-radius:var(--radius);margin:var(--spacing) 0}
    .total-row{display:flex;justify-content:space-between;font-size:.875rem;color:var(--text)}
    .total-row.final{font-weight:600;font-size:1rem;margin-top:.5rem;border-top:1px solid var(--border);padding-top:.5rem}

    /* TOAST */
    .toast{position:fixed;top:var(--spacing);right:var(--spacing);background:var(--dark);color:var(--text);padding:var(--spacing);border-radius:var(--radius);box-shadow:0 4px 6px rgba(0,0,0,.3);border-left:4px solid #3b82f6;transform:translateX(100%);transition:var(--transition);z-index:1001}
    .toast.show{transform:translateX(0)}.toast.success{border-left-color:#10b981}.toast.error{border-left-color:#ef4444}.toast.warning{border-left-color:#f59e0b}

    /* RESPONSIVE */
    @media(max-width:768px){.desktop-nav{display:none}.mobile-nav{display:flex}.form-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <!-- PARTE 2 – HTML Markup e Templates de Modal -->

  <!-- Loading Screen -->
  <div id="loadingScreen" class="loading-screen hidden">
    <div class="loading-content">
      <div class="loading-logo"><i class="fas fa-car"></i></div>
      <h2>R.M. CRM Pro+</h2>
      <p>Carregando sistema...</p>
      <div class="loading-bar"><div id="loadingProgress" class="loading-progress"></div></div>
    </div>
  </div>

  <!-- Header -->
  <header class="header">
    <div class="logo"><i class="fas fa-car"></i> R.M. CRM Pro+</div>
    <div class="sync"><i id="syncIcon" class="fas fa-wifi"></i> <span id="syncStatus">Online</span></div>
  </header>

  <!-- Desktop Nav -->
  <nav class="desktop-nav">
    <button data-tab="dashboard" class="nav-tab active"><i class="fas fa-chart-line"></i> Dashboard</button>
    <button data-tab="clientes" class="nav-tab"><i class="fas fa-users"></i> Clientes</button>
    <button data-tab="servicos" class="nav-tab"><i class="fas fa-wrench"></i> Serviços</button>
    <button data-tab="orcamento" class="nav-tab"><i class="fas fa-calculator"></i> Orçamentos</button>
    <button data-tab="historico" class="nav-tab"><i class="fas fa-history"></i> Histórico</button>
  </nav>

  <!-- Main Content -->
  <main class="main">
    <!-- Dashboard -->
    <div id="dashboard" class="tab-content active">
      <div class="metric-grid">
        <div class="metric-card blue">
          <div class="metric-icon"><i class="fas fa-users"></i></div>
          <div class="metric-body">
            <h3 id="metricTotalClients">0</h3>
            <p>Clientes</p>
          </div>
        </div>
        <div class="metric-card green">
          <div class="metric-icon"><i class="fas fa-wrench"></i></div>
          <div class="metric-body">
            <h3 id="metricServices">0</h3>
            <p>Serviços</p>
          </div>
        </div>
        <div class="metric-card orange">
          <div class="metric-icon"><i class="fas fa-calculator"></i></div>
          <div class="metric-body">
            <h3 id="metricQuotes">0</h3>
            <p>Orçamentos</p>
          </div>
        </div>
        <div class="metric-card purple">
          <div class="metric-icon"><i class="fas fa-dollar-sign"></i></div>
          <div class="metric-body">
            <h3 id="metricRevenue">R$ 0,00</h3>
            <p>Faturamento</p>
          </div>
        </div>
      </div>
      <h3>Atividades Recentes</h3>
      <div id="recentActivities"></div>
    </div>

    <!-- Clientes -->
    <div id="clientes" class="tab-content">
      <div class="page-header">
        <h2>Clientes</h2>
        <button id="btnAddClient" class="btn btn-primary">
          <i class="fas fa-plus"></i> Adicionar Cliente
        </button>
      </div>
      <div class="search-bar">
        <i class="fas fa-search"></i>
        <input id="searchClientes" placeholder="Buscar clientes...">
      </div>
      <div id="clientesGrid" class="card-grid"></div>
    </div>

    <!-- Serviços -->
    <div id="servicos" class="tab-content">
      <div class="page-header">
        <h2>Serviços</h2>
        <button id="btnAddService" class="btn btn-primary">
          <i class="fas fa-plus"></i> Adicionar Serviço
        </button>
      </div>
      <div id="servicosGrid" class="card-grid"></div>
    </div>

    <!-- Orçamentos -->
    <div id="orcamento" class="tab-content">
      <div class="page-header">
        <h2>Orçamentos</h2>
        <button id="btnNewQuote" class="btn btn-primary">
          <i class="fas fa-plus"></i> Novo Orçamento
        </button>
      </div>
      <div id="orcamentosGrid" class="card-grid"></div>
    </div>

    <!-- Histórico -->
    <div id="historico" class="tab-content">
      <h2>Histórico</h2>
      <div class="timeline">
        <div id="historicoList"></div>
      </div>
    </div>
  </main>

  <!-- Mobile Nav -->
  <nav class="mobile-nav">
    <button data-tab="dashboard" class="mobile-nav-item active">
      <i class="fas fa-chart-line"></i>
    </button>
    <button data-tab="clientes" class="mobile-nav-item">
      <i class="fas fa-users"></i>
    </button>
    <button id="quickAddBtn" class="mobile-nav-item plus">
      <i class="fas fa-plus"></i>
    </button>
    <button data-tab="orcamento" class="mobile-nav-item">
      <i class="fas fa-calculator"></i>
    </button>
    <button data-tab="historico" class="mobile-nav-item">
      <i class="fas fa-history"></i>
    </button>
  </nav>

  <!-- Toast Notification -->
  <div id="notification" class="toast"></div>

  <!-- Modal Templates -->
  <template id="clientModal">
    <div class="modal-backdrop">
      <div class="modal">
        <div class="modal-header">
          <h3>Novo Cliente</h3>
          <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <form id="clientForm" class="form-grid">
            <div class="form-group"><label>Nome*<input name="nome" required></label></div>
            <div class="form-group"><label>Telefone*<input name="telefone" required></label></div>
            <div class="form-group"><label>Email<input type="email" name="email"></label></div>
            <div class="form-group"><label>Carro<input name="carro"></label></div>
            <div class="form-group"><label>Placa<input name="placa" maxlength="8"></label></div>
            <div class="form-group full-width"><label>Endereço<input name="endereco"></label></div>
          </form>
        </div>
        <div class="form-actions">
          <button class="btn btn-secondary modal-close">Cancelar</button>
          <button class="btn btn-primary" form="clientForm">Salvar Cliente</button>
        </div>
      </div>
    </div>
  </template>

  <template id="serviceModal">
    <div class="modal-backdrop">
      <div class="modal">
        <div class="modal-header">
          <h3>Novo Serviço</h3>
          <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <form id="serviceForm" class="form-grid">
            <div class="form-group full-width"><label>Descrição*<input name="descricao" required></label></div>
            <div class="form-group"><label>Valor*<input type="number" name="valor" step="0.01" required></label></div>
            <div class="form-group"><label>Duração (min)<input type="number" name="duracao" value="60"></label></div>
            <div class="form-group"><label>Categoria<select name="categoria"><option>Lavagem</option><option>Proteção</option><option>Limpeza</option><option>Detalhamento</option></select></label></div>
            <div class="form-group"><label><input type="checkbox" name="ativo" checked> Ativo</label></div>
          </form>
        </div>
        <div class="form-actions">
          <button class="btn btn-secondary modal-close">Cancelar</button>
          <button class="btn btn-primary" form="serviceForm">Salvar Serviço</button>
        </div>
      </div>
    </div>
  </template>

  <template id="quoteModal">
    <div class="modal-backdrop">
      <div class="modal modal-large">
        <div class="modal-header">
          <h3>Novo Orçamento</h3>
          <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <form id="quoteForm" class="form-grid">
            <div class="form-group"><label>Cliente*<select name="cliente_id" required></select></label></div>
            <div class="form-group"><label>Status<select name="status"><option>Orçamento</option><option>Aprovado</option><option>Finalizado</option><option>Cancelado</option></select></label></div>
            <div class="form-group"><label>Desconto (%)<input type="number" name="desconto" value="0" min="0" max="100"></label></div>
            <div class="form-group full-width"><label>Observações<textarea name="observacoes" rows="3"></textarea></label></div>
          </form>
          <div id="quoteServicesList"></div>
          <button id="addQuoteService" class="btn btn-secondary">+ Serviço</button>
          <div class="quote-total">
            <div class="total-row"><span>Subtotal:</span><span id="quoteSubtotal">R$ 0,00</span></div>
            <div class="total-row"><span>Desconto:</span><span id="quoteDescontoValue">R$ 0,00</span></div>
            <div class="total-row final"><span>Total:</span><span id="quoteTotal">R$ 0,00</span></div>
          </div>
        </div>
        <div class="form-actions">
          <button class="btn btn-secondary modal-close">Cancelar</button>
          <button class="btn btn-primary" form="quoteForm">Salvar Orçamento</button>
        </div>
      </div>
    </div>
  </template>
  <!-- PARTE 3 – JavaScript, Manifest e Service Worker -->

  <!-- ======= SCRIPTS UNIFICADOS ======= -->
  <script>
  // ===== utils.js =====
  function formatCurrency(v){return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v||0)}
  function formatDate(d){return new Intl.DateTimeFormat('pt-BR').format(new Date(d))}
  function formatDateTime(d){return new Intl.DateTimeFormat('pt-BR',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'}).format(new Date(d))}
  function formatPhone(v){return v.replace(/\D/g,'').replace(/^(\d{2})(\d)/,'($1) $2').replace(/(\d)(\d{4})$/,'$1-$2')}
  function formatPlate(v){return v.replace(/[^A-Za-z0-9]/g,'').toUpperCase().replace(/^([A-Z]{3})(\d)/,'$1-$2')}
  function debounce(f,w){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>f(...a),w)}}
  function generateId(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}
  function sanitizeHtml(s){const d=document.createElement('div');d.textContent=s||'';return d.innerHTML}
  function validateEmail(e){if(!e)return!0;return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}
  function validatePhone(p){return/^\(\d{2}\) \d{4,5}-\d{4}$/.test(p)}
  function showNotification(m,t='info',d=4000){const n=document.getElementById('notification');if(!n)return;n.textContent=m;n.className=`toast ${t} show`;setTimeout(()=>n.classList.remove('show'),d)}
  function confirmAction(m){return Promise.resolve(window.confirm(m))}
  function openModal(id){const tpl=document.getElementById(id);if(!tpl)return;const c=tpl.content.cloneNode(!0);document.body.appendChild(c);const b=document.querySelector('.modal-backdrop:last-of-type');b.querySelectorAll('.modal-close').forEach(btn=>btn.addEventListener('click',()=>b.remove()));b.addEventListener('click',e=>{if(e.target===b)b.remove()});return b}
  window.Utils={formatCurrency,formatDate,formatDateTime,formatPhone,formatPlate,debounce,generateId,sanitizeHtml,validateEmail,validatePhone,showNotification,confirmAction,openModal};

  // ===== DataManager =====
  const SAMPLE={clientes:[{id:'c1',nome:'João Silva',telefone:'(24) 99999-9999',email:'',carro:'',placa:'',endereco:'',created_at:new Date().toISOString()}],servicos:[],orcamentos:[]};
  const DataManager={load(){const d=localStorage.getItem('gestorProPlus');if(d)STATE.data=JSON.parse(d);else STATE.data=JSON.parse(JSON.stringify(SAMPLE)),this.save()},save(){localStorage.setItem('gestorProPlus',JSON.stringify(STATE.data))},saveCliente(c){c.id=generateId();c.created_at=new Date().toISOString();STATE.data.clientes.push(c);this.save()},saveServico(s){s.id=generateId();s.created_at=new Date().toISOString();STATE.data.servicos.push(s);this.save()},saveOrcamento(o){o.id=generateId();o.created_at=new Date().toISOString();STATE.data.orcamentos.push(o);this.save()}};  

  // ===== UIManager & App =====
  const STATE={currentTab:'dashboard',data:{clientes:[],servicos:[],orcamentos:[]},ui:{}};
  const UIManager={switchTab(t){document.querySelectorAll('.nav-tab,.mobile-nav-item').forEach(e=>e.classList.remove('active'));document.querySelectorAll(`[data-tab="${t}"]`).forEach(e=>e.classList.add('active'));document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));document.getElementById(t).classList.add('active');STATE.currentTab=t;},renderClientes(){const c=document.getElementById('clientesGrid');if(!STATE.data.clientes.length)return c.innerHTML='<p style="color:#888">Nenhum cliente</p>';c.innerHTML=STATE.data.clientes.map(cl=>`<div class="card"><div class="card-header"><h3>${sanitizeHtml(cl.nome)}</h3></div><div class="card-info"><p>${sanitizeHtml(cl.telefone)}</p></div></div>`).join('')},renderServicos(){},renderOrcamentos(){},renderHistorico(){}};
  const App={init(){DataManager.load();UIManager.renderClientes(); /* chamadas das outras render… */}}; document.addEventListener('DOMContentLoaded',App.init);

  // ===== Manifest Inline =====
  const manifestJSON={name:"R.M. CRM Pro+",short_name:"CRM Pro+",start_url:".",display:"standalone",theme_color:"#ef4444",background_color:"#0f172a",icons:[{src:"data:image/png;base64,/* base64 icon_192 */",sizes:"192x192",type:"image/png"}]};
  const mBlob=new Blob([JSON.stringify(manifestJSON)],{type:"application/json"}),mURL=URL.createObjectURL(mBlob);
  document.querySelector('link[rel="manifest"]').href=mURL;

  // ===== Service Worker via Blob =====
  if('serviceWorker' in navigator){
    const swCode=`self.addEventListener('install',e=>e.waitUntil(caches.open('v1').then(c=>c.addAll(['/']))));self.addEventListener('fetch',e=>e.respondWith(fetch(e.request).catch(()=>caches.match(e.request))));`;
    const swBlob=new Blob([swCode],{type:'text/javascript'}),swURL=URL.createObjectURL(swBlob);
    navigator.serviceWorker.register(swURL);
  }
  </script>
</body>
</html>
