<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestor PRO+ ‚Äî R.M. Est√©tica Automotiva</title>
  <style>
    /* RESET & ESTILOS GERAIS */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background: #f4f4f4; color: #333; line-height: 1.5; }
    h1,h2,h3,h4 { margin-bottom: .5rem; }
    .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }
    .btn { padding: .6rem 1.2rem; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: .3s; }
    .btn-primary { background: #667eea; color: #fff; }
    .btn-primary:hover { background: #5567d1; }
    .btn-success { background: #27ae60; color: #fff; }
    .btn-success:hover { background: #229954; }
    .btn-danger { background: #e74c3c; color: #fff; }
    .btn-danger:hover { background: #c0392b; }
    nav { display: flex; flex-wrap: wrap; gap: .5rem; margin-bottom: 1rem; }
    nav button { flex: 1 1 120px; }
    section { display: none; }
    section.active { display: block; }
    .dashboard { display: grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap: 1rem; margin-bottom: 1.5rem; }
    .card { background: #fff; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,.1); }
    .card h4 { font-size: .9rem; color: #667eea; margin-bottom: .3rem; }
    .card .metric { font-size: 1.8rem; font-weight: 700; }
    .form-group { margin-bottom: 1rem; }
    input,select,textarea { width: 100%; padding: .6rem; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; }
    input:focus,select:focus,textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,.2); }
    .table { width: 100%; border-collapse: collapse; margin-top: .5rem; }
    .table th,.table td { padding: .6rem; border-bottom: 1px solid #eee; text-align: left; }
    .table th { background: #fafafa; }
    .list { margin-top: 1rem; }
    .item { background: #fff; padding: .8rem; margin-bottom: .8rem; border-left: 4px solid #667eea; border-radius: 6px; box-shadow: 0 1px 4px rgba(0,0,0,.06); }
    .alert { padding: .8rem; border-radius: 6px; margin: 1rem 0; font-size: .9rem; }
    .alert-info { background: #cce5ff; color: #004085; border: 1px solid #b8daff; }
    .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .alert-danger { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    @media(max-width:768px) {
      .dashboard { grid-template-columns: 1fr; }
      nav button { flex: 1 1 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header style="text-align:center;margin-bottom:1rem">
      <h1 style="background:linear-gradient(135deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent">
        üöó R.M. Est√©tica Automotiva ‚Äî Gestor PRO+
      </h1>
      <p style="color:#666">Sistema Unificado: Dashboard ¬∑ Clientes ¬∑ CRM ¬∑ Despesas ¬∑ Or√ßamentos</p>
    </header>

    <nav>
      <button class="btn btn-primary" onclick="openTab('dashboard')">Dashboard</button>
      <button class="btn btn-primary" onclick="openTab('clientes')">Clientes</button>
      <button class="btn btn-primary" onclick="openTab('crm')">CRM</button>
      <button class="btn btn-primary" onclick="openTab('despesas')">Despesas</button>
      <button class="btn btn-primary" onclick="openTab('orcamentos')">Or√ßamentos</button>
    </nav>

    <!-- DASHBOARD -->
    <section id="dashboard" class="active">
      <h2>üìä Vis√£o Geral</h2>
      <div class="dashboard">
        <div class="card"><h4>Total Clientes</h4><div class="metric" id="dashTotalClientes">0</div></div>
        <div class="card"><h4>Intera√ß√µes</h4><div class="metric" id="dashInteracoes">0</div></div>
        <div class="card"><h4>Follow-ups</h4><div class="metric" id="dashFollowups">0</div></div>
        <div class="card"><h4>Total Despesas M√™s</h4><div class="metric" id="dashDespesas">R$ 0,00</div></div>
        <div class="card"><h4>Or√ßamentos Pendentes</h4><div class="metric" id="dashPendentes">0</div></div>
      </div>
    </section>

    <!-- CLIENTES -->
    <section id="clientes">
      <h2>üë• Gest√£o de Clientes</h2>
      <form id="formCliente">
        <div class="form-group"><label>Nome</label><input id="cliNome" required /></div>
        <div class="form-group"><label>Telefone (WhatsApp)</label><input id="cliFone" placeholder="(XX) XXXXX-XXXX" required /></div>
        <div class="form-group"><label>Ve√≠culo</label><input id="cliCarro" placeholder="Ex.: Honda Civic 2020" required /></div>
        <div class="form-group"><label>Placa</label><input id="cliPlaca" placeholder="ABC-1234" required /></div>
        <button class="btn btn-success" type="submit">Salvar Cliente</button>
      </form>
      <div class="list" id="listaClientes"></div>
    </section>

    <!-- CRM -->
    <section id="crm">
      <h2>üîÑ CRM & Follow-ups</h2>
      <div class="dashboard">
        <div class="card"><h4>Total Intera√ß√µes</h4><div class="metric" id="crmTotalInteracoes">0</div></div>
        <div class="card"><h4>Contatos M√™s</h4><div class="metric" id="crmContatosMes">0</div></div>
        <div class="card"><h4>Follow-ups Agendados</h4><div class="metric" id="crmFollowUps">0</div></div>
      </div>

      <!-- Modelos de Mensagem -->
      <h3>üí¨ Modelos de Mensagem</h3>
      <select id="msgTemplate" class="form-group">
        <option value="">Selecione o template...</option>
        <option value="lembrete">Lembrete Amig√°vel (Inativos)</option>
        <option value="oferta">Oferta Especial (Inativos)</option>
        <option value="manutencao">Manuten√ß√£o (Inativos)</option>
        <option value="geral">Contato Geral</option>
        <option value="promocao">Promo√ß√£o da Semana</option>
        <option value="sazonal">Servi√ßo Sazonal</option>
      </select>

      <!-- Nova Intera√ß√£o -->
      <h3>‚ûï Registrar Intera√ß√£o</h3>
      <form id="formInteracao">
        <div class="form-group">
          <label>Cliente</label>
          <select id="intCliente" required><option value="">--</option></select>
        </div>
        <div class="form-group">
          <label>Tipo</label>
          <select id="intTipo">
            <option value="whatsapp">WhatsApp</option>
            <option value="chamada">Chamada</option>
            <option value="visita">Visita</option>
            <option value="email">E-mail</option>
            <option value="outro">Outro</option>
          </select>
        </div>
        <div class="form-group"><label>Mensagem</label><textarea id="intMensagem" rows="3"></textarea></div>
        <div class="form-group"><label>Agendar Follow-up</label><input type="datetime-local" id="intFollow" /></div>
        <button class="btn btn-success" type="submit">Enviar & Registrar</button>
        <button class="btn btn-primary" type="button" onclick="openWhatsApp()">Abrir WhatsApp</button>
      </form>

      <!-- Hist√≥rico de Intera√ß√µes -->
      <h3 style="margin-top:1rem">üìà Hist√≥rico de Intera√ß√µes</h3>
      <table class="table">
        <thead>
          <tr><th>Data</th><th>Cliente</th><th>Tipo</th><th>Mensagem</th></tr>
        </thead>
        <tbody id="tblInteracoes"></tbody>
      </table>
    </section>

    <!-- DESPESAS -->
    <section id="despesas">
      <h2>üí∞ Controle de Despesas</h2>
      <div class="dashboard">
        <div class="card"><h4>Total M√™s</h4><div class="metric" id="despTotalMes">R$ 0,00</div></div>
        <div class="card"><h4>M√©dia Di√°ria</h4><div class="metric" id="despMediaDiaria">R$ 0,00</div></div>
        <div class="card"><h4>Maior Categoria</h4><div class="metric" id="despMaiorCat">N/A</div></div>
      </div>
      <h3>‚ûï Nova Despesa</h3>
      <form id="formDespesa">
        <div class="form-group"><label>Descri√ß√£o</label><input id="despDesc" required /></div>
        <div class="form-group"><label>Valor (R$)</label><input type="number" step="0.01" id="despValor" required /></div>
        <div class="form-group"><label>Data</label><input type="date" id="despData" required /></div>
        <div class="form-group">
          <label>Categoria</label>
          <select id="despCat" required>
            <option value="">--</option>
            <option value="produtos">Produtos de Limpeza</option>
            <option value="contas">Aluguel/Contas</option>
            <option value="marketing">Marketing</option>
            <option value="equipamentos">Equipamentos</option>
            <option value="salarios">Sal√°rios</option>
            <option value="impostos">Impostos</option>
            <option value="outros">Outros</option>
          </select>
        </div>
        <button class="btn btn-success" type="submit">Registrar Despesa</button>
      </form>
      <div class="list" id="listaDespesas"></div>
    </section>

    <!-- OR√áAMENTOS -->
    <section id="orcamentos">
      <h2>üìù Gerenciamento de Or√ßamentos</h2>
      <div class="dashboard">
        <div class="card"><h4>Pendentes</h4><div class="metric" id="orcPendentes">0</div></div>
        <div class="card"><h4>Aprovados</h4><div class="metric" id="orcAprovados">0</div></div>
        <div class="card"><h4>Finalizados</h4><div class="metric" id="orcFinalizados">0</div></div>
        <div class="card"><h4>Faturamento</h4><div class="metric" id="orcFaturamento">R$ 0,00</div></div>
      </div>
      <h3>‚ûï Criar Or√ßamento</h3>
      <form id="formOrcamento">
        <div class="form-group"><label>Cliente</label><select id="orcCliente" required><option value="">--</option></select></div>
        <div class="form-group">
          <label>Adicionar Servi√ßo</label>
          <div style="display:flex;gap:.5rem">
            <select id="orcServico" style="flex:1"><option value="">--</option></select>
            <button class="btn btn-success" type="button" onclick="addServico()">+</button>
          </div>
        </div>
        <div id="orcServicos" class="list"></div>
        <div class="form-group"><label>Desconto (%)</label><input type="number" id="orcDesconto" value="0" min="0" max="100" onchange="updateTotal()" /></div>
        <div class="form-group">
          <label>Formas de Pagamento</label><br/>
          <label><input type="checkbox" value="dinheiro" id="pagDin" /> Dinheiro</label>
          <label><input type="checkbox" value="pix" id="pagPix" /> PIX</label>
          <label><input type="checkbox" value="cartao" id="pagCartao" /> Cart√£o</label>
        </div>
        <h3 id="orcTotal">TOTAL: R$ 0,00</h3>
        <button class="btn btn-success" type="submit">Salvar Or√ßamento</button>
      </form>
      <h3 style="margin-top:1rem">üìã Hist√≥rico de Or√ßamentos</h3>
      <table class="table">
        <thead>
          <tr><th>Data</th><th>Cliente</th><th>Servi√ßos</th><th>Total</th><th>Status</th></tr>
        </thead>
        <tbody id="tblOrcamentos"></tbody>
      </table>
    </section>
  </div><!-- /.container -->

  <!-- SUPABASE & L√ìGICA -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script>
    // CONFIGURA√á√ÉO SUPABASE
    const SUPABASE_URL = 'https://bezbszbkaifcanqsmdbi.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJlemJzemJrYWlmY2FucXNtZGJpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2MTM5MTksImV4cCI6MjA2ODE4OTkxOX0.zLXAuQz7g5ym3Bd5pkhg5vsnf_3rdJFRAXI_kX8tM18';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // NAVEGA√á√ÉO
    function openTab(id) {
      document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    // UTILIDADES
    function fmtMoney(v) { return 'R$ ' + v.toFixed(2).replace('.', ','); }
    function hojeISO() { return new Date().toISOString().split('T')[0]; }
    document.getElementById('despData').value = hojeISO();

    // INICIALIZA√á√ÉO
    window.onload = async () => {
      await init();
      await loadServicosList();
      document.getElementById('msgTemplate').addEventListener('change', applyTemplate);
      document.getElementById('orcDesconto').addEventListener('input', updateTotal);
    };

    async function init() {
      await loadClientes();
      await loadInteracoes(); loadCRMCounts();
      await loadDespesas(); loadDespesasDashboard();
      await loadOrcamentos(); loadOrcamentosDashboard();
      loadDashboard();
    }

    async function loadDashboard() {
      dashTotalClientes.textContent = document.querySelectorAll('#listaClientes .item').length;
      dashInteracoes.textContent = document.querySelectorAll('#tblInteracoes tr').length;
      dashFollowups.textContent = crmFollowUps.textContent;
      dashDespesas.textContent = despTotalMes.textContent;
      dashPendentes.textContent = orcPendentes.textContent;
    }

    /* CLIENTES */
    formCliente.addEventListener('submit', async e => {
      e.preventDefault();
      await supabase.from('clientes').insert({
        nome: cliNome.value.trim(),
        telefone: cliFone.value.trim(),
        veiculo: cliCarro.value.trim(),
        placa: cliPlaca.value.trim().toUpperCase(),
        criado_em: new Date().toISOString()
      });
      formCliente.reset();
      loadClientes();
    });
    async function loadClientes() {
      let { data } = await supabase.from('clientes').select().order('criado_em', { ascending: false });
      listaClientes.innerHTML = '';
      intCliente.innerHTML = '<option value="">--</option>';
      orcCliente.innerHTML = '<option value="">--</option>';
      data.forEach(c => {
        let div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `<strong>${c.nome}</strong> ‚Äî ${c.veiculo}<br>üì± ${c.telefone} ‚Ä¢ üè∑Ô∏è ${c.placa}`;
        listaClientes.appendChild(div);
        intCliente.append(new Option(`${c.nome} - ${c.veiculo}`, c.id));
        orcCliente.append(new Option(`${c.nome} - ${c.veiculo}`, c.id));
      });
    }

    /* CRM */
    formInteracao.addEventListener('submit', async e => {
      e.preventDefault();
      await supabase.from('interacoes').insert({
        cliente_id: intCliente.value,
        tipo: intTipo.value,
        notas: intMensagem.value.trim(),
        data: new Date().toISOString(),
        followup: intFollow.value || null
      });
      formInteracao.reset();
      loadInteracoes(); loadCRMCounts(); loadDashboard();
    });
    async function loadInteracoes() {
      let { data } = await supabase.from('interacoes')
        .select('*,clientes(id,nome)')
        .order('data', { ascending: false });
      tblInteracoes.innerHTML = '';
      data.forEach(i => {
        let tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${new Date(i.data).toLocaleDateString('pt-BR')}</td>
          <td>${i.clientes?.nome || ''}</td>
          <td>${i.tipo}</td>
          <td>${i.notas || ''}</td>`;
        tblInteracoes.appendChild(tr);
      });
    }
    async function loadCRMCounts() {
      let { count: tot } = await supabase.from('interacoes').select('*', { count: 'exact', head: true });
      let inicio = new Date(); inicio.setDate(1);
      let { count: mes } = await supabase.from('interacoes')
        .select('*', { count: 'exact', head: true })
        .gte('data', inicio.toISOString());
      let { count: fus } = await supabase.from('interacoes')
        .select('*', { count: 'exact', head: true })
        .gte('followup', new Date().toISOString());
      crmTotalInteracoes.textContent = tot || 0;
      crmContatosMes.textContent = mes || 0;
      crmFollowUps.textContent = fus || 0;
    }
    function openWhatsApp() {
      if (!intCliente.value || !intMensagem.value) return;
      let clienteNome = intCliente.options[intCliente.selectedIndex].text.split(' - ')[0];
      let tel = clienteNome.match(/\((\d{2})\)/) ? cliFone.value.replace(/\D/g, '') : '';
      window.open(`https://wa.me/55${tel}?text=${encodeURIComponent(intMensagem.value)}`, '_blank');
    }

    /* Templates de Mensagem */
    function applyTemplate() {
      let tpl = msgTemplate.value;
      let nome = intCliente.options[intCliente.selectedIndex]?.text.split(' - ')[0] || '[NOME DO CLIENTE]';
      let tempo = '[TEMPO]';
      let texts = {
        lembrete: `Ol√°, ${nome}! Tudo bem? Aqui √© da R.M. Est√©tica Automotiva. Notamos que j√° faz mais de ${tempo} desde sua √∫ltima visita. S√≥ quer√≠amos saber se est√° tudo certo com o seu carro e nos colocar √† disposi√ß√£o! Precisando de algo, √© s√≥ chamar. üëç`,
        oferta: `Ol√°, ${nome}! Da R.M. Est√©tica Automotiva. Como j√° se passaram mais de ${tempo} da sua √∫ltima visita, estamos com uma condi√ß√£o especial para voc√™: 10% de desconto na cristaliza√ß√£o dos vidros. Que tal dar um trato no carro? Aguardamos seu contato! ‚ú®`,
        manutencao:`Ol√° ${nome}, tudo joia? Aqui da R.M. Est√©tica Automotiva. Passando para lembrar que, como j√° faz mais de ${tempo} desde o √∫ltimo servi√ßo, a manuten√ß√£o da est√©tica do seu carro √© importante para manter o valor e a beleza dele. Quando pretende fazer a pr√≥xima? Estamos √† disposi√ß√£o! üöó`,
        geral: `Ol√°, ${nome}! Tudo bem? Da R.M. Est√©tica Automotiva. Estamos passando para lembrar que estamos √† disposi√ß√£o para cuidar da est√©tica do seu carro. Qualquer d√∫vida ou para agendar um servi√ßo, √© s√≥ chamar! üöó‚ú®`,
        promocao: `Ol√°, ${nome}! üì¢ PROMO√á√ÉO DA SEMANA na R.M. Est√©tica Automotiva! Lavagem detalhada + cera protetora por um pre√ßo imperd√≠vel. Deixe seu carro a brilhar! Vagas limitadas. Responda para agendar! ü§©`,
        sazonal: `Ol√°, ${nome}! A chuva chegou e com ela a dificuldade de dirigir? A cristaliza√ß√£o de vidros repele a √°gua e aumenta muito a sua seguran√ßa. Garanta sua visibilidade na estrada. Fale connosco e agende seu hor√°rio! üåßÔ∏è‚û°Ô∏è‚òÄÔ∏è`
      };
      intMensagem.value = texts[tpl] || '';
    }

    /* DESPESAS */
    formDespesa.addEventListener('submit', async e => {
      e.preventDefault();
      await supabase.from('despesas').insert({
        descricao: despDesc.value.trim(),
        valor: parseFloat(despValor.value),
        data: despData.value,
        categoria: despCat.value
      });
      formDespesa.reset();
      despData.value = hojeISO();
      loadDespesas(); loadDespesasDashboard(); loadDashboard();
    });
    async function loadDespesas() {
      let { data } = await supabase.from('despesas').select().order('data', { ascending: false });
      listaDespesas.innerHTML = '';
      const catMap = {
        produtos: 'Produtos de Limpeza',
        contas: 'Aluguel/Contas',
        marketing: 'Marketing',
        equipamentos: 'Equipamentos',
        salarios: 'Sal√°rios',
        impostos: 'Impostos',
        outros: 'Outros'
      };
      data.forEach(d => {
        let div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `<strong>${d.descricao}</strong> ‚Äî ${fmtMoney(d.valor)}<br>üè∑Ô∏è ${catMap[d.categoria]} ‚Ä¢ ${new Date(d.data).toLocaleDateString('pt-BR')}`;
        listaDespesas.appendChild(div);
      });
    }
    async function loadDespesasDashboard() {
      let hoje = new Date(), inicio = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
      let { data } = await supabase.from('despesas')
        .select()
        .gte('data', inicio.toISOString().split('T')[0]);
      let total = 0, catAgg = {};
      data.forEach(d => {
        total += d.valor;
        catAgg[d.categoria] = (catAgg[d.categoria] || 0) + d.valor;
      });
      despTotalMes.textContent = fmtMoney(total);
      despMediaDiaria.textContent = fmtMoney(total / hoje.getDate());
      let maior = Object.entries(catAgg).sort((a,b)=>b[1]-a[1])[0];
      despMaiorCat.textContent = maior ? maior[0].toUpperCase() : 'N/A';
    }

    /* OR√áAMENTOS */
    let servicosTemp = [];
    async function loadOrcamentos() {
      let { data } = await supabase.from('orcamentos')
        .select('*,clientes(id,nome)')
        .order('data_criacao', { ascending: false });
      tblOrcamentos.innerHTML = '';
      data.forEach(o => {
        let tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${new Date(o.data_criacao).toLocaleDateString('pt-BR')}</td>
          <td>${o.clientes?.nome || ''}</td>
          <td>${o.servicos.length} serv.</td>
          <td>${fmtMoney(o.total)}</td>
          <td>${o.status.toUpperCase()}</td>`;
        tblOrcamentos.appendChild(tr);
      });
    }
    async function loadOrcamentosDashboard() {
      let { data } = await supabase.from('orcamentos').select();
      let pend = data.filter(o => o.status === 'orcamento').length;
      let apr = data.filter(o => o.status === 'aprovado').length;
      let fin = data.filter(o => o.status === 'finalizado').length;
      let fat = data.filter(o => o.status === 'finalizado').reduce((s,o)=>s+o.total,0);
      orcPendentes.textContent = pend;
      orcAprovados.textContent = apr;
      orcFinalizados.textContent = fin;
      orcFaturamento.textContent = fmtMoney(fat);
    }
    document.getElementById('formOrcamento').addEventListener('submit', async e => {
      e.preventDefault();
      let desconto = parseFloat(orcDesconto.value) || 0;
      let subtotal = servicosTemp.reduce((sum,s)=>sum + s.valor, 0);
      let valorDesc = subtotal * (desconto / 100);
      let total = subtotal - valorDesc;
      let pagamentos = [];
      if (pagDin.checked) pagamentos.push('Dinheiro');
      if (pagPix.checked) pagamentos.push('PIX');
      if (pagCartao.checked) pagamentos.push('Cart√£o');
      await supabase.from('orcamentos').insert({
        cliente_id: orcCliente.value,
        servicos: servicosTemp,
        subtotal,
        desconto,
        total,
        pagamentos,
        status: 'orcamento',
        data_criacao: new Date().toISOString()
      });
      servicosTemp = [];
      orcServicos.innerHTML = '';
      updateTotal();
      loadOrcamentos(); loadOrcamentosDashboard(); loadDashboard();
    });
    async function addServico() {
      let srv = JSON.parse(orcServico.value || 'null');
      if (!srv || servicosTemp.find(s => s.id === srv.id)) return;
      servicosTemp.push(srv);
      let div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `${srv.descricao} ‚Äî ${fmtMoney(srv.valor)}
        <button class="btn btn-danger btn-sm" onclick="removeSrv(${srv.id})">√ó</button>`;
      orcServicos.appendChild(div);
      updateTotal();
    }
    function removeSrv(id) {
      servicosTemp = servicosTemp.filter(s => s.id !== id);
      orcServicos.innerHTML = '';
      servicosTemp.forEach(s => {
        let div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `${s.descricao} ‚Äî ${fmtMoney(s.valor)}
          <button class="btn btn-danger btn-sm" onclick="removeSrv(${s.id})">√ó</button>`;
        orcServicos.appendChild(div);
      });
      updateTotal();
    }
    function updateTotal() {
      let desconto = parseFloat(orcDesconto.value) || 0;
      let subtotal = servicosTemp.reduce((sum,s)=>sum + s.valor, 0);
      let total = subtotal - subtotal * (desconto / 100);
      orcTotal.textContent = 'TOTAL: ' + fmtMoney(total);
    }
    async function loadServicosList() {
      let { data } = await supabase.from('servicos').select().order('data_criacao', { ascending: true });
      orcServico.innerHTML = '<option value="">--</option>';
      data.forEach(s => {
        orcServico.append(new Option(`${s.descricao} ‚Äî ${fmtMoney(s.valor)}`, JSON.stringify(s)));
      });
    }
  </script>
</body>
</html>
