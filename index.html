<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R.M. Est√©tica Automotiva - Gestor PRO+</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <!-- Scripts de Bibliotecas -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.autotable.min.js"></script>

    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --bg-modal: #131c31;
            --text-light: #e2e8f0;
            --text-muted: #94a3b8;
            --primary-red: #ef4444;
            --primary-red-dark: #dc2626;
            --accent-green: #22c55e;
            --accent-green-dark: #16a34a;
            --accent-blue: #3b82f6;
            --accent-blue-dark: #2563eb;
            --accent-orange: #f97316;
            --accent-orange-dark: #ea580c;
            --accent-red-status: #ef4444;
            --border-color: #475569;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --header-border: #64748b;
            --skeleton-base: #334155;
            --skeleton-highlight: #475569;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
            line-height: 1.6;
            font-size: 16px;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }
        h1, h2, h3, h4, h5, h6 { font-family: 'Poppins', sans-serif; color: var(--text-light); }

        .app-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px; border-bottom: 2px solid var(--header-border);
            padding-bottom: 20px; flex-wrap: wrap; gap: 15px;
        }
        header h1 { 
            color: var(--primary-red); font-size: 2rem; font-weight: 700; 
            display: flex; align-items: center; gap: 10px;
        }
        header h1 i { color: var(--accent-blue); }

        .sync-btn {
            background: none; border: none; color: var(--text-muted); cursor: pointer;
            font-size: 2.2rem; transition: color 0.3s, transform 0.3s; padding: 5px;
        }
        .sync-btn:hover { color: var(--primary-red); transform: rotate(15deg); }
        .sync-btn.syncing { animation: spin 1.2s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite; color: var(--accent-blue); }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        nav { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 30px; }
        .nav-btn {
            padding: 12px 20px; background-color: var(--bg-card); color: var(--text-muted);
            border: 1px solid var(--border-color); border-radius: 10px; cursor: pointer;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
            font-size: 1rem; font-weight: 500; text-align: center;
            flex-grow: 1; display: flex; align-items: center; justify-content: center;
            gap: 8px; box-shadow: 0 2px 5px var(--shadow-color);
        }
        @media (min-width: 600px) { .nav-btn { flex-grow: 0; } }
        .nav-btn:hover { background-color: var(--bg-input); color: var(--text-light); border-color: var(--primary-red); }
        .nav-btn.active { 
            background-color: var(--primary-red); color: white; font-weight: bold; 
            border-color: var(--primary-red); box-shadow: 0 4px 10px rgba(239, 68, 68, 0.4);
        }

        .tab-content { display: none; animation: fadeInScale 0.6s ease-out; transform-origin: top; }
        .tab-content.active { display: block; }
        @keyframes fadeInScale { 
            from { opacity: 0; transform: translateY(20px) scale(0.98); } 
            to { opacity: 1; transform: translateY(0) scale(1); } 
        }

        .grid-layout, .historico-layout, .dashboard-main-grid { display: grid; grid-template-columns: 1fr; gap: 25px; }
        @media (min-width: 768px) { 
            .grid-layout { grid-template-columns: 1fr 1.5fr; } 
            .dashboard-main-grid { grid-template-columns: 1.8fr 1fr; } 
        }
        @media (min-width: 992px) { .historico-layout { grid-template-columns: 1fr 1.5fr; } }

        .card { 
            background-color: var(--bg-card); padding: 30px; border-radius: 15px; 
            border: 1px solid var(--border-color); box-shadow: 0 8px 25px var(--shadow-color);
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        .card:hover { transform: translateY(-3px); box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4); }
        .card h2 {
            margin-top: 0; margin-bottom: 25px; color: var(--primary-red);
            border-bottom: 2px solid var(--primary-red); padding-bottom: 12px; 
            font-size: 1.7rem; font-weight: 600; display: flex; align-items: center; gap: 10px;
        }

        .form-group { margin-bottom: 20px; position: relative; }
        .form-group label { 
            display: block; margin-bottom: 8px; color: var(--text-muted); 
            font-size: 0.95rem; font-weight: 500;
        }
        
        .search-container { position: relative; margin-bottom: 25px; }
        .search-container input { padding-left: 45px; }
        .search-container i.fa-search { 
            position: absolute; left: 15px; top: 50%; transform: translateY(-50%); 
            color: var(--text-muted); font-size: 1.1rem;
        }

        input, select, textarea {
            width: 100%; padding: 15px; background-color: var(--bg-input);
            border: 1.5px solid var(--border-color); border-radius: 10px;
            color: var(--text-light); font-size: 1.05rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        input:focus, select:focus, textarea:focus {
            outline: none; border-color: var(--accent-blue);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.25);
        }

        input[type="date"], input[type="month"] { color-scheme: dark; }
        textarea { resize: vertical; }

        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 8px; 
            padding: 14px 25px; border: none; border-radius: 10px; cursor: pointer; 
            font-weight: 600; text-transform: uppercase; font-size: 0.95rem; 
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.3s ease;
            width: 100%; text-align: center; margin-top: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }
        @media(min-width: 992px) { .btn { width: auto; } }
        
        .btn:active { transform: translateY(1px); box-shadow: 0 1px 4px rgba(0,0,0,0.2); }
        .btn-primary { background-color: var(--primary-red); color: white; }
        .btn-primary:hover { background-color: var(--primary-red-dark); box-shadow: 0 5px 12px rgba(239, 68, 68, 0.4); }
        .btn-secondary { background-color: #475569; color: var(--text-light); }
        .btn-secondary:hover { background-color: #64748b; }
        .btn-danger { background-color: var(--accent-red-status); color: white; }
        .btn-success { background-color: var(--accent-green); color: white; }
        .btn-success:hover { background-color: var(--accent-green-dark); }
        .btn-sm { padding: 10px 18px; font-size: 0.85rem; width: auto; }

        .data-list ul { list-style: none; padding: 0; max-height: 550px; overflow-y: auto; margin-top: 10px; }
        .data-list ul::-webkit-scrollbar { width: 8px; }
        .data-list ul::-webkit-scrollbar-track { background: var(--bg-input); border-radius: 10px; }
        .data-list ul::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }
        .data-list ul::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

        .empty-list-message {
            text-align: center; padding: 50px 20px; color: var(--text-muted);
            background-color: var(--bg-input); border-radius: 10px;
            border: 2px dashed var(--border-color); margin-top: 15px;
        }
        .empty-list-message p { font-size: 1.2rem; margin-bottom: 15px; font-weight: 500; }
        .empty-list-message small { font-size: 0.9rem; color: var(--text-muted); }
        
        .data-list li {
            display: flex; justify-content: space-between; align-items: center; 
            padding: 18px; background-color: var(--bg-input); border-radius: 10px; 
            margin-bottom: 12px; flex-wrap: wrap; gap: 15px;
            border-left: 5px solid var(--border-color);
            transition: border-left-color 0.3s ease, background-color 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .data-list li:hover { border-left-color: var(--primary-red); background-color: #2b3a4e; }
        .data-list li > div:first-child { flex-grow: 1; }
        .data-list li strong { font-size: 1.1rem; color: var(--text-light); }
        .data-list li small { color: var(--text-muted); font-size: 0.85rem; }
        .item-actions { display: flex; gap: 10px; flex-shrink: 0; align-items: center; }

        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; }
        .stat-card { 
            background-color: var(--bg-card); padding: 25px; border-radius: 12px; 
            border: 1px solid var(--border-color); box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease; cursor: pointer; text-align: center; 
        }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.3); }
        .stat-card .icon { font-size: 3rem; margin-bottom: 15px; color: var(--accent-blue); }
        .stat-card h3 { 
            font-size: 0.9rem; color: var(--text-muted); margin-bottom: 8px; 
            text-transform: uppercase; font-weight: 600; letter-spacing: 0.8px;
        }
        .stat-card p { font-size: 2.2rem; font-weight: bold; color: var(--primary-red); line-height: 1; }

        .metrics-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 25px; }
        .metric-card {
            background-color: var(--bg-input); padding: 20px; border-radius: 10px;
            text-align: center; border-left: 5px solid var(--accent-blue);
        }
        .metric-card h3 {
            font-size: 0.9rem; color: var(--text-muted); margin-bottom: 10px;
            text-transform: uppercase;
        }
        .metric-card p {
            font-size: 2rem; font-weight: 700; color: var(--text-light); line-height: 1;
        }

        .main-layout { display: grid; grid-template-columns: 1fr; gap: 25px; }
        .chart-container { padding: 20px; background-color: var(--bg-card); border-radius: 15px; margin-top: 25px; }

        @media (min-width: 768px) {
            header h1 { font-size: 2rem; }
            .nav-btn { font-size: 1rem; flex-grow: 0; }
            .card { padding: 30px; }
            .card h2 { font-size: 1.7rem; }
            .btn { font-size: 0.95rem; }
            .metrics-grid { grid-template-columns: repeat(3, 1fr); }
        }
        
        @media (min-width: 1024px) {
            .main-layout { grid-template-columns: 1fr 2fr; }
        }

        .status-indicator { 
            padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; 
            color: white; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .status-Or√ßamento { background-color: var(--accent-blue); }
        .status-Aprovado { background-color: var(--accent-orange); }
        .status-Finalizado { background-color: var(--accent-green); }
        .status-Cancelado { background-color: var(--accent-red-status); }

        .payment-options-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; }
        .payment-option {
            padding: 14px 15px; background-color: var(--bg-input); 
            border: 1px solid var(--border-color); border-radius: 10px; cursor: pointer; 
            transition: all 0.2s ease; font-size: 0.95rem; color: var(--text-muted); 
            text-align: center; font-weight: 500; box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }
        .payment-option:hover { background-color: var(--border-color); color: var(--text-light); }
        .payment-option.active {
            background-color: var(--accent-blue); color: white; border-color: var(--accent-blue); 
            font-weight: bold; box-shadow: 0 3px 8px rgba(59, 130, 246, 0.3);
        }

        #notification {
            position: fixed; bottom: 25px; left: 50%; transform: translate(-50%, 150%); 
            padding: 18px 25px; border-radius: 10px; color: white; z-index: 1000;
            text-align: center; visibility: hidden; 
            transition: transform 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55), visibility 0.6s;
            max-width: 90%; box-shadow: 0 6px 20px rgba(0,0,0,0.4);
            font-weight: 500; min-width: 280px;
        }
        #notification.show { transform: translate(-50%, 0); visibility: visible; }
        #notification.success { background-color: var(--accent-green); }
        #notification.error { background-color: var(--accent-red-status); }
        #notification.warning { background-color: var(--accent-orange); }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.85); display: none; justify-content: center;
            align-items: center; z-index: 2000; padding: 20px;
            backdrop-filter: blur(5px); animation: fadeIn 0.3s ease-out;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background-color: var(--bg-card); padding: 35px; border-radius: 15px;
            text-align: center; max-width: 450px; width: 100%;
            border: 1px solid var(--border-color); box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            animation: slideInUp 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        @keyframes slideInUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .modal-content h3 { margin-bottom: 20px; color: var(--primary-red); font-size: 1.8rem; font-weight: 600; }
        .modal-content p { margin-bottom: 30px; color: var(--text-light); font-size: 1.1rem; }
        .modal-actions { display: flex; justify-content: center; gap: 20px; }

        .crm-grid { display: grid; grid-template-columns: 1fr; gap: 25px; }
        @media (min-width: 1024px) { .crm-grid { grid-template-columns: 1fr 1fr; } }
        @media (min-width: 1280px) { .crm-grid { grid-template-columns: 4fr 5fr 4fr; } }

        .filter-options { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; }
        .filter-options .btn { margin-top: 0; flex-grow: 1; padding: 10px; font-size: 0.8rem; }

        #dispatch-view-modal .modal-content {
            background-color: var(--bg-modal); width: 100%; max-width: 1200px;
            height: 95vh; padding: 0; display: flex; flex-direction: column;
            animation: fadeInScale 0.5s;
        }
        .dispatch-header { padding: 15px 20px; }
        .dispatch-body {
            display: flex; flex-direction: column; gap: 15px; padding: 15px;
            flex-grow: 1; overflow: hidden;
        }
        .dispatch-client-list-container { height: 40%; }
        .dispatch-composer { height: 60%; }
        .dispatch-client-list-container, .dispatch-composer {
            background-color: var(--bg-card); border-radius: 10px; padding: 15px;
            display: flex; flex-direction: column; overflow: hidden;
        }
        #dispatch-client-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
        #dispatch-client-list li {
            padding: 12px 15px; border-radius: 8px; cursor: pointer;
            transition: background-color 0.3s, opacity 0.3s; margin-bottom: 8px;
        }
        #dispatch-client-list li.active { background-color: var(--accent-blue); color: white; }
        #dispatch-client-list li.contacted { 
            background-color: var(--border-color); color: var(--text-muted); 
            cursor: not-allowed; opacity: 0.6; 
        }
        #composer-placeholder { text-align: center; margin: auto; color: var(--text-muted); }
        #composer-content.hidden, #composer-placeholder.hidden { display: none; }
        .composer-actions { 
            display: flex; gap: 15px; margin-top: auto; padding-top: 20px; 
            border-top: 1px solid var(--border-color); 
        }

        @media (min-width: 768px) {
            .dispatch-body { flex-direction: row; }
            .dispatch-client-list-container, .dispatch-composer { height: auto; }
        }
    </style>
</head>
<body>

    <div id="offline-indicator" role="alert" aria-live="assertive">Voc√™ est√° offline. Conecte-se para sincronizar os dados.</div>

    <div class="app-container">
        <header>
            <h1><i class="fas fa-car-wash" aria-hidden="true"></i> R.M. Est√©tica PRO+</h1>
            <button class="sync-btn" id="sync-btn" title="Sincronizar Dados Manualmente" aria-label="Sincronizar Dados Manualmente"><i class="fas fa-sync-alt" aria-hidden="true"></i></button>
        </header>

        <nav role="navigation" aria-label="Navega√ß√£o Principal">
            <button class="nav-btn active" data-tab="dashboard" role="tab" aria-selected="true" aria-controls="dashboard-tab"><i class="fas fa-chart-line" aria-hidden="true"></i> Painel</button>
            <button class="nav-btn" data-tab="clientes" role="tab" aria-selected="false" aria-controls="clientes-tab"><i class="fas fa-users" aria-hidden="true"></i> Clientes</button>
            <button class="nav-btn" data-tab="servicos" role="tab" aria-selected="false" aria-controls="servicos-tab"><i class="fas fa-tools" aria-hidden="true"></i> Servi√ßos</button>
            <button class="nav-btn" data-tab="novo-orcamento" role="tab" aria-selected="false" aria-controls="novo-orcamento-tab"><i class="fas fa-file-invoice" aria-hidden="true"></i> Or√ßamento</button>
            <button class="nav-btn" data-tab="historico" role="tab" aria-selected="false" aria-controls="historico-tab"><i class="fas fa-history" aria-hidden="true"></i> Hist√≥rico</button>
            <button class="nav-btn" data-tab="crm" role="tab" aria-selected="false" aria-controls="crm-tab"><i class="fas fa-headset" aria-hidden="true"></i> CRM</button>
            <button class="nav-btn" data-tab="despesas" role="tab" aria-selected="false" aria-controls="despesas-tab"><i class="fas fa-wallet" aria-hidden="true"></i> Despesas</button>
        </nav>

        <main>
            <!-- Dashboard -->
            <section id="dashboard-tab" class="tab-content active" role="tabpanel">
                <div class="dashboard-main-grid">
                    <div class="stat-card" data-target-tab="clientes" data-filter-type="none" tabindex="0" role="button" aria-label="Ver todos os clientes">
                        <div class="icon"><i class="fas fa-users" aria-hidden="true"></i></div>
                        <h3>Clientes</h3>
                        <p id="stat-clientes">0</p>
                    </div>
                    <div class="stat-card" data-target-tab="historico" data-filter-type="status" data-filter-value="Or√ßamento" tabindex="0" role="button" aria-label="Ver or√ßamentos pendentes">
                        <div class="icon"><i class="fas fa-hourglass-half" aria-hidden="true"></i></div>
                        <h3>Pendentes</h3>
                        <p id="stat-pendentes">0</p>
                    </div>
                    <div class="stat-card" data-target-tab="historico" data-filter-type="status" data-filter-value="Aprovado" tabindex="0" role="button" aria-label="Ver or√ßamentos aprovados">
                        <div class="icon"><i class="fas fa-check-circle" aria-hidden="true"></i></div>
                        <h3>Aprovados</h3>
                        <p id="stat-aprovados">0</p>
                    </div>
                    <div class="stat-card" data-target-tab="historico" data-filter-type="status" data-filter-value="Finalizado" tabindex="0" role="button" aria-label="Ver or√ßamentos finalizados este m√™s">
                        <div class="icon"><i class="fas fa-calendar-check" aria-hidden="true"></i></div>
                        <h3>Finalizados M√™s</h3>
                        <p id="stat-finalizados-mes">0</p>
                    </div>
                    <div class="stat-card" data-target-tab="historico" data-filter-type="status" data-filter-value="Finalizado" style="grid-column: span 2;" tabindex="0" role="button" aria-label="Ver faturamento total">
                        <div class="icon"><i class="fas fa-dollar-sign" aria-hidden="true"></i></div>
                        <h3>Faturamento Total</h3>
                        <p id="stat-faturamento-total">R$ 0,00</p>
                    </div>
                </div>
                <div class="card data-list" style="margin-top: 25px;">
                    <h2>Atividade Recente <i class="fas fa-bolt" aria-hidden="true"></i></h2>
                    <ul id="recent-activity-list" role="list"></ul>
                </div>
            </section>

            <!-- Clientes -->
            <section id="clientes-tab" class="tab-content" role="tabpanel">
                <div class="grid-layout">
                    <div class="card">
                        <h2 id="cliente-form-title">Novo Cliente <i class="fas fa-user-plus" aria-hidden="true"></i></h2>
                        <form id="cliente-form">
                            <input type="hidden" id="cliente-id">
                            <div class="form-group">
                                <label for="cliente-nome">Nome Completo</label>
                                <input type="text" id="cliente-nome" required aria-required="true" placeholder="Nome do cliente">
                            </div>
                            <div class="form-group">
                                <label for="cliente-telefone">Telefone (WhatsApp)</label>
                                <input type="tel" id="cliente-telefone" required aria-required="true" placeholder="(11) 99999-9999">
                            </div>
                            <div class="form-group">
                                <label for="cliente-veiculo">Ve√≠culo</label>
                                <input type="text" id="cliente-veiculo" placeholder="Marca/Modelo">
                            </div>
                            <div class="form-group">
                                <label for="cliente-placa">Placa</label>
                                <input type="text" id="cliente-placa" placeholder="ABC-1234">
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save" aria-hidden="true"></i> Salvar Cliente
                            </button>
                        </form>
                    </div>
                    <div class="card data-list">
                        <h2>Clientes Cadastrados <i class="fas fa-users" aria-hidden="true"></i></h2>
                        <div class="search-container">
                            <i class="fas fa-search" aria-hidden="true"></i>
                            <input type="search" id="search-clientes" placeholder="Buscar cliente..." aria-label="Pesquisar Clientes">
                        </div>
                        <ul id="clientes-lista" role="list"></ul>
                    </div>
                </div>
            </section>

            <!-- Servi√ßos -->
            <section id="servicos-tab" class="tab-content" role="tabpanel">
                <div class="grid-layout">
                    <div class="card">
                        <h2 id="servico-form-title">Novo Servi√ßo <i class="fas fa-plus-circle" aria-hidden="true"></i></h2>
                        <form id="servico-form">
                            <input type="hidden" id="servico-id">
                            <div class="form-group">
                                <label for="servico-descricao">Descri√ß√£o</label>
                                <input type="text" id="servico-descricao" required aria-required="true" placeholder="Descri√ß√£o do servi√ßo">
                            </div>
                            <div class="form-group">
                                <label for="servico-valor">Valor (R$)</label>
                                <input type="number" id="servico-valor" step="0.01" min="0" required aria-required="true" placeholder="0,00">
                            </div>
                            <div class="form-group">
                                <label for="servico-dias-retorno">Dias de Retorno (opcional)</label>
                                <input type="number" id="servico-dias-retorno" min="1" placeholder="Ex: 30">
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save" aria-hidden="true"></i> Salvar Servi√ßo
                            </button>
                        </form>
                    </div>
                    <div class="card data-list">
                        <h2>Servi√ßos Cadastrados <i class="fas fa-tools" aria-hidden="true"></i></h2>
                        <div class="search-container">
                            <i class="fas fa-search" aria-hidden="true"></i>
                            <input type="search" id="search-servicos" placeholder="Buscar servi√ßo..." aria-label="Pesquisar Servi√ßos">
                        </div>
                        <ul id="servicos-lista" role="list"></ul>
                    </div>
                </div>
            </section>

            <!-- Or√ßamento -->
            <section id="novo-orcamento-tab" class="tab-content" role="tabpanel">
                <div class="grid-layout">
                    <div class="card">
                        <h2>Criar Novo Or√ßamento <i class="fas fa-file-invoice" aria-hidden="true"></i></h2>
                        <form id="orcamento-form">
                            <div class="form-group">
                                <label for="orcamento-cliente">Cliente</label>
                                <select id="orcamento-cliente" required aria-required="true">
                                    <option value="">Selecione um cliente...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="orcamento-servico">Adicionar Servi√ßo</label>
                                <div style="display: flex; gap: 10px;">
                                    <select id="orcamento-servico" style="flex: 1;">
                                        <option value="">Selecione um servi√ßo...</option>
                                    </select>
                                    <button type="button" id="add-servico-btn" class="btn btn-sm btn-secondary">
                                        <i class="fas fa-plus" aria-hidden="true"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="form-group">
                                <h3>Servi√ßos Adicionados</h3>
                                <ul id="orcamento-servicos-lista" style="margin-top: 10px;"></ul>
                            </div>
                            <div class="form-group">
                                <label for="orcamento-desconto">Desconto (%)</label>
                                <input type="number" id="orcamento-desconto" min="0" max="100" step="0.01" value="0" placeholder="0">
                            </div>
                            <div class="form-group">
                                <label>Formas de Pagamento</label>
                                <div class="payment-options-group">
                                    <div class="payment-option" data-payment="PIX">PIX</div>
                                    <div class="payment-option" data-payment="Dinheiro">Dinheiro</div>
                                    <div class="payment-option" data-payment="Cart√£o">Cart√£o</div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="orcamento-observacoes">Observa√ß√µes</label>
                                <textarea id="orcamento-observacoes" rows="3" placeholder="Observa√ß√µes adicionais..."></textarea>
                            </div>
                            <div id="orcamento-total">TOTAL: R$ 0,00</div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save" aria-hidden="true"></i> Criar Or√ßamento
                            </button>
                        </form>
                    </div>
                </div>
            </section>

            <!-- Hist√≥rico -->
            <section id="historico-tab" class="tab-content" role="tabpanel">
                <div class="historico-layout">
                    <div class="card data-list">
                        <h2>Hist√≥rico de Servi√ßos <i class="fas fa-history" aria-hidden="true"></i></h2>
                        <div class="filter-options">
                            <select id="filter-status">
                                <option value="">Todos os Status</option>
                                <option value="Or√ßamento">Or√ßamento</option>
                                <option value="Aprovado">Aprovado</option>
                                <option value="Finalizado">Finalizado</option>
                                <option value="Cancelado">Cancelado</option>
                            </select>
                            <input type="date" id="filter-date-from" placeholder="Data in√≠cio">
                            <input type="date" id="filter-date-to" placeholder="Data fim">
                        </div>
                        <div class="search-container">
                            <i class="fas fa-search" aria-hidden="true"></i>
                            <input type="search" id="search-historico" placeholder="Buscar no hist√≥rico..." aria-label="Pesquisar Hist√≥rico">
                        </div>
                        <ul id="historico-lista" role="list"></ul>
                    </div>
                </div>
            </section>

            <!-- CRM -->
            <section id="crm-tab" class="tab-content" role="tabpanel">
                <div class="metrics-grid">
                    <div class="metric-card">
                        <h3>Total de Intera√ß√µes</h3>
                        <p id="metric-total-interactions">0</p>
                    </div>
                    <div class="metric-card">
                        <h3>Contatos no M√™s</h3>
                        <p id="metric-month-interactions">0</p>
                    </div>
                    <div class="metric-card">
                        <h3>Follow-ups Agendados</h3>
                        <p id="metric-scheduled-followups">0</p>
                    </div>
                </div>

                <div class="card">
                    <h2><i class="fas fa-lightbulb" aria-hidden="true"></i> Gest√£o de Follow-ups</h2>
                    <p style="color: var(--text-muted); margin-top: -20px; margin-bottom: 20px;">Sugest√µes autom√°ticas baseadas no tempo de retorno dos servi√ßos.</p>
                    <div class="data-list">
                        <ul id="suggested-followups-list"></ul>
                    </div>
                </div>

                <div class="card">
                    <h2><i class="fas fa-users-viewfinder" aria-hidden="true"></i> Segmenta√ß√£o de Clientes</h2>
                    <div class="filter-options">
                        <div id="inactive-period-filter" style="display: flex; flex-grow: 1; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-secondary active" data-period="all">Todos</button>
                            <button class="btn btn-secondary" data-period="15">Inativos 15d</button>
                            <button class="btn btn-secondary" data-period="30">Inativos 30d</button>
                            <button class="btn btn-secondary" data-period="45">Inativos 45d</button>
                            <button class="btn btn-secondary" data-period="60">Inativos 60d+</button>
                        </div>
                        <button id="bulk-contact-btn" class="btn btn-primary" style="margin-left: auto;"><i class="fas fa-bullhorn"></i> Contatar Lista</button>
                    </div>
                    <div class="data-list">
                        <ul id="inactive-clients-list"></ul>
                    </div>
                </div>

                <div class="crm-grid">
                    <div class="card">
                        <h2><i class="fas fa-comment-dots" aria-hidden="true"></i> Modelos de Mensagem</h2>
                        <div class="message-template form-group">
                            <label for="msg-template-1">Modelo 1: Lembrete Amig√°vel (Inativos)</label>
                            <textarea id="msg-template-1" rows="5" readonly>Ol√°, [NOME DO CLIENTE]! Tudo bem? Aqui √© da R.M. Est√©tica Automotiva. Notamos que j√° faz mais de [TEMPO] desde sua √∫ltima visita. S√≥ quer√≠amos saber se est√° tudo certo com o seu carro e nos colocar √† disposi√ß√£o! Precisando de algo, √© s√≥ chamar. üëç</textarea>
                        </div>
                        <div class="message-template form-group">
                            <label for="msg-template-2">Modelo 2: Oferta Especial (Inativos)</label>
                            <textarea id="msg-template-2" rows="5" readonly>Ol√°, [NOME DO CLIENTE]! Da R.M. Est√©tica Automotiva. Como j√° se passaram mais de [TEMPO] da sua √∫ltima visita, estamos com uma condi√ß√£o especial para voc√™: 10% de desconto na cristaliza√ß√£o dos vidros. Que tal dar um trato no carro? Aguardamos seu contato! ‚ú®</textarea>
                        </div>
                        <div class="message-template form-group">
                            <label for="msg-template-3">Modelo 3: Manuten√ß√£o (Inativos)</label>
                            <textarea id="msg-template-3" rows="5" readonly>Ol√° [NOME DO CLIENTE], tudo joia? Aqui da R.M. Est√©tica Automotiva. Passando para lembrar que, como j√° faz mais de [TEMPO] desde o √∫ltimo servi√ßo, a manuten√ß√£o da est√©tica do seu carro √© importante para manter o valor e a beleza dele. Quando pretende fazer a pr√≥xima? Estamos √† disposi√ß√£o! üöó</textarea>
                        </div>
                    </div>

                    <div class="card data-list">
                        <h2><i class="fas fa-history" aria-hidden="true"></i> Hist√≥rico de Intera√ß√µes</h2>
                        <div class="search-container">
                            <i class="fas fa-search" aria-hidden="true"></i>
                            <input type="search" id="search-crm" placeholder="Buscar por cliente ou nota..." aria-label="Pesquisar Intera√ß√µes">
                        </div>
                        <ul id="crm-interaction-list"></ul>
                    </div>

                    <div>
                        <div class="card">
                            <h2><i class="fas fa-plus-circle" aria-hidden="true"></i> Registrar Nova Intera√ß√£o</h2>
                            <form id="crm-interaction-form">
                                <div class="form-group">
                                    <label for="crm-cliente-select">Cliente</label>
                                    <select id="crm-cliente-select" required aria-required="true"></select>
                                </div>
                                <div class="form-group">
                                    <label for="crm-interaction-type">Tipo de Intera√ß√£o</label>
                                    <select id="crm-interaction-type" required aria-required="true">
                                        <option value="WhatsApp">WhatsApp</option>
                                        <option value="Chamada">Chamada</option>
                                        <option value="Visita">Visita</option>
                                        <option value="Email">E-mail</option>
                                        <option value="Outro">Outro</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="crm-notes">Notas</label>
                                    <textarea id="crm-notes" rows="4" placeholder="Descreva o contato com o cliente..." required aria-required="true"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="crm-follow-up-date">Agendar Follow-up (Opcional)</label>
                                    <input type="date" id="crm-follow-up-date">
                                </div>
                                <button type="submit" class="btn btn-primary"><i class="fas fa-save" aria-hidden="true"></i> Salvar Intera√ß√£o</button>
                            </form>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Despesas -->
            <section id="despesas-tab" class="tab-content" role="tabpanel">
                <div class="metrics-grid">
                    <div class="metric-card" style="border-left-color: var(--primary-red);">
                        <h3>Total Gasto no M√™s</h3>
                        <p id="metric-total-gasto">R$ 0,00</p>
                    </div>
                    <div class="metric-card" style="border-left-color: var(--accent-orange);">
                        <h3>Despesa M√©dia Di√°ria</h3>
                        <p id="metric-media-diaria">R$ 0,00</p>
                    </div>
                    <div class="metric-card" style="border-left-color: var(--accent-green);">
                        <h3>Categoria com Maior Gasto</h3>
                        <p id="metric-maior-categoria" style="font-size: 1.5rem; padding-top: 1rem;">N/A</p>
                    </div>
                </div>
                
                <div class="main-layout">
                    <div class="card">
                        <h2 id="despesa-form-title">Registrar Despesa</h2>
                        <form id="despesa-form">
                            <input type="hidden" id="despesa-id">
                            <div class="form-group">
                                <label for="despesa-descricao">Descri√ß√£o</label>
                                <input type="text" id="despesa-descricao" required placeholder="Ex: Compra de cera automotiva">
                            </div>
                            <div class="form-group">
                                <label for="despesa-valor">Valor (R$)</label>
                                <input type="number" id="despesa-valor" step="0.01" min="0.01" required placeholder="150,00">
                            </div>
                            <div class="form-group">
                                <label for="despesa-data">Data da Despesa</label>
                                <input type="date" id="despesa-data" required>
                            </div>
                            <div class="form-group">
                                <label for="despesa-categoria">Categoria</label>
                                <select id="despesa-categoria" required>
                                    <option value="Produtos">Produtos de Limpeza</option>
                                    <option value="Aluguel/Contas">Aluguel/Contas (√Ågua, Luz)</option>
                                    <option value="Marketing">Marketing e Publicidade</option>
                                    <option value="Ferramentas">Ferramentas e Equipamentos</option>
                                    <option value="Sal√°rios">Sal√°rios/M√£o de Obra</option>
                                    <option value="Impostos">Impostos e Taxas</option>
                                    <option value="Outros">Outros</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Salvar Despesa</button>
                        </form>
                    </div>
                    
                    <div class="card data-list">
                        <h2>Hist√≥rico de Despesas</h2>
                        <div class="filter-options">
                            <input type="month" id="filter-month" title="Filtrar por M√™s">
                            <button id="export-csv-btn" class="btn btn-sm btn-secondary" style="margin-left:auto;"><i class="fas fa-file-csv"></i> Exportar CSV</button>
                        </div>
                        <ul id="despesas-lista"></ul>
                    </div>
                </div>

                <div class="chart-container">
                    <h2 style="text-align: center; border: none; padding: 0;">Distribui√ß√£o de Despesas por Categoria (M√™s Atual)</h2>
                    <canvas id="despesas-chart"></canvas>
                </div>
            </section>
        </main>
    </div>

    <div id="notification" role="status" aria-live="polite"></div>

    <div id="confirm-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div class="modal-content">
            <h3 id="modal-title">Confirmar A√ß√£o</h3>
            <p id="modal-message">Voc√™ tem certeza?</p>
            <div class="modal-actions">
                <button id="modal-cancel-btn" class="btn btn-secondary" aria-label="Cancelar">
                    <i class="fas fa-ban" aria-hidden="true"></i> Cancelar
                </button>
                <button id="modal-confirm-btn" class="btn btn-danger" aria-label="Confirmar">
                    <i class="fas fa-check-circle" aria-hidden="true"></i> Confirmar
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // Credenciais do Supabase
        const SUPABASE_URL = 'https://bezbszbkaifcanqsmdbi.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJlemJzemJrYWlmY2FucXNtZGJpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2MTM5MTksImV4cCI6MjA2ODE4OTkxOX0.zLXAuQz7g5ym3Bd5pkhg5vsnf_3rdJFRAXI_kX8tM18';
        
        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);

        // Estado da aplica√ß√£o
        let state = {
            clientes: [],
            servicos: [],
            orcamentos: [],
            despesas: [],
            crmInteractions: [],
            currentTab: 'dashboard',
            selectedOrcamento: null,
            orcamentoServicos: [],
            selectedPayments: [],
            editingId: null,
            chartInstance: null
        };

        // Utilit√°rios
        const $ = (id) => document.getElementById(id);
        const $$ = (selector) => document.querySelectorAll(selector);
        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        const formatDate = (dateString) => new Date(dateString).toLocaleDateString('pt-BR');
        const formatDateTime = (dateString) => new Date(dateString).toLocaleString('pt-BR');

        // Notifica√ß√£o
        const showNotification = (message, type = 'success') => {
            const notification = $('notification');
            notification.textContent = message;
            notification.className = `show ${type}`;
            setTimeout(() => notification.classList.remove('show'), 3000);
        };

        // Modal de confirma√ß√£o
        let confirmCallback = null;
        const showConfirmModal = (title, message, callback) => {
            $('modal-title').textContent = title;
            $('modal-message').textContent = message;
            confirmCallback = callback;
            $('confirm-modal').classList.add('active');
        };

        const hideConfirmModal = () => {
            $('confirm-modal').classList.remove('active');
            confirmCallback = null;
        };

        // Navega√ß√£o por abas
        const switchTab = (tabName) => {
            // Remover classe active de todas as abas
            $$('.nav-btn').forEach(btn => btn.classList.remove('active'));
            $$('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Ativar aba selecionada
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            $(`${tabName}-tab`).classList.add('active');
            
            state.currentTab = tabName;
            
            // Carregar dados espec√≠ficos da aba
            switch(tabName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'clientes':
                    loadClientes();
                    break;
                case 'servicos':
                    loadServicos();
                    break;
                case 'novo-orcamento':
                    loadOrcamentoForm();
                    break;
                case 'historico':
                    loadHistorico();
                    break;
                case 'crm':
                    loadCRM();
                    break;
                case 'despesas':
                    loadDespesas();
                    break;
            }
        };

        // Carregar dados iniciais
        const loadAllData = async () => {
            try {
                const [clientesRes, servicosRes, orcamentosRes, despesasRes, crmRes] = await Promise.all([
                    db.from('clientes').select('*'),
                    db.from('servicos').select('*'),
                    db.from('orcamentos').select('*, clientes(nome), orcamento_itens(*, servicos(descricao))'),
                    db.from('despesas').select('*'),
                    db.from('crm_interactions').select('*, clientes(nome)')
                ]);

                state.clientes = clientesRes.data || [];
                state.servicos = servicosRes.data || [];
                state.orcamentos = orcamentosRes.data || [];
                state.despesas = despesasRes.data || [];
                state.crmInteractions = crmRes.data || [];

                loadDashboard();
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                showNotification('Erro ao carregar dados', 'error');
            }
        };

        // Dashboard
        const loadDashboard = () => {
            const totalClientes = state.clientes.length;
            const pendentes = state.orcamentos.filter(o => o.status === 'Or√ßamento').length;
            const aprovados = state.orcamentos.filter(o => o.status === 'Aprovado').length;
            
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const finalizadosMes = state.orcamentos.filter(o => 
                o.status === 'Finalizado' && new Date(o.updated_at) >= startOfMonth
            ).length;
            
            const faturamentoTotal = state.orcamentos
                .filter(o => o.status === 'Finalizado')
                .reduce((total, o) => total + o.valor_total, 0);

            $('stat-clientes').textContent = totalClientes;
            $('stat-pendentes').textContent = pendentes;
            $('stat-aprovados').textContent = aprovados;
            $('stat-finalizados-mes').textContent = finalizadosMes;
            $('stat-faturamento-total').textContent = formatCurrency(faturamentoTotal);

            // Atividade recente
            const recentActivity = state.orcamentos
                .sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at))
                .slice(0, 10);

            $('recent-activity-list').innerHTML = recentActivity.map(o => `
                <li onclick="switchTab('historico')">
                    <div>
                        <strong>${o.clientes?.nome || 'Cliente n√£o encontrado'}</strong><br>
                        <small>${formatDateTime(o.updated_at)}</small>
                    </div>
                    <div>
                        <span class="status-indicator status-${o.status}">${o.status}</span>
                    </div>
                </li>
            `).join('');
        };

        // Clientes
        const loadClientes = async () => {
            renderClientes();
            
            $('cliente-form').onsubmit = async (e) => {
                e.preventDefault();
                
                const data = {
                    nome: $('cliente-nome').value,
                    telefone: $('cliente-telefone').value,
                    veiculo: $('cliente-veiculo').value,
                    placa: $('cliente-placa').value
                };

                try {
                    if (state.editingId) {
                        await db.from('clientes').update(data).eq('id', state.editingId);
                        showNotification('Cliente atualizado com sucesso!');
                    } else {
                        await db.from('clientes').insert(data);
                        showNotification('Cliente cadastrado com sucesso!');
                    }
                    
                    resetClienteForm();
                    await loadAllData();
                } catch (error) {
                    console.error('Erro ao salvar cliente:', error);
                    showNotification('Erro ao salvar cliente', 'error');
                }
            };

            $('search-clientes').oninput = renderClientes;
        };

        const renderClientes = () => {
            const search = $('search-clientes')?.value?.toLowerCase() || '';
            const filteredClientes = state.clientes.filter(c => 
                c.nome.toLowerCase().includes(search) || 
                c.telefone.includes(search) ||
                (c.veiculo && c.veiculo.toLowerCase().includes(search))
            );

            $('clientes-lista').innerHTML = filteredClientes.map(cliente => `
                <li>
                    <div>
                        <strong>${cliente.nome}</strong><br>
                        <small>${cliente.telefone} | ${cliente.veiculo || 'Ve√≠culo n√£o informado'}</small>
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-sm btn-secondary" onclick="editCliente(${cliente.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCliente(${cliente.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </li>
            `).join('');
        };

        const editCliente = (id) => {
            const cliente = state.clientes.find(c => c.id === id);
            if (!cliente) return;

            $('cliente-id').value = cliente.id;
            $('cliente-nome').value = cliente.nome;
            $('cliente-telefone').value = cliente.telefone;
            $('cliente-veiculo').value = cliente.veiculo || '';
            $('cliente-placa').value = cliente.placa || '';
            $('cliente-form-title').innerHTML = 'Editar Cliente <i class="fas fa-edit"></i>';
            
            state.editingId = id;
        };

        const deleteCliente = (id) => {
            showConfirmModal('Excluir Cliente', 'Tem certeza que deseja excluir este cliente?', async () => {
                try {
                    await db.from('clientes').delete().eq('id', id);
                    showNotification('Cliente exclu√≠do com sucesso!');
                    await loadAllData();
                } catch (error) {
                    console.error('Erro ao excluir cliente:', error);
                    showNotification('Erro ao excluir cliente', 'error');
                }
                hideConfirmModal();
            });
        };

        const resetClienteForm = () => {
            $('cliente-form').reset();
            $('cliente-id').value = '';
            $('cliente-form-title').innerHTML = 'Novo Cliente <i class="fas fa-user-plus"></i>';
            state.editingId = null;
        };

        // Servi√ßos
        const loadServicos = async () => {
            renderServicos();
            
            $('servico-form').onsubmit = async (e) => {
                e.preventDefault();
                
                const data = {
                    descricao: $('servico-descricao').value,
                    valor: parseFloat($('servico-valor').value),
                    dias_retorno: parseInt($('servico-dias-retorno').value) || null
                };

                try {
                    if (state.editingId) {
                        await db.from('servicos').update(data).eq('id', state.editingId);
                        showNotification('Servi√ßo atualizado com sucesso!');
                    } else {
                        await db.from('servicos').insert(data);
                        showNotification('Servi√ßo cadastrado com sucesso!');
                    }
                    
                    resetServicoForm();
                    await loadAllData();
                } catch (error) {
                    console.error('Erro ao salvar servi√ßo:', error);
                    showNotification('Erro ao salvar servi√ßo', 'error');
                }
            };

            $('search-servicos').oninput = renderServicos;
        };

        const renderServicos = () => {
            const search = $('search-servicos')?.value?.toLowerCase() || '';
            const filteredServicos = state.servicos.filter(s => 
                s.descricao.toLowerCase().includes(search)
            );

            $('servicos-lista').innerHTML = filteredServicos.map(servico => `
                <li>
                    <div>
                        <strong>${servico.descricao}</strong><br>
                        <small>${formatCurrency(servico.valor)} ${servico.dias_retorno ? `| Retorno em ${servico.dias_retorno} dias` : ''}</small>
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-sm btn-secondary" onclick="editServico(${servico.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteServico(${servico.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </li>
            `).join('');
        };

        const editServico = (id) => {
            const servico = state.servicos.find(s => s.id === id);
            if (!servico) return;

            $('servico-id').value = servico.id;
            $('servico-descricao').value = servico.descricao;
            $('servico-valor').value = servico.valor;
            $('servico-dias-retorno').value = servico.dias_retorno || '';
            $('servico-form-title').innerHTML = 'Editar Servi√ßo <i class="fas fa-edit"></i>';
            
            state.editingId = id;
        };

        const deleteServico = (id) => {
            showConfirmModal('Excluir Servi√ßo', 'Tem certeza que deseja excluir este servi√ßo?', async () => {
                try {
                    await db.from('servicos').delete().eq('id', id);
                    showNotification('Servi√ßo exclu√≠do com sucesso!');
                    await loadAllData();
                } catch (error) {
                    console.error('Erro ao excluir servi√ßo:', error);
                    showNotification('Erro ao excluir servi√ßo', 'error');
                }
                hideConfirmModal();
            });
        };

        const resetServicoForm = () => {
            $('servico-form').reset();
            $('servico-id').value = '';
            $('servico-form-title').innerHTML = 'Novo Servi√ßo <i class="fas fa-plus-circle"></i>';
            state.editingId = null;
        };

        // Or√ßamento
        const loadOrcamentoForm = () => {
            // Povoar select de clientes
            $('orcamento-cliente').innerHTML = '<option value="">Selecione um cliente...</option>' +
                state.clientes.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');
            
            // Povoar select de servi√ßos
            $('orcamento-servico').innerHTML = '<option value="">Selecione um servi√ßo...</option>' +
                state.servicos.map(s => `<option value="${s.id}">${s.descricao} - ${formatCurrency(s.valor)}</option>`).join('');
            
            // Bot√£o adicionar servi√ßo
            $('add-servico-btn').onclick = () => {
                const servicoId = parseInt($('orcamento-servico').value);
                if (!servicoId) return;
                
                const servico = state.servicos.find(s => s.id === servicoId);
                if (!servico) return;
                
                // Verificar se j√° foi adicionado
                if (state.orcamentoServicos.find(s => s.id === servicoId)) {
                    showNotification('Servi√ßo j√° adicionado', 'warning');
                    return;
                }
                
                state.orcamentoServicos.push({
                    id: servicoId,
                    descricao: servico.descricao,
                    valor: servico.valor,
                    quantidade: 1
                });
                
                renderOrcamentoServicos();
                calculateTotal();
            };
            
            // Formas de pagamento
            $$('.payment-option').forEach(option => {
                option.onclick = () => {
                    const payment = option.dataset.payment;
                    if (state.selectedPayments.includes(payment)) {
                        state.selectedPayments = state.selectedPayments.filter(p => p !== payment);
                        option.classList.remove('active');
                    } else {
                        state.selectedPayments.push(payment);
                        option.classList.add('active');
                    }
                };
            });
            
            // Desconto
            $('orcamento-desconto').oninput = calculateTotal;
            
            // Submit do formul√°rio
            $('orcamento-form').onsubmit = async (e) => {
                e.preventDefault();
                
                const clienteId = parseInt($('orcamento-cliente').value);
                const desconto = parseFloat($('orcamento-desconto').value) || 0;
                const observacoes = $('orcamento-observacoes').value;
                
                if (!clienteId) {
                    showNotification('Selecione um cliente', 'warning');
                    return;
                }
                
                if (state.orcamentoServicos.length === 0) {
                    showNotification('Adicione pelo menos um servi√ßo', 'warning');
                    return;
                }
                
                if (state.selectedPayments.length === 0) {
                    showNotification('Selecione pelo menos uma forma de pagamento', 'warning');
                    return;
                }
                
                const subtotal = state.orcamentoServicos.reduce((total, s) => total + (s.valor * s.quantidade), 0);
                const valorDesconto = subtotal * (desconto / 100);
                const valorTotal = subtotal - valorDesconto;
                
                try {
                    // Inserir or√ßamento
                    const { data: orcamento, error } = await db.from('orcamentos').insert({
                        cliente_id: clienteId,
                        valor_total: valorTotal,
                        desconto: desconto,
                        formas_pagamento: state.selectedPayments,
                        observacoes: observacoes,
                        status: 'Or√ßamento'
                    }).select().single();
                    
                    if (error) throw error;
                    
                    // Inserir itens do or√ßamento
                    const itens = state.orcamentoServicos.map(s => ({
                        orcamento_id: orcamento.id,
                        servico_id: s.id,
                        quantidade: s.quantidade,
                        valor_unitario: s.valor,
                        valor_total: s.valor * s.quantidade
                    }));
                    
                    await db.from('orcamento_itens').insert(itens);
                    
                    showNotification('Or√ßamento criado com sucesso!');
                    resetOrcamentoForm();
                    await loadAllData();
                    
                } catch (error) {
                    console.error('Erro ao criar or√ßamento:', error);
                    showNotification('Erro ao criar or√ßamento', 'error');
                }
            };
            
            renderOrcamentoServicos();
            calculateTotal();
        };

        const renderOrcamentoServicos = () => {
            $('orcamento-servicos-lista').innerHTML = state.orcamentoServicos.map(servico => `
                <li>
                    <div>
                        <strong>${servico.descricao}</strong><br>
                        <small>${formatCurrency(servico.valor)} x ${servico.quantidade}</small>
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-sm btn-danger" onclick="removeOrcamentoServico(${servico.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </li>
            `).join('');
        };

        const removeOrcamentoServico = (id) => {
            state.orcamentoServicos = state.orcamentoServicos.filter(s => s.id !== id);
            renderOrcamentoServicos();
            calculateTotal();
        };

        const calculateTotal = () => {
            const subtotal = state.orcamentoServicos.reduce((total, s) => total + (s.valor * s.quantidade), 0);
            const desconto = parseFloat($('orcamento-desconto').value) || 0;
            const valorDesconto = subtotal * (desconto / 100);
            const total = subtotal - valorDesconto;
            
            $('orcamento-total').textContent = `TOTAL: ${formatCurrency(total)}`;
        };

        const resetOrcamentoForm = () => {
            $('orcamento-form').reset();
            state.orcamentoServicos = [];
            state.selectedPayments = [];
            $$('.payment-option').forEach(option => option.classList.remove('active'));
            renderOrcamentoServicos();
            calculateTotal();
        };

        // Hist√≥rico
        const loadHistorico = () => {
            renderHistorico();
            
            $('filter-status').onchange = renderHistorico;
            $('filter-date-from').onchange = renderHistorico;
            $('filter-date-to').onchange = renderHistorico;
            $('search-historico').oninput = renderHistorico;
        };

        const renderHistorico = () => {
            const statusFilter = $('filter-status').value;
            const dateFrom = $('filter-date-from').value;
            const dateTo = $('filter-date-to').value;
            const search = $('search-historico').value.toLowerCase();
            
            let filteredOrcamentos = state.orcamentos;
            
            if (statusFilter) {
                filteredOrcamentos = filteredOrcamentos.filter(o => o.status === statusFilter);
            }
            
            if (dateFrom) {
                filteredOrcamentos = filteredOrcamentos.filter(o => 
                    new Date(o.created_at) >= new Date(dateFrom)
                );
            }
            
            if (dateTo) {
                filteredOrcamentos = filteredOrcamentos.filter(o => 
                    new Date(o.created_at) <= new Date(dateTo)
                );
            }
            
            if (search) {
                filteredOrcamentos = filteredOrcamentos.filter(o => 
                    o.clientes?.nome.toLowerCase().includes(search) ||
                    o.observacoes?.toLowerCase().includes(search)
                );
            }
            
            $('historico-lista').innerHTML = filteredOrcamentos.map(orcamento => `
                <li onclick="selectOrcamento(${orcamento.id})">
                    <div>
                        <strong>${orcamento.clientes?.nome || 'Cliente n√£o encontrado'}</strong><br>
                        <small>${formatDate(orcamento.created_at)} | ${formatCurrency(orcamento.valor_total)}</small>
                    </div>
                    <div>
                        <span class="status-indicator status-${orcamento.status}">${orcamento.status}</span>
                    </div>
                </li>
            `).join('');
        };

        const selectOrcamento = (id) => {
            state.selectedOrcamento = state.orcamentos.find(o => o.id === id);
            // Aqui voc√™ pode implementar a visualiza√ß√£o detalhada do or√ßamento
        };

        // CRM
        const loadCRM = async () => {
            await loadCRMData();
            renderCRMMetrics();
            renderCRMInteractions();
            
            // Popular select de clientes
            $('crm-cliente-select').innerHTML = '<option value="">Selecione um cliente...</option>' +
                state.clientes.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');
            
            // Form de intera√ß√£o
            $('crm-interaction-form').onsubmit = async (e) => {
                e.preventDefault();
                
                const data = {
                    cliente_id: parseInt($('crm-cliente-select').value),
                    interaction_type: $('crm-interaction-type').value,
                    notes: $('crm-notes').value,
                    follow_up_date: $('crm-follow-up-date').value || null
                };
                
                try {
                    await db.from('crm_interactions').insert(data);
                    showNotification('Intera√ß√£o registrada com sucesso!');
                    $('crm-interaction-form').reset();
                    await loadCRMData();
                    renderCRMMetrics();
                    renderCRMInteractions();
                } catch (error) {
                    console.error('Erro ao registrar intera√ß√£o:', error);
                    showNotification('Erro ao registrar intera√ß√£o', 'error');
                }
            };
            
            $('search-crm').oninput = renderCRMInteractions;
        };

        const loadCRMData = async () => {
            const { data } = await db.from('crm_interactions').select('*, clientes(nome)').order('created_at', { ascending: false });
            state.crmInteractions = data || [];
        };

        const renderCRMMetrics = () => {
            const total = state.crmInteractions.length;
            
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const monthInteractions = state.crmInteractions.filter(i => 
                new Date(i.created_at) >= startOfMonth
            ).length;
            
            const followups = state.crmInteractions.filter(i => 
                i.follow_up_date && new Date(i.follow_up_date) >= now
            ).length;
            
            $('metric-total-interactions').textContent = total;
            $('metric-month-interactions').textContent = monthInteractions;
            $('metric-scheduled-followups').textContent = followups;
        };

        const renderCRMInteractions = () => {
            const search = $('search-crm')?.value?.toLowerCase() || '';
            const filteredInteractions = state.crmInteractions.filter(i => 
                i.clientes?.nome?.toLowerCase().includes(search) ||
                i.notes.toLowerCase().includes(search)
            );
            
            $('crm-interaction-list').innerHTML = filteredInteractions.map(interaction => `
                <li>
                    <div>
                        <strong>${interaction.clientes?.nome || 'Cliente n√£o encontrado'}</strong><br>
                        <small>${interaction.interaction_type} - ${formatDateTime(interaction.created_at)}</small><br>
                        <small>${interaction.notes}</small>
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-sm btn-danger" onclick="deleteCRMInteraction(${interaction.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </li>
            `).join('');
        };

        const deleteCRMInteraction = (id) => {
            showConfirmModal('Excluir Intera√ß√£o', 'Tem certeza que deseja excluir esta intera√ß√£o?', async () => {
                try {
                    await db.from('crm_interactions').delete().eq('id', id);
                    showNotification('Intera√ß√£o exclu√≠da com sucesso!');
                    await loadCRMData();
                    renderCRMMetrics();
                    renderCRMInteractions();
                } catch (error) {
                    console.error('Erro ao excluir intera√ß√£o:', error);
                    showNotification('Erro ao excluir intera√ß√£o', 'error');
                }
                hideConfirmModal();
            });
        };

        // Despesas
        const loadDespesas = async () => {
            await loadDespesasData();
            renderDespesasMetrics();
            renderDespesas();
            
            // Definir data atual
            const now = new Date();
            $('despesa-data').valueAsDate = now;
            $('filter-month').value = now.toISOString().slice(0, 7);
            
            // Form de despesa
            $('despesa-form').onsubmit = async (e) => {
                e.preventDefault();
                
                const data = {
                    descricao: $('despesa-descricao').value,
                    valor: parseFloat($('despesa-valor').value),
                    data: $('despesa-data').value,
                    categoria: $('despesa-categoria').value
                };
                
                try {
                    await db.from('despesas').insert(data);
                    showNotification('Despesa registrada com sucesso!');
                    $('despesa-form').reset();
                    $('despesa-data').valueAsDate = now;
                    await loadDespesasData();
                    renderDespesasMetrics();
                    renderDespesas();
                    renderDespesasChart();
                } catch (error) {
                    console.error('Erro ao registrar despesa:', error);
                    showNotification('Erro ao registrar despesa', 'error');
                }
            };
            
            $('filter-month').onchange = () => {
                renderDespesas();
                renderDespesasChart();
            };
            
            $('export-csv-btn').onclick = exportDespesasCSV;
            
            renderDespesasChart();
        };

        const loadDespesasData = async () => {
            const { data } = await db.from('despesas').select('*').order('data', { ascending: false });
            state.despesas = data || [];
        };

        const renderDespesasMetrics = () => {
            const now = new Date();
            const currentMonth = now.toISOString().slice(0, 7);
            
            const despesasMes = state.despesas.filter(d => d.data.startsWith(currentMonth));
            
            const totalGasto = despesasMes.reduce((sum, d) => sum + d.valor, 0);
            $('metric-total-gasto').textContent = formatCurrency(totalGasto);
            
            const diasNoMes = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            const mediaDiaria = totalGasto / diasNoMes;
            $('metric-media-diaria').textContent = formatCurrency(mediaDiaria);
            
            const gastosPorCategoria = despesasMes.reduce((acc, d) => {
                acc[d.categoria] = (acc[d.categoria] || 0) + d.valor;
                return acc;
            }, {});
            
            let maiorCategoria = 'N/A';
            let maiorValor = 0;
            for (const categoria in gastosPorCategoria) {
                if (gastosPorCategoria[categoria] > maiorValor) {
                    maiorValor = gastosPorCategoria[categoria];
                    maiorCategoria = categoria;
                }
            }
            
            $('metric-maior-categoria').textContent = maiorCategoria;
        };

        const renderDespesas = () => {
            const selectedMonth = $('filter-month').value;
            let filteredDespesas = state.despesas;
            
            if (selectedMonth) {
                filteredDespesas = state.despesas.filter(d => d.data.startsWith(selectedMonth));
            }
            
            $('despesas-lista').innerHTML = filteredDespesas.map(despesa => `
                <li>
                    <div>
                        <strong>${despesa.descricao}</strong><br>
                        <small>${despesa.categoria} - ${formatDate(despesa.data)}</small>
                    </div>
                    <div>
                        <strong style="color: var(--primary-red);">${formatCurrency(despesa.valor)}</strong>
                        <div class="item-actions">
                            <button class="btn btn-sm btn-danger" onclick="deleteDespesa(${despesa.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </li>
            `).join('');
        };

        const renderDespesasChart = () => {
            const selectedMonth = $('filter-month').value || new Date().toISOString().slice(0, 7);
            const despesasMes = state.despesas.filter(d => d.data.startsWith(selectedMonth));
            
            const gastosPorCategoria = despesasMes.reduce((acc, d) => {
                acc[d.categoria] = (acc[d.categoria] || 0) + d.valor;
                return acc;
            }, {});
            
            const ctx = $('despesas-chart').getContext('2d');
            
            if (state.chartInstance) {
                state.chartInstance.destroy();
            }
            
            state.chartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(gastosPorCategoria),
                    datasets: [{
                        data: Object.values(gastosPorCategoria),
                        backgroundColor: [
                            '#3b82f6', '#ef4444', '#22c55e', '#f97316', 
                            '#8b5cf6', '#eab308', '#64748b'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#e2e8f0'
                            }
                        }
                    }
                }
            });
        };

        const deleteDespesa = (id) => {
            showConfirmModal('Excluir Despesa', 'Tem certeza que deseja excluir esta despesa?', async () => {
                try {
                    await db.from('despesas').delete().eq('id', id);
                    showNotification('Despesa exclu√≠da com sucesso!');
                    await loadDespesasData();
                    renderDespesasMetrics();
                    renderDespesas();
                    renderDespesasChart();
                } catch (error) {
                    console.error('Erro ao excluir despesa:', error);
                    showNotification('Erro ao excluir despesa', 'error');
                }
                hideConfirmModal();
            });
        };

        const exportDespesasCSV = () => {
            const selectedMonth = $('filter-month').value;
            let dataToExport = state.despesas;
            
            if (selectedMonth) {
                dataToExport = state.despesas.filter(d => d.data.startsWith(selectedMonth));
            }
            
            if (dataToExport.length === 0) {
                showNotification('Nenhuma despesa para exportar', 'warning');
                return;
            }
            
            const headers = ['Data', 'Descri√ß√£o', 'Categoria', 'Valor'];
            const csvRows = [headers.join(',')];
            
            dataToExport.forEach(despesa => {
                const row = [
                    formatDate(despesa.data),
                    `"${despesa.descricao}"`,
                    despesa.categoria,
                    despesa.valor.toFixed(2)
                ];
                csvRows.push(row.join(','));
            });
            
            const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `despesas_${selectedMonth || 'geral'}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Navega√ß√£o
            $$('.nav-btn').forEach(btn => {
                btn.onclick = () => switchTab(btn.dataset.tab);
            });
            
            // Modal
            $('modal-cancel-btn').onclick = hideConfirmModal;
            $('modal-confirm-btn').onclick = () => {
                if (confirmCallback) confirmCallback();
                hideConfirmModal();
            };
            
            // Sync button
            $('sync-btn').onclick = () => {
                $('sync-btn').classList.add('syncing');
                setTimeout(() => {
                    $('sync-btn').classList.remove('syncing');
                    loadAllData();
                }, 1000);
            };
            
            // Carregar dados iniciais
            loadAllData();
        });

        // Fun√ß√µes globais para uso nos templates
        window.editCliente = editCliente;
        window.deleteCliente = deleteCliente;
        window.editServico = editServico;
        window.deleteServico = deleteServico;
        window.removeOrcamentoServico = removeOrcamentoServico;
        window.selectOrcamento = selectOrcamento;
        window.deleteCRMInteraction = deleteCRMInteraction;
        window.deleteDespesa = deleteDespesa;
        window.switchTab = switchTab;
    </script>
</body>
</html>
