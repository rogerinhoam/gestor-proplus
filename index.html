<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R.M. Estética Automotiva PRO+</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.33.0/ace.js"></script>

    <style>
        /* R.M. Estética Automotiva PRO+ */
        /* Versão: 5.3 (Correção Final do Módulo de Tarefas e Schema) */
        /* Autor: Gemini */

        /* 1. VARIÁVEIS CSS (TOKENS) */
        :root {
            /* Paleta de Cores - Tema Escuro (Padrão) */
            --primary-red: #EF4444;
            --primary-red-dark: #DC2626;
            --accent-green: #10B981;
            --accent-blue: #3B82F6;
            --accent-orange: #F59E0B;
            --danger-red: #991b1b;
            --danger-red-dark: #7f1d1d;
            
            --dark-text-light: #E8EAED;
            --dark-text-dark: #FFFFFF;
            --dark-text-muted: #9AA0A6;
            --dark-bg-primary: #121212;
            --dark-bg-secondary: #1E1E1E;
            --dark-bg-tertiary: #2D2D2D;
            --dark-border-color: #444444;

            --light-text-light: #374151;
            --light-text-dark: #111827;
            --light-text-muted: #6B7280;
            --light-bg-primary: #F9FAFB;
            --light-bg-secondary: #FFFFFF;
            --light-bg-tertiary: #F3F4F6;
            --light-border-color: #E5E7EB;

            --text-light: var(--dark-text-light);
            --text-dark: var(--dark-text-dark);
            --text-muted: var(--dark-text-muted);
            --bg-primary: var(--dark-bg-primary);
            --bg-secondary: var(--dark-bg-secondary);
            --bg-tertiary: var(--dark-bg-tertiary);
            --border-color: var(--dark-border-color);

            --shadow-color: rgba(0, 0, 0, 0.3);
            --shadow-color-light: rgba(0, 0, 0, 0.2);
            --backdrop-color: rgba(0, 0, 0, 0.6);
            --skeleton-bg: #3a3a3a;
            --skeleton-highlight: #4a4a4a;

            /* Espaçamento */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;

            /* Fontes */
            --font-base: 'Inter', sans-serif;
            --font-title: 'Poppins', sans-serif;

            /* Outros */
            --border-radius-sm: 6px;
            --border-radius-md: 12px;
            --transition-fast: 0.2s ease;
            --transition-medium: 0.3s ease;
       }

        /* Tema Claro - Ativado com a classe .light-mode no body */
        body.light-mode {
            --text-light: var(--light-text-light);
            --text-dark: var(--light-text-dark);
            --text-muted: var(--light-text-muted);
            --bg-primary: var(--light-bg-primary);
            --bg-secondary: var(--light-bg-secondary);
            --bg-tertiary: var(--light-bg-tertiary);
            --border-color: var(--light-border-color);

            --shadow-color: rgba(0, 0, 0, 0.08);
            --shadow-color-light: rgba(0, 0, 0, 0.05);
            --backdrop-color: rgba(0, 0, 0, 0.3);
            --skeleton-bg: #E5E7EB;
            --skeleton-highlight: #F3F4F6;
        }


        /* 2. RESET BÁSICO E ESTILOS GLOBAIS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-base);
            background-color: var(--bg-primary);
            color: var(--text-light);
            line-height: 1.6;
            font-size: 16px;
            display: flex;
            justify-content: center;
            padding: var(--space-md);
            min-height: 100vh;
            transition: background-color var(--transition-medium), color var(--transition-medium);
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: var(--bg-image-url);
            background-repeat: no-repeat;
            background-position: center;
            background-size: cover;
            opacity: var(--bg-image-opacity, 0);
            z-index: -2;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: var(--watermark-url);
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
            opacity: var(--watermark-opacity, 0);
            z-index: -1;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: var(--font-title);
            font-weight: 600;
            color: var(--text-dark);
        }

        a {
            color: var(--accent-blue);
            text-decoration: none;
            transition: color var(--transition-fast);
        }

        a:hover {
            text-decoration: underline;
        }

        ul {
            list-style: none;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
            border-radius: var(--border-radius-md);
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--border-color);
        }
        
        /* Status Badge */
        .status-badge {
            padding: 2px 8px;
            border-radius: var(--border-radius-md);
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            color: white;
        }
        .status-badge.pendente { background-color: var(--accent-orange); }
        .status-badge.aprovado { background-color: var(--accent-blue); }
        .status-badge.finalizado { background-color: var(--accent-green); }
        .status-badge.pago { background-color: #059669; }
        .status-badge.cancelado { background-color: #7f1d1d; }


        /* 3. LAYOUT PRINCIPAL E COMPONENTES */
        .app-container {
            width: 100%;
            max-width: 1280px;
            background-color: var(--bg-secondary);
            padding: var(--space-lg);
            border-radius: var(--border-radius-md);
            box-shadow: 0 4px 20px var(--shadow-color);
            transition: background-color var(--transition-medium);
            position: relative;
            z-index: 1;
        }

        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: var(--space-md);
            border-bottom: 1px solid var(--border-color);
            margin-bottom: var(--space-lg);
            position: sticky;
            top: 0;
            background-color: var(--bg-secondary);
            z-index: 100;
            padding-top: var(--space-lg);
        }
        
        .header-left-section {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .header-logo {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--border-color);
            box-shadow: 0 4px 10px var(--shadow-color);
        }

        .app-header h1 {
            font-size: 1.6rem;
            font-weight: 700;
            line-height: 1.2;
        }

        .app-header .pro-plus {
            font-weight: 600;
            font-size: 1rem;
            color: var(--primary-red);
            vertical-align: middle;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        #hamburger-menu {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 1.8rem;
            cursor: pointer;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--border-radius-sm);
            transition: background-color var(--transition-fast), color var(--transition-fast);
        }

        #hamburger-menu:hover {
            background-color: var(--primary-red);
            color: white;
        }

        #main-nav {
            position: fixed;
            top: 90px;
            right: 20px;
            background-color: var(--bg-tertiary);
            border-radius: var(--border-radius-md);
            box-shadow: 0 4px 15px var(--shadow-color);
            z-index: 1000;
            overflow: hidden;
            max-height: 0;
            transition: max-height var(--transition-medium);
        }

        #main-nav.open {
            max-height: 500px;
        }

        #main-nav ul {
            padding: var(--space-sm);
        }

        #main-nav .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: var(--space-sm) var(--space-md);
            color: var(--text-light);
            font-weight: 500;
            border-radius: var(--border-radius-sm);
            white-space: nowrap;
            text-decoration: none;
        }

        #main-nav .nav-link i {
            font-size: 20px;
            width: 20px;
            text-align: center;
        }

        #main-nav .nav-link:hover, #main-nav .nav-link.active {
            background-color: var(--primary-red);
            color: white;
        }

        .tab-content {
            display: none;
            animation: fadeInScale 0.4s ease-out;
        }

        .tab-content.active {
            display: block;
        }

        /* 4. GRIDS E CARDS */
        .grid-layout {
            display: grid;
            gap: var(--space-lg);
        }
        .grid-layout.two-cols {
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        }

        .dashboard-main-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--space-lg);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: var(--space-md);
            grid-column: 1 / -1; /* Span full width */
        }

        .recent-activity-container {
            grid-column: 1 / -1; /* Span full width */
        }
        
        .top-services-container {
            grid-column: 1 / -1;
        }

        @media (min-width: 992px) {
            .dashboard-main-grid {
                grid-template-columns: 2fr 1fr;
            }
            .metrics-grid {
                grid-column: 1 / 2;
            }
            .recent-activity-container {
                grid-column: 2 / 3;
                grid-row: 1 / 3;
            }
            .chart-container {
                grid-column: 1 / 2;
            }
            .top-services-container {
                grid-column: 1 / 3; /* Span full width on larger screens too */
            }
        }


        .card {
            background-color: var(--bg-tertiary);
            padding: var(--space-lg);
            border-radius: var(--border-radius-md);
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 8px var(--shadow-color-light);
            transition: transform var(--transition-fast), box-shadow var(--transition-fast);
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px var(--shadow-color);
        }

        .stat-card {
            background: var(--bg-secondary);
            padding: var(--space-md);
            border-radius: var(--border-radius-md);
            display: flex;
            align-items: center;
            gap: var(--space-md);
            border-left: 4px solid var(--accent-blue);
            transition: box-shadow var(--transition-fast), transform var(--transition-fast);
        }

        .stat-card[data-action] {
             cursor: pointer;
        }
        
        .stat-card[data-action]:hover {
            box-shadow: 0 0 15px var(--shadow-color-light);
            transform: scale(1.03);
        }
        .stat-card i {
            font-size: 1.8rem;
            color: var(--accent-blue);
        }
        .stat-card h3 {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: var(--space-xs);
        }
        .stat-card p {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-dark);
        }

        /* Specific stat card colors */
        #stat-faturamento-card { border-color: var(--accent-green); }
        #stat-faturamento-card i { color: var(--accent-green); }
        #stat-recorrentes-card { border-color: var(--accent-blue); }
        #stat-recorrentes-card i { color: var(--accent-blue); }
        #stat-finalizados-card { border-color: var(--primary-red); }
        #stat-finalizados-card i { color: var(--primary-red); }


        .chart-container {
            padding: var(--space-lg);
        }

        #monthlyStatsChart {
            max-height: 300px;
        }

        /* 5. LISTAS E TABELAS */
        .data-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
            max-height: 500px;
            overflow-y: auto;
            padding-right: var(--space-xs);
        }

        .data-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-md);
            background-color: var(--bg-primary);
            border-radius: var(--border-radius-sm);
            border-left: 3px solid transparent;
            transition: background-color var(--transition-fast), border-left-color var(--transition-fast);
        }

        .data-list li:nth-child(even) {
            background-color: var(--bg-secondary);
        }

        .data-list li:hover {
            background-color: var(--border-color);
            border-left-color: var(--primary-red);
            box-shadow: 0 2px 5px var(--shadow-color-light);
        }

        .list-item-main {
            flex-grow: 1;
        }
        .list-item-main p {
            margin: 0;
        }
        .list-item-main .item-title {
            font-weight: 600;
            color: var(--text-dark);
        }
        .list-item-main .item-subtitle {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .list-item-actions {
            display: flex;
            gap: var(--space-sm);
        }

        .table-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
        }

        #orcamento-itens-table {
            width: 100%;
            border-collapse: collapse;
        }

        #orcamento-itens-table th, #orcamento-itens-table td {
            padding: var(--space-sm) var(--space-md);
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        #orcamento-itens-table thead.sticky-header {
            position: sticky;
            top: 0;
            background-color: var(--bg-tertiary);
            z-index: 10;
        }

        #orcamento-itens-table tbody tr:nth-child(even) {
            background-color: var(--bg-primary);
        }

        #orcamento-itens-table tbody tr:hover {
            background-color: var(--border-color);
        }

        /* 6. FORMULÁRIOS */
        form {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .form-group label {
            font-weight: 500;
            color: var(--text-muted);
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--border-color);
            background-color: var(--bg-primary);
            color: var(--text-light);
            font-family: var(--font-base);
            font-size: 1rem;
            transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-red);
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.3);
        }
        
        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .validation-message {
            font-size: 12px;
            color: var(--accent-orange);
            min-height: 14px;
            display: none; /* Hide by default */
        }
        .form-group.invalid .validation-message {
             display: block;
        }
        .form-group.invalid input, .form-group.invalid select, .form-group.invalid textarea, .form-group.invalid .toggle-buttons {
            border-color: var(--accent-orange);
        }
        .form-group.valid input, .form-group.valid select, .form-group.valid textarea, .form-group.valid .toggle-buttons {
            border-color: var(--accent-green);
        }
        .form-group .toggle-buttons {
            border: 1px solid transparent;
            padding: var(--space-sm);
            border-radius: var(--border-radius-sm);
        }

        .form-actions {
            display: flex;
            gap: var(--space-md);
            margin-top: var(--space-md);
        }

        .list-controls {
            display: flex;
            gap: var(--space-md);
            margin-bottom: var(--space-md);
        }
        .list-controls input, .list-controls select {
            flex-grow: 1;
        }

        /* 7. BOTÕES */
        .btn {
            padding: var(--space-sm) var(--space-lg);
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-family: var(--font-title);
            font-weight: 500;
            font-size: 1rem;
            transition: background-color var(--transition-fast), transform var(--transition-fast);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn-primary {
            background-color: var(--primary-red);
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: var(--primary-red-dark);
        }

        .btn-secondary {
            background-color: var(--bg-tertiary);
            color: var(--text-light);
            border: 1px solid var(--border-color);
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: var(--border-color);
        }

        .btn-danger {
            background-color: var(--danger-red);
            color: white;
        }
        .btn-danger:hover:not(:disabled) {
            background-color: var(--danger-red-dark);
        }

        .btn-success {
            background-color: var(--accent-green);
            color: white;
        }
        .btn-success:hover:not(:disabled) {
            background-color: #047857;
        }

        .btn-sm {
            padding: var(--space-xs) var(--space-sm);
            font-size: 0.8rem;
        }

        .btn-icon {
            padding: var(--space-sm);
        }

        /* Ripple effect */
        .ripple {
            position: absolute;
            border-radius: 50%;
            transform: scale(0);
            animation: ripple-effect 0.6s linear;
            background-color: rgba(255, 255, 255, 0.7);
        }

        @keyframes ripple-effect {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* Toggle Buttons */
        .toggle-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-sm);
        }
        .toggle-buttons button {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-muted);
        }
        .toggle-buttons button.active {
            background-color: var(--primary-red);
            color: white;
            border-color: var(--primary-red);
        }

        /* 8. MODAIS E PAINÉIS */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--backdrop-color);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s;
        }

        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1001;
            display: none; /* Hidden by default */
        }

        /* CORREÇÃO BUG 2: Z-INDEX DO MODAL DE CONFIRMAÇÃO */
        #confirmation-modal {
            z-index: 1005;
        }

        .modal-content {
            background-color: var(--bg-secondary);
            padding: var(--space-lg);
            border-radius: var(--border-radius-md);
            box-shadow: 0 5px 25px var(--shadow-color);
            width: 90vw;
            max-width: 500px;
            animation: slideInUp 0.4s ease-out;
            position: relative;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }
        .modal-body {
            overflow-y: auto;
        }

        .modal.large .modal-content {
            max-width: 800px;
        }
        
        .modal.xlarge .modal-content {
            max-width: 1100px;
        }

        .modal-close-btn {
            position: absolute;
            top: var(--space-md);
            right: var(--space-md);
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-muted);
            cursor: pointer;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: var(--space-md);
            margin-top: var(--space-lg);
            flex-shrink: 0;
        }

        .side-panel {
            position: fixed;
            top: 0;
            right: -100%; /* Start off-screen */
            width: 100%;
            max-width: 400px;
            height: 100%;
            background-color: var(--bg-secondary);
            box-shadow: -5px 0 25px var(--shadow-color);
            z-index: 1002;
            transition: right var(--transition-medium);
            padding: var(--space-lg);
            overflow-y: auto;
        }

        .side-panel.open {
            right: 0;
        }

        .panel-close-btn {
            position: absolute;
            top: var(--space-md);
            right: var(--space-md);
            background: none;
            border: none;
            font-size: 2rem;
            color: var(--text-muted);
            cursor: pointer;
        }

        /* 9. ELEMENTOS DIVERSOS */
        #back-to-top-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background-color: var(--primary-red);
            color: white;
            border-radius: 50%;
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 10px var(--shadow-color);
            transition: opacity var(--transition-medium), transform var(--transition-fast);
            z-index: 999;
        }

        #back-to-top-btn.show {
            display: flex;
            animation: fadeIn 0.3s;
        }

        #back-to-top-btn:hover {
            transform: scale(1.05) translateY(-2px);
        }

        /* Skeleton Loading */
        .skeleton-item {
            background-color: var(--skeleton-bg);
            border-radius: var(--border-radius-sm);
            position: relative;
            overflow: hidden;
        }

        .skeleton-item::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, var(--skeleton-highlight), transparent);
            animation: skeleton-loading 1.5s infinite;
        }

        @keyframes skeleton-loading {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Confetti */
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: var(--accent-blue);
            opacity: 0;
            animation: confetti-fall 3s ease-out forwards;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* Notification System */
        #notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .notification {
            padding: var(--space-md);
            border-radius: var(--border-radius-sm);
            color: white;
            box-shadow: 0 3px 10px var(--shadow-color);
            animation: slideInRight 0.4s ease-out;
            opacity: 0.9;
            min-width: 250px;
        }
        .notification.success { background-color: var(--accent-green); }
        .notification.error { background-color: var(--primary-red); }
        .notification.info { background-color: var(--accent-blue); }

        .notification-bell-container {
            position: relative;
        }

.notification-badge {
    position: absolute;
    top: -7px;
    right: -10px;
    background-color: var(--primary-red);
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    font-size: 0.8rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid var(--bg-secondary);
    animation: pulse-red 2s infinite;
}

        .notification-panel {
            position: fixed;
            top: 90px;
            right: 20px;
            background-color: var(--bg-tertiary);
            border-radius: var(--border-radius-md);
            box-shadow: 0 4px 15px var(--shadow-color);
            z-index: 1000;
            width: 350px;
            max-width: 90vw;
            max-height: 0;
            overflow: hidden;
            transition: max-height var(--transition-medium), opacity var(--transition-medium);
            opacity: 0;
        }

        .notification-panel.open {
            max-height: 400px;
            opacity: 1;
        }

        .notification-panel-header {
            padding: var(--space-sm) var(--space-md);
            font-family: var(--font-title);
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
        }

        #notification-list {
            padding: var(--space-sm);
            max-height: 340px;
        }
        #notification-list li {
            padding: var(--space-sm) var(--space-md);
        }
        #notification-list .list-item-main {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }
        #notification-list .list-item-main i {
            font-size: 1.2rem;
            color: var(--primary-red);
        }

        /* Sync Overlay */
        .sync-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--backdrop-color);
            z-index: 9999;
            display: none; /* Hidden by default */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            gap: var(--space-md);
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top-color: var(--primary-red);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* CRM Specific Styles */
        .crm-dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: var(--space-lg);
            margin-bottom: var(--space-lg);
            flex-wrap: wrap;
        }
        .crm-metrics-grid {
            display: flex;
            gap: var(--space-md);
            flex-grow: 1;
            flex-wrap: wrap;
        }
        .crm-metric-card {
            background: var(--bg-tertiary);
            padding: var(--space-md);
            border-radius: var(--border-radius-md);
            flex-grow: 1;
        }
        .crm-metric-card h4 {
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        .crm-metric-card p {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-dark);
        }
        .crm-actions {
            display: flex;
            gap: var(--space-md);
            align-self: center;
        }
        .kanban-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--space-lg);
        }
        .kanban-board {
            display: flex;
            gap: var(--space-md);
            overflow-x: auto;
            padding-bottom: var(--space-md);
        }
        .kanban-column {
            min-width: 280px;
            background-color: var(--bg-primary);
            border-radius: var(--border-radius-md);
            padding: var(--space-sm);
            flex: 1;
        }
        .kanban-column-header {
            padding: var(--space-sm) var(--space-md);
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: var(--space-md);
        }
        .kanban-cards {
            min-height: 200px;
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }
        .kanban-card {
            background-color: var(--bg-secondary);
            padding: var(--space-md);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            border-left: 3px solid var(--accent-blue);
        }
        .kanban-card.task-priority-alta { border-left-color: var(--danger-red); }
        .kanban-card.task-priority-média { border-left-color: var(--accent-orange); }
        .kanban-card.task-priority-baixa { border-left-color: var(--accent-blue); }
        .kanban-card.dragging {
            opacity: 0.5;
            transform: scale(1.05);
            box-shadow: 0 5px 15px var(--shadow-color);
        }
        .kanban-card p {
            margin: 0;
        }
        .kanban-card .card-title {
            font-weight: 600;
        }
        .kanban-card .card-subtitle {
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        #crm-bulk-clients-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-sm);
        }
        #crm-bulk-clients-list li {
            padding: var(--space-sm);
            background-color: var(--bg-primary);
            border-radius: var(--border-radius-sm);
            border-left: 3px solid var(--border-color);
        }
        #crm-bulk-clients-list li label {
            display: flex; 
            align-items: flex-start; 
            gap: 8px; 
            width: 100%;
            cursor: pointer;
        }
        #crm-campaign-control-panel {
            text-align: center;
        }
        #crm-campaign-progress {
            font-size: 1.2rem;
            margin-bottom: var(--space-md);
        }

        /* Template Editor Styles */
        .template-category {
            margin-bottom: var(--space-lg);
            padding: var(--space-md);
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--border-color);
        }
        .template-editor-item {
            background-color: var(--bg-primary);
            padding: var(--space-md);
            border-radius: var(--border-radius-sm);
            margin-bottom: var(--space-md);
        }
        .template-editor-item .form-group {
            gap: var(--space-xs);
        }
        .template-editor-item label {
            font-size: 0.8rem;
        }
        .template-editor-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: var(--space-sm);
        }

        /* Agenda Styles */
        .agenda-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-lg);
            flex-wrap: wrap;
            gap: var(--space-md);
        }
        .agenda-nav {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }
        .agenda-nav input {
            padding: var(--space-sm);
            border: 1px solid var(--border-color);
            background-color: var(--bg-primary);
            color: var(--text-light);
            border-radius: var(--border-radius-sm);
        }
        .agenda-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--space-lg);
        }
        .agenda-card {
            background-color: var(--bg-tertiary);
            border-radius: var(--border-radius-sm);
            padding: var(--space-md);
            border-left: 5px solid var(--primary-red);
            cursor: pointer;
            transition: box-shadow var(--transition-fast), transform var(--transition-fast);
        }
        .agenda-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 10px var(--shadow-color-light);
        }
        .agenda-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-sm);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: var(--space-sm);
        }
        .agenda-card-time {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: var(--font-title);
            color: var(--text-dark);
        }
        .agenda-card-body p {
            margin: 0 0 var(--space-xs) 0;
        }
        .agenda-card-body .client-name {
            font-weight: 600;
            color: var(--text-light);
            font-size: 1.1rem;
        }
        .agenda-card-body .services {
            color: var(--text-muted);
            font-style: italic;
        }
        .agenda-card.status-agendado { border-left-color: var(--primary-red); }
        .agenda-card.status-confirmado { border-left-color: var(--accent-blue); }
        .agenda-card.status-finalizado { border-left-color: var(--accent-green); }
        
        .no-agenda-message {
            text-align: center;
            padding: var(--space-xl);
            color: var(--text-muted);
            grid-column: 1 / -1; /* Ocupa toda a largura do grid */
        }


        /* 10. ANIMAÇÕES */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes slideInUp {
            from { transform: translate(-50%, -45%); opacity: 0; }
            to { transform: translate(-50%, -50%); opacity: 1; }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(120%); opacity: 0; }
        }

        /* CORREÇÃO BUG 1: Animação para o sino de notificação */
        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            70% {
                box-shadow: 0 0 0 8px rgba(239, 68, 68, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }
        
        /* Accordion Styles */
        .accordion .accordion-item {
            border-bottom: 1px solid var(--border-color);
        }
        .accordion .accordion-header {
            width: 100%;
            background: none;
            border: none;
            text-align: left;
            padding: var(--space-md);
            cursor: pointer;
            color: var(--text-light);
            font-size: 1.1rem;
            font-family: var(--font-title);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .accordion .accordion-header i {
            transition: transform 0.3s ease;
        }
        .accordion .accordion-item.active .accordion-header i {
            transform: rotate(180deg);
        }
        .accordion .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            padding: 0 var(--space-md);
        }
        .accordion .accordion-content-inner {
            padding: var(--space-md) 0;
        }
        
        /* Ace Editor Style */
        .ace_editor {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            height: 200px;
            width: 100%;
        }
        
        /* Config Specific Styles */
        .color-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-lg);
        }
        .color-picker-group {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }
        .color-picker-group input[type="color"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 40px;
            height: 40px;
            padding: 0;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            background-color: transparent;
        }
        .color-picker-group input[type="color"]::-webkit-color-swatch {
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--border-color);
        }
        .color-picker-group input[type="color"]::-moz-color-swatch {
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--border-color);
        }
        .color-picker-group label {
            font-weight: 500;
            color: var(--text-muted);
        }

        /* Fluxo de Caixa Styles */
        .fluxo-caixa-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-lg);
            margin-bottom: var(--space-lg);
        }
        .fluxo-caixa-stat-card {
            background: var(--bg-tertiary);
            padding: var(--space-md);
            border-radius: var(--border-radius-md);
        }
        .fluxo-caixa-stat-card h4 {
            color: var(--text-muted);
            font-size: 1rem;
            margin-bottom: var(--space-sm);
        }
        .fluxo-caixa-stat-card p {
            font-size: 2rem;
            font-weight: 700;
        }
        .fluxo-caixa-stat-card .receitas { color: var(--accent-green); }
        .fluxo-caixa-stat-card .despesas { color: var(--primary-red); }
        .fluxo-caixa-stat-card .lucro { color: var(--accent-blue); }

        /* 11. RESPONSIVIDADE */
        @media (max-width: 768px) {
            body {
                padding: 0;
            }
            .app-container {
                border-radius: 0;
                padding: var(--space-md);
                min-height: 100vh;
            }
            .app-header {
                flex-wrap: wrap;
                gap: var(--space-sm);
            }
            .app-header h1 {
                font-size: 1.2rem;
            }
            .grid-layout.two-cols {
                grid-template-columns: 1fr;
            }
            .list-controls {
                flex-direction: column;
            }
            .modal-content {
                width: 95vw;
            }
        }

        @media (max-width: 600px) {
            .header-actions .sync-text {
                display: none;
            }
            #sync-button {
                width: 48px;
                height: 48px;
            }
            .form-actions {
                flex-direction: column;
            }
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="header-left-section">
                <div class="logo-container">
                    <img id="header-logo" src="https://placehold.co/100x100/1E1E1E/E8EAED?text=RM" alt="Logo da Empresa" class="header-logo">
                </div>
                <div>
                    <h1 id="header-title">R.M. Estética Automotiva</h1>
                    <span class="pro-plus">PRO+</span>
                </div>
            </div>
            <div class="header-actions">
                <button id="sync-button" class="btn btn-icon" aria-label="Sincronizar dados">
                    <i class="fas fa-sync-alt"></i>
                    <span class="sync-text">Sincronizar</span>
                </button>
                <div id="notification-bell-container" class="notification-bell-container">
    <button id="notification-bell-btn" class="btn btn-icon" aria-label="Abrir notificações">
        <i class="fas fa-bell"></i>
    </button>
    <span id="notification-badge" class="notification-badge" style="display: none;">0</span>
    <div id="notification-panel" class="notification-panel">
                        <div class="notification-panel-header">Notificações do Dia</div>
                        <ul id="notification-list" class="data-list">
                        </ul>
                    </div>
                </div>
                <button id="hamburger-menu" aria-label="Abrir menu" aria-expanded="false">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </header>

        <nav id="main-nav">
            <ul>
                <li><a href="#" class="nav-link" data-tab="dashboard-tab"><i class="fas fa-chart-line"></i><span>Dashboard</span></a></li>
                <li><a href="#" class="nav-link" data-tab="agenda-tab"><i class="fas fa-calendar-alt"></i><span>Agenda</span></a></li>
                <li><a href="#" class="nav-link" data-tab="clientes-tab"><i class="fas fa-users"></i><span>Clientes</span></a></li>
                <li><a href="#" class="nav-link" data-tab="servicos-tab"><i class="fas fa-spray-can-sparkles"></i><span>Serviços</span></a></li>
                <li><a href="#" class="nav-link" data-tab="orcamento-tab"><i class="fas fa-file-invoice-dollar"></i><span>Novo Orçamento</span></a></li>
                <li><a href="#" class="nav-link" data-tab="historico-tab"><i class="fas fa-history"></i><span>Histórico</span></a></li>
                <li><a href="#" class="nav-link" data-tab="crm-tab"><i class="fas fa-headset"></i><span>CRM</span></a></li>
                <li><a href="#" class="nav-link" data-tab="fluxo-caixa-tab"><i class="fas fa-wallet"></i><span>Fluxo de Caixa</span></a></li>
                <li><a href="#" class="nav-link" data-tab="configuracoes-tab"><i class="fas fa-cogs"></i><span>Configurações</span></a></li>
            </ul>
        </nav>

        <main id="main-content">
            <section id="dashboard-tab" class="tab-content active">
                <div class="card" style="margin-bottom: var(--space-lg);">
                    <div class="filters-bar" style="display: flex; flex-wrap: wrap; gap: var(--space-md); align-items: center;">
                        <div class="form-group" style="flex-grow: 1;"><label for="dashboard-data-inicio">Data de Início</label><input type="date" id="dashboard-data-inicio"></div>
                        <div class="form-group" style="flex-grow: 1;"><label for="dashboard-data-fim">Data de Fim</label><input type="date" id="dashboard-data-fim"></div>
                        <button id="dashboard-filter-btn" class="btn btn-primary">Filtrar</button>
                        <button id="dashboard-clear-filter-btn" class="btn btn-secondary">Limpar</button>
                    </div>
                </div>

                <div class="dashboard-main-grid">
                    <div class="card metrics-grid">
                        <div class="stat-card" id="stat-novos-clientes-card"><i class="fas fa-user-plus"></i><div><h3>Novos Clientes (Período)</h3><p id="stat-novos-clientes">0</p></div></div>
                        <div class="stat-card" id="stat-recorrentes-card"><i class="fas fa-sync-alt"></i><div><h3>Clientes Recorrentes</h3><p id="stat-recorrentes">0</p></div></div>
                        <div class="stat-card" id="stat-finalizados-card"><i class="fas fa-calendar-check"></i><div><h3>Finalizados (Período)</h3><p id="stat-finalizados">0</p></div></div>
                        <div class="stat-card" id="stat-faturamento-card"><i class="fas fa-dollar-sign"></i><div><h3>Faturamento (Período)</h3><p id="stat-faturamento">R$ 0,00</p></div></div>
                    </div>
                    <div class="card chart-container">
                        <h3>📊 Receitas vs. Despesas (Mensal)</h3>
                        <canvas id="monthlyStatsChart"></canvas>
                    </div>
                    <div class="card recent-activity-container">
                        <h3>⚡ Atividades Recentes</h3>
                        <ul id="recent-activity-list" class="data-list">
                            <li class="skeleton-item" style="height: 50px;"></li>
                            <li class="skeleton-item" style="height: 50px;"></li>
                            <li class="skeleton-item" style="height: 50px;"></li>
                        </ul>
                    </div>
                    <div class="card top-services-container">
                        <h3>🏆 Serviços Mais Rentáveis (Período)</h3>
                        <ul id="top-services-list" class="data-list">
                            <li class="skeleton-item" style="height: 40px;"></li>
                            <li class="skeleton-item" style="height: 40px;"></li>
                            <li class="skeleton-item" style="height: 40px;"></li>
                        </ul>
                    </div>
                </div>
            </section>
            
            <section id="agenda-tab" class="tab-content">
                <div class="card">
                    <div class="agenda-header">
                        <div class="agenda-nav">
                            <button id="prev-day-btn" class="btn btn-secondary btn-icon"><i class="fas fa-chevron-left"></i></button>
                            <input type="date" id="agenda-date-picker">
                            <button id="next-day-btn" class="btn btn-secondary btn-icon"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <button id="add-agendamento-btn" class="btn btn-primary"><i class="fas fa-plus"></i> Novo Agendamento</button>
                    </div>
                    <div id="agenda-grid-container" class="agenda-cards-container">
                    </div>
                </div>
            </section>

            <section id="clientes-tab" class="tab-content">
                <div class="grid-layout two-cols">
                    <div class="card">
                        <h2 id="cliente-form-title">👤 Adicionar Novo Cliente</h2>
                        <form id="cliente-form" novalidate>
                            <input type="hidden" id="cliente-id">
                            <div class="form-group">
                                <label for="cliente-nome">Nome*</label>
                                <input type="text" id="cliente-nome" required minlength="3">
                                <span class="validation-message">O nome deve ter pelo menos 3 caracteres.</span>
                            </div>
                            <div class="form-group">
                                <label for="cliente-telefone">Telefone* 📞</label>
                                <input type="tel" id="cliente-telefone" placeholder="(XX) XXXXX-XXXX" required>
                                <span class="validation-message">Formato de telefone inválido. Use (XX) XXXXX-XXXX.</span>
                            </div>
                            <div class="form-group">
                                <label for="cliente-carro">Carro 🚗</label>
                                <input type="text" id="cliente-carro">
                            </div>
                            <div class="form-group">
                                <label for="cliente-placa">Placa* 🪪</label>
                                <input type="text" id="cliente-placa" placeholder="ABC1234 ou ABC1D23" required>
                                <span class="validation-message">Formato de placa inválido (Mercosul ou antiga).</span>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Salvar</button>
                                <button type="button" id="cancel-edit-cliente-btn" class="btn btn-secondary" style="display: none;"><i class="fas fa-times"></i> Cancelar</button>
                            </div>
                        </form>
                    </div>
                    <div class="card">
                        <h2>👥 Lista de Clientes</h2>
                        <div class="list-controls">
                            <input type="search" id="search-cliente" placeholder="Buscar por nome, placa...">
                            <select id="sort-cliente">
                                <option value="nome-asc">Nome (A-Z)</option>
                                <option value="nome-desc">Nome (Z-A)</option>
                                <option value="recentes">Mais Recentes</option>
                            </select>
                        </div>
                        <ul id="clientes-lista" class="data-list">
                           <li class="skeleton-item" style="height: 60px;"></li>
                           <li class="skeleton-item" style="height: 60px;"></li>
                        </ul>
                    </div>
                </div>
            </section>

            <section id="servicos-tab" class="tab-content">
                 <div class="grid-layout two-cols">
                    <div class="card">
                        <h2 id="servico-form-title">✨ Adicionar Novo Serviço</h2>
                        <form id="servico-form" novalidate>
                            <input type="hidden" id="servico-id">
                            <div class="form-group">
                                <label for="servico-descricao">Descrição*</label>
                                <input type="text" id="servico-descricao" required>
                                <span class="validation-message">A descrição é obrigatória.</span>
                            </div>
                            <div class="form-group">
                                <label for="servico-valor">Valor (R$)*</label>
                                <input type="number" id="servico-valor" step="0.01" min="0.01" required>
                                <span class="validation-message">O valor deve ser maior que zero.</span>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Salvar</button>
                                <button type="button" id="cancel-edit-servico-btn" class="btn btn-secondary" style="display: none;"><i class="fas fa-times"></i> Cancelar</button>
                            </div>
                        </form>
                    </div>
                    <div class="card">
                        <h2>📋 Lista de Serviços</h2>
                         <div class="list-controls">
                            <input type="search" id="search-servico" placeholder="Buscar por descrição...">
                            <select id="sort-servico">
                                <option value="descricao-asc">Descrição (A-Z)</option>
                                <option value="valor-asc">Valor (Menor)</option>
                                <option value="valor-desc">Valor (Maior)</option>
                            </select>
                        </div>
                        <ul id="servicos-lista" class="data-list">
                           <li class="skeleton-item" style="height: 60px;"></li>
                        </ul>
                    </div>
                </div>
            </section>

            <section id="orcamento-tab" class="tab-content">
                <div class="card">
                    <h2>💸 Gerar Novo Orçamento</h2>
                    <form id="orcamento-form" novalidate>
                        <div class="form-group">
                            <label for="orcamento-cliente">Cliente*</label>
                            <select id="orcamento-cliente" required></select>
                        </div>
                        <hr>
                        <h3>Adicionar Serviços</h3>
                        <div class="add-servico-grid" style="display: grid; grid-template-columns: 1fr auto auto; gap: 16px; align-items: end;">
                            <div class="form-group">
                                <label for="orcamento-servico-select">Serviço</label>
                                <select id="orcamento-servico-select"></select>
                            </div>
                             <div class="form-group">
                                <label for="orcamento-servico-qtd">Quantidade</label>
                                <input type="number" id="orcamento-servico-qtd" value="1" min="1" style="width: 80px;">
                            </div>
                            <button type="button" id="add-servico-btn" class="btn btn-secondary"><i class="fas fa-plus"></i> Adicionar</button>
                        </div>
                        <div class="table-container">
                            <table id="orcamento-itens-table">
                                <thead class="sticky-header">
                                    <tr>
                                        <th>Serviço</th>
                                        <th>Qtde</th>
                                        <th>Valor Unit.</th>
                                        <th>Subtotal</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="orcamento-servicos-adicionados">
                                     </tbody>
                            </table>
                        </div>
                        <div class="orcamento-total-container" style="display: flex; justify-content: space-between; align-items: center; margin-top: 16px;">
                            <div class="form-group">
                                <label for="orcamento-desconto-percentual">Desconto (%)</label>
                                <input type="number" id="orcamento-desconto-percentual" value="0" min="0" max="100" step="1">
                            </div>
                            <div id="orcamento-total-badge" style="background-color: var(--accent-green); color: white; padding: 8px 16px; border-radius: 6px; font-weight: bold; text-align: right;">
                                Total: <span id="orcamento-total">R$ 0,00</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Forma(s) de Pagamento*</label>
                            <div id="payment-method-toggles" class="toggle-buttons">
                                <button type="button" data-value="Pix"><i class="fas fa-qrcode"></i> Pix</button>
                                <button type="button" data-value="Dinheiro"><i class="fas fa-money-bill-wave"></i> Dinheiro</button>
                                <button type="button" data-value="Crédito"><i class="fas fa-credit-card"></i> Crédito</button>
                                <button type="button" data-value="Débito"><i class="far fa-credit-card"></i> Débito</button>
                                <button type="button" data-value="Boleto"><i class="fas fa-barcode"></i> Boleto</button>
                            </div>
                            <span class="validation-message">Pelo menos uma forma de pagamento deve ser selecionada.</span>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Salvar Orçamento</button>
                            <button type="button" id="cancel-orcamento-btn" class="btn btn-secondary"><i class="fas fa-times"></i> Limpar</button>
                        </div>
                    </form>
                </div>
            </section>

            <section id="historico-tab" class="tab-content">
                <div class="card">
                    <h2>📚 Histórico de Orçamentos</h2>
                    <div class="filters-bar sticky-header" style="display: flex; flex-wrap: wrap; gap: 16px; padding: 16px; background: var(--bg-secondary); margin: -16px -16px 16px -16px; border-bottom: 1px solid var(--border-color);">
                        <input type="search" id="historico-search" placeholder="Buscar cliente, serviço..." style="flex-grow: 1;">
                        <select id="historico-status-filter">
                            <option value="">Todos Status</option>
                            <option value="Pendente">Pendente</option>
                            <option value="Aprovado">Aprovado</option>
                            <option value="Finalizado">Finalizado</option>
                            <option value="Pago">Pago</option>
                            <option value="Cancelado">Cancelado</option>
                        </select>
                        <input type="date" id="historico-data-inicio">
                        <input type="date" id="historico-data-fim">
                        <button id="historico-limpar-filtros" class="btn btn-secondary btn-sm"><i class="fas fa-eraser"></i></button>
                    </div>
                    <ul id="historico-lista" class="data-list">
                        <li class="skeleton-item" style="height: 60px;"></li>
                        <li class="skeleton-item" style="height: 60px;"></li>
                        <li class="skeleton-item" style="height: 60px;"></li>
                    </ul>
                </div>
            </section>
            
            <section id="crm-tab" class="tab-content">
                <div class="crm-dashboard-header">
                    <div class="crm-metrics-grid">
                        <div class="crm-metric-card">
                            <h4>Oportunidades em Aberto</h4>
                            <p id="crm-metric-oportunidades">R$ 0,00</p>
                        </div>
                        <div class="crm-metric-card">
                            <h4>Taxa de Conversão (Mês)</h4>
                            <p id="crm-metric-conversao">0%</p>
                        </div>
                        <div class="crm-metric-card">
                            <h4>Tarefas Pendentes</h4>
                            <p id="crm-metric-tarefas">0</p>
                        </div>
                    </div>
                    <div class="crm-actions">
                       <button id="create-task-btn" class="btn btn-primary"><i class="fas fa-plus"></i> Criar Nova Tarefa</button>
                    </div>
                </div>
                <div class="kanban-container">
                    <div class="card">
                        <h3>Quadro de Follow-ups (Tarefas)</h3>
                        <div class="kanban-board" id="tasks-board">
                        </div>
                    </div>
                </div>
                 <div class="card" style="margin-top: var(--space-lg);">
                    <h3><i class="fas fa-bullhorn"></i> Ferramentas de Relacionamento</h3>
                    <div class="grid-layout two-cols" style="margin-top: var(--space-md);">
                        <form id="crm-form" novalidate>
                              <h4>📞 Registrar Interação</h4>
                            <div class="form-group">
                                <label for="crm-cliente-select">Cliente*</label>
                                <select id="crm-cliente-select" required></select>
                            </div>
                            <div class="form-group">
                                <label for="crm-tipo-interacao">Tipo de Interação*</label>
                                <select id="crm-tipo-interacao" required>
                                    <option value="WhatsApp">WhatsApp</option>
                                    <option value="Chamada">Chamada</option>
                                    <option value="Visita">Visita</option>
                                    <option value="Email">Email</option>
                                    <option value="Outro">Outro</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="crm-descricao">Descrição</label>
                                <textarea id="crm-descricao"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="crm-proxima-acao">Data da Próxima Ação (Follow-up)</label>
                                <input type="date" id="crm-proxima-acao">
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> Registrar</button>
                            </div>
                        </form>
                        <div>
                            <h4>🎯 Campanhas e Reativação</h4>
                            <p class="text-muted">Filtre clientes ou crie uma campanha em massa.</p>
                            <div class="toggle-buttons" id="crm-segment-buttons" style="margin-top: 16px;">
                                <button class="btn btn-sm btn-secondary active" data-filter="all">Todos os Clientes</button>
                                <button class="btn btn-sm btn-secondary" data-min-days="15" data-max-days="29">15-29 dias</button>
                                <button class="btn btn-sm btn-secondary" data-min-days="30" data-max-days="59">30-59 dias</button>
                                <button class="btn btn-sm btn-secondary" data-min-days="60" data-max-days="89">60-89 dias</button>
                                <button class="btn btn-sm btn-secondary" data-min-days="90">90+ dias</button>
                            </div>
                            <ul id="crm-inactive-clients-list" class="data-list" style="margin-top: 16px; max-height: 150px;">
                                <li>Selecione um filtro para ver os clientes.</li>
                            </ul>
                            <button id="crm-bulk-message-btn" class="btn btn-primary" style="width: 100%; margin-top: var(--space-md);"><i class="fab fa-whatsapp"></i> Criar Campanha em Massa</button>
                        </div>
                    </div>
                </div>
            </section>

            <section id="fluxo-caixa-tab" class="tab-content">
                <div class="card">
                    <h2>💰 Relatório de Fluxo de Caixa</h2>
                    <div class="filters-bar" style="display: flex; flex-wrap: wrap; gap: 16px; padding-bottom: 24px;">
                        <div class="form-group" style="flex-grow: 1;"><label for="fluxo-caixa-data-inicio">Data de Início</label><input type="date" id="fluxo-caixa-data-inicio"></div>
                        <div class="form-group" style="flex-grow: 1;"><label for="fluxo-caixa-data-fim">Data de Fim</label><input type="date" id="fluxo-caixa-data-fim"></div>
                    </div>
                    <div class="fluxo-caixa-stats">
                        <div class="fluxo-caixa-stat-card"><h4 class="receitas"><i class="fas fa-arrow-up"></i> Receitas</h4><p id="fluxo-caixa-receitas" class="receitas">R$ 0,00</p></div>
                        <div class="fluxo-caixa-stat-card"><h4 class="despesas"><i class="fas fa-arrow-down"></i> Despesas</h4><p id="fluxo-caixa-despesas" class="despesas">R$ 0,00</p></div>
                        <div class="fluxo-caixa-stat-card"><h4 class="lucro"><i class="fas fa-equals"></i> Lucro Líquido</h4><p id="fluxo-caixa-lucro" class="lucro">R$ 0,00</p></div>
                    </div>
                </div>
                <div class="grid-layout two-cols" style="margin-top: var(--space-lg);">
                    <div class="card">
                        <h3><i class="fas fa-plus-circle"></i> Adicionar Nova Despesa</h3>
                        <form id="despesa-form" novalidate>
                            <input type="hidden" id="despesa-id">
                            <div class="form-group">
                                <label for="despesa-descricao">Descrição*</label>
                                <input type="text" id="despesa-descricao" required>
                            </div>
                            <div class="form-group">
                                <label for="despesa-valor">Valor (R$)*</label>
                                <input type="number" id="despesa-valor" step="0.01" min="0.01" required>
                            </div>
                            <div class="form-group">
                                <label for="despesa-data">Data da Despesa*</label>
                                <input type="date" id="despesa-data" required>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Salvar Despesa</button>
                            </div>
                        </form>
                    </div>
                    <div class="card">
                        <h3><i class="fas fa-receipt"></i> Despesas Recentes (Período)</h3>
                        <ul id="despesas-lista" class="data-list">
                            <li class="skeleton-item" style="height: 50px;"></li>
                        </ul>
                    </div>
                </div>
            </section>

            <section id="configuracoes-tab" class="tab-content">
                <div class="card">
                    <h2>⚙️ Configurações</h2>
                    <div class="accordion">
                        <div class="accordion-item">
                            <button class="accordion-header">
                                <span><i class="fas fa-store"></i> Dados do Estabelecimento</span>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="accordion-content">
                                <div class="accordion-content-inner">
                                    <form id="config-empresa-form">
                                        <div class="form-group"><label for="config-nome">Nome da Empresa</label><input type="text" id="config-nome"></div>
                                        <div class="form-group"><label for="config-cnpj">CNPJ</label><input type="text" id="config-cnpj"></div>
                                        <div class="form-group"><label for="config-telefone">Telefone</label><input type="text" id="config-telefone"></div>
                                        <div class="form-group"><label for="config-endereco">Endereço</label><input type="text" id="config-endereco"></div>
                                        <div class="form-group"><label for="config-catalogo-link">Link do Catálogo (Opcional)</label><input type="url" id="config-catalogo-link" placeholder="https://seusite.com/catalogo"></div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <button class="accordion-header">
                                <span><i class="fas fa-palette"></i> Personalização Visual</span>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="accordion-content">
                                <div class="accordion-content-inner">
                                    <div class="form-group" style="flex-direction: row; align-items: center; justify-content: space-between;">
                                        <label>Tema (Claro/Escuro)</label>
                                        <button id="theme-toggle" class="btn btn-secondary"><i class="fas fa-moon"></i></button>
                                    </div>
                                    <hr style="border-color: var(--border-color); margin: var(--space-md) 0;">
                                    <h4>Cores de Destaque</h4>
                                    <div class="color-grid">
                                        <div class="color-picker-group"><input type="color" id="config-color-primary" data-color-var="--primary-red"><label for="config-color-primary">Primária</label></div>
                                        <div class="color-picker-group"><input type="color" id="config-color-success" data-color-var="--accent-green"><label for="config-color-success">Sucesso</label></div>
                                        <div class="color-picker-group"><input type="color" id="config-color-warning" data-color-var="--accent-orange"><label for="config-color-warning">Aviso</label></div>
                                        <div class="color-picker-group"><input type="color" id="config-color-info" data-color-var="--accent-blue"><label for="config-color-info">Informação</label></div>
                                    </div>
                                    <hr style="border-color: var(--border-color); margin: var(--space-md) 0;">
                                    <h4>Tema Escuro</h4>
                                    <div class="color-grid">
                                        <div class="color-picker-group"><input type="color" id="config-color-dark-bg-primary" data-color-var="--dark-bg-primary"><label>Fundo Primário</label></div>
                                        <div class="color-picker-group"><input type="color" id="config-color-dark-bg-secondary" data-color-var="--dark-bg-secondary"><label>Fundo Secundário</label></div>
                                        <div class="color-picker-group"><input type="color" id="config-color-dark-text-light" data-color-var="--dark-text-light"><label>Texto Principal</label></div>
                                        <div class="color-picker-group"><input type="color" id="config-color-dark-text-dark" data-color-var="--dark-text-dark"><label>Texto (Títulos)</label></div>
                                    </div>
                                    <hr style="border-color: var(--border-color); margin: var(--space-md) 0;">
                                    <h4>Tema Claro</h4>
                                    <div class="color-grid">
                                        <div class="color-picker-group"><input type="color" id="config-color-light-bg-primary" data-color-var="--light-bg-primary"><label>Fundo Primário</label></div>
                                        <div class="color-picker-group"><input type="color" id="config-color-light-bg-secondary" data-color-var="--light-bg-secondary"><label>Fundo Secundário</label></div>
                                        <div class="color-picker-group"><input type="color" id="config-color-light-text-light" data-color-var="--light-text-light"><label>Texto Principal</label></div>
                                        <div class="color-picker-group"><input type="color" id="config-color-light-text-dark" data-color-var="--light-text-dark"><label>Texto (Títulos)</label></div>
                                    </div>
                                    <button id="reset-colors-btn" class="btn btn-secondary btn-sm" style="margin-top: var(--space-lg);"><i class="fas fa-undo"></i> Restaurar Cores Padrão</button>
                                </div>
                            </div>
                        </div>
                         <div class="accordion-item">
                            <button class="accordion-header">
                                <span><i class="fas fa-image"></i> Plano de Fundo & Logo</span>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="accordion-content">
                                <div class="accordion-content-inner">
                                    <div class="form-group">
                                        <label for="config-logo-upload">Carregar nova logo</label>
                                        <input type="file" id="config-logo-upload" accept="image/*">
                                        <p class="text-muted" style="font-size: 0.8rem;">Preview:</p>
                                        <img id="config-logo-preview" src="" alt="Preview da Logo" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid var(--border-color); padding: 3px;">
                                    </div>
                                    <div class="form-group">
                                        <label for="config-watermark-toggle">Usar logo como marca d'água</label>
                                        <input type="checkbox" id="config-watermark-toggle">
                                    </div>
                                    <hr style="border-color: var(--border-color); margin: var(--space-md) 0;">
                                    <div class="form-group">
                                        <label for="config-bg-image-upload">Carregar imagem de fundo</label>
                                        <input type="file" id="config-bg-image-upload" accept="image/*">
                                    </div>
                                    <div class="form-group">
                                        <label for="config-bg-image-opacity">Opacidade do fundo</label>
                                        <input type="range" id="config-bg-image-opacity" min="0" max="1" step="0.05">
                                    </div>
                                    <button id="remove-bg-image-btn" class="btn btn-danger btn-sm"><i class="fas fa-trash"></i> Remover Imagem de Fundo</button>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                             <button class="accordion-header">
                                <span><i class="fas fa-file-alt"></i> Templates de Documentos</span>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="accordion-content">
                                <div class="accordion-content-inner">
                                    <div class="form-group">
                                        <label for="config-template-orcamento">📄 Template do Orçamento</label>
                                        <div id="config-template-orcamento"></div>
                                    </div>
                                    <div class="form-group">
                                        <label for="config-template-recibo">🧾 Template do Recibo (Cupom)</label>
                                        <div id="config-template-recibo"></div>
                                    </div>
                                    <p class="text-muted" style="font-size: 0.8rem; line-height: 1.5;">
                                        <b>Gabarito de Variáveis:</b><br>
                                        {{NOME_EMPRESA}}, {{CNPJ_EMPRESA}}, {{TELEFONE_EMPRESA}}, {{ENDERECO_EMPRESA}}, {{LINK_CATALOGO}}, {{CLIENTE_NOME}}, {{CLIENTE_TELEFONE}}, {{CLIENTE_CARRO}}, {{CLIENTE_PLACA}}, {{DATA}}, {{LISTA_SERVICOS}}, {{SUBTOTAL}}, {{DESCONTO}}, {{TOTAL}}, {{METODOS_PAGAMENTO}}, {{AGRADECIMENTO_CLIENTE}}
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                             <button class="accordion-header">
                                <span><i class="fas fa-comment-dots"></i> Templates de Mensagens CRM</span>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="accordion-content">
                                <div class="accordion-content-inner" id="crm-templates-editor-container">
                                     </div>
                            </div>
                        </div>
                         <div class="accordion-item">
                             <button class="accordion-header">
                                <span><i class="fas fa-database"></i> Backup & Restore</span>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="accordion-content">
                                <div class="accordion-content-inner" style="display: flex; gap: 16px;">
                                    <button id="export-data-btn" class="btn btn-secondary"><i class="fas fa-file-export"></i> Exportar Dados</button>
                                    <label for="import-data-input" class="btn btn-secondary"><i class="fas fa-file-import"></i> Importar Dados</label>
                                    <input type="file" id="import-data-input" accept=".json" style="display: none;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <div id="modal-overlay" class="modal-overlay"></div>

    <div id="confirmation-modal" class="modal">
        <div class="modal-content">
            <h3 id="confirmation-title">Confirmar Ação</h3>
            <p id="confirmation-message">Você tem certeza que deseja realizar esta ação?</p>
            <div class="modal-actions">
                <button id="confirm-btn" class="btn btn-danger">Confirmar</button>
                <button id="cancel-btn" class="btn btn-secondary">Cancelar</button>
            </div>
        </div>
    </div>
    
    <div id="create-task-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close-btn">&times;</button>
            <h3 id="create-task-form-title">Criar Nova Tarefa</h3>
            <form id="create-task-form" novalidate>
                <input type="hidden" id="task-id">
                <div class="form-group">
                    <label for="task-titulo">Título*</label>
                    <input type="text" id="task-titulo" required>
                </div>
                <div class="form-group">
                    <label for="task-cliente">Associar ao Cliente (Opcional)</label>
                    <select id="task-cliente"></select>
                </div>
                 <div class="form-group">
                    <label for="task-data-vencimento">Data de Vencimento</label>
                    <input type="date" id="task-data-vencimento">
                </div>
                <div class="form-group">
                    <label for="task-prioridade">Prioridade</label>
                    <select id="task-prioridade">
                        <option value="Baixa">Baixa</option>
                        <option value="Média" selected>Média</option>
                        <option value="Alta">Alta</option>
                    </select>
                </div>
                 <div class="form-group">
                    <label for="task-descricao">Descrição</label>
                    <textarea id="task-descricao" rows="3"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" id="delete-task-btn" class="btn btn-danger" style="display: none; margin-right: auto;">Excluir</button>
                    <button type="submit" class="btn btn-primary">Salvar Tarefa</button>
                </div>
            </form>
        </div>
    </div>

    <div id="orcamento-details-modal" class="modal large">
        <div class="modal-content">
            <button class="modal-close-btn">&times;</button>
            <h3 id="orcamento-details-title">Detalhes do Orçamento</h3>
            <div class="modal-body">
                <div class="details-view-switcher" style="margin-bottom: 16px;">
                    <button class="btn btn-sm active" data-view="orcamento">Orçamento</button>
                    <button class="btn btn-sm" data-view="recibo">Recibo</button>
                </div>
                <div id="orcamento-view">
                    <pre id="detalhes-orcamento-texto" class="code-preview" style="background: var(--bg-primary); padding: 16px; border-radius: 6px; white-space: pre-wrap; font-family: monospace;"></pre>
                </div>
                <div id="recibo-view" style="display:none;">
                    <pre id="detalhes-recibo-texto" class="code-preview" style="background: var(--bg-primary); padding: 16px; border-radius: 6px; white-space: pre-wrap; font-family: monospace;"></pre>
                </div>
            </div>
            <div class="modal-actions">
                <button id="copy-orcamento-btn" class="btn btn-secondary"><i class="fas fa-copy"></i> Copiar</button>
                <button id="whatsapp-orcamento-btn" class="btn btn-success"><i class="fab fa-whatsapp"></i> WhatsApp</button>
                <button id="pdf-orcamento-btn" class="btn btn-primary"><i class="fas fa-file-pdf"></i> Gerar PDF</button>
            </div>
             <div id="orcamento-status-actions" class="status-actions" style="margin-top: 16px; border-top: 1px solid var(--border-color); padding-top: 16px; display: flex; flex-wrap: wrap; gap: 8px;">
            </div>
        </div>
    </div>
    
    <aside id="client-details-panel" class="side-panel">
        <button class="panel-close-btn">&times;</button>
        <div class="panel-content">
            </div>
    </aside>

    <div id="crm-bulk-modal" class="modal large">
        <div class="modal-content">
            <button class="modal-close-btn">&times;</button>
            <h3>📢 Campanha em Massa via WhatsApp</h3>
            <div id="crm-campaign-setup" class="modal-body">
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="crm-bulk-select-all"> Selecionar Todos
                    </label>
                    <ul id="crm-bulk-clients-list" class="data-list" style="height: 150px;"></ul>
                </div>
                <hr style="border-color: var(--border-color); margin: var(--space-md) 0;">
                <h4>Templates de Mensagem</h4>
                <div class="form-group" style="display: grid; grid-template-columns: 1fr 2fr; gap: var(--space-md); align-items: center;">
                    <select id="crm-template-category"></select>
                    <select id="crm-template-select"></select>
                </div>
                <div class="form-group">
                    <label for="crm-bulk-message">Mensagem</label>
                    <textarea id="crm-bulk-message" placeholder="Olá {{CLIENTE_NOME}}, temos uma novidade para você!" rows="5"></textarea>
                    <p class="text-muted" style="font-size:0.8rem;">Use {{CLIENTE_NOME}} para personalizar a mensagem.</p>
                </div>
            </div>
             <div id="crm-campaign-control-panel" class="modal-body" style="display: none;">
                <h4 id="crm-campaign-progress">Iniciando campanha...</h4>
                <p id="crm-campaign-next-client" style="color: var(--text-muted); margin-bottom: var(--space-lg);"></p>
                <button id="crm-send-next-btn" class="btn btn-success" style="width: 100%;"><i class="fas fa-paper-plane"></i> Enviar para o Próximo</button>
            </div>
            <div class="modal-actions">
                <button id="crm-start-campaign-btn" class="btn btn-success"><i class="fas fa-rocket"></i> Iniciar Campanha</button>
            </div>
        </div>
    </div>

    <div id="agendamento-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close-btn">&times;</button>
            <h3 id="agendamento-form-title">Novo Agendamento</h3>
            <form id="agendamento-form" novalidate>
                <input type="hidden" id="agendamento-id">
                <div class="form-group">
                    <label for="agendamento-cliente">Cliente*</label>
                    <select id="agendamento-cliente" required></select>
                </div>
                <div class="form-group">
                    <label for="agendamento-servicos">Serviços*</label>
                    <input type="text" id="agendamento-servicos" required placeholder="Ex: Polimento, Higienização">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md);">
                    <div class="form-group">
                        <label for="agendamento-data">Data*</label>
                        <input type="date" id="agendamento-data" required>
                    </div>
                    <div class="form-group">
                        <label for="agendamento-hora">Hora*</label>
                        <input type="time" id="agendamento-hora" required>
                    </div>
                </div>
                 <div class="form-group">
                    <label for="agendamento-status">Status</label>
                    <select id="agendamento-status">
                        <option value="Agendado">Agendado</option>
                        <option value="Confirmado">Confirmado</option>
                        <option value="Finalizado">Finalizado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="agendamento-observacoes">Observações</label>
                    <textarea id="agendamento-observacoes" rows="3"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" id="delete-agendamento-btn" class="btn btn-danger" style="display: none; margin-right: auto;">Excluir</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>


    <div id="notification-container"></div>
    <button id="back-to-top-btn" title="Voltar ao topo"><i class="fas fa-arrow-up"></i></button>
    <div id="sync-overlay" class="sync-overlay">
        <div class="spinner"></div>
        <p>Sincronizando dados...</p>
    </div>

    <script type="module">
        // R.M. Estética Automotiva PRO+
        // Versão: 6.0 (Visão 360° do Cliente Simplificada)
        // Autor: Gemini

        // --- SUPABASE CLIENT SETUP ---
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        const SUPABASE_URL = 'https://bezbszbkaifcanqsmdbi.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJlemJzemJrYWlmY2FucXNtZGJpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2MTM5MTksImV4cCI6MjA2ODE4OTkxOX0.zLXAuQz7g5ym3Bd5pkhg5vsnf_3rdJFRAXI_kX8tM18';

        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- GLOBAL STATE ---
        const defaultColors = {
            primaryRed: '#EF4444', accentGreen: '#10B981', accentBlue: '#3B82F6', accentOrange: '#F59E0B', dangerRed: '#991b1b', dangerRedDark: '#7f1d1d',
            darkTextLight: '#E8EAED', darkTextDark: '#FFFFFF', darkTextMuted: '#9AA0A6', darkBgPrimary: '#121212', darkBgSecondary: '#1E1E1E', darkBgTertiary: '#2D2D2D', darkBorderColor: '#444444',
            lightTextLight: '#374151', lightTextDark: '#111827', lightTextMuted: '#6B7280', lightBgPrimary: '#F9FAFB', lightBgSecondary: '#FFFFFF', lightBgTertiary: '#F3F4F6', lightBorderColor: '#E5E7EB',
        };
        
        const defaultCrmTemplates = {
            "Reativação": [
                { title: "Brinde Especial", text: "Olá {{CLIENTE_NOME}}! Sentimos sua falta. Que tal dar aquele trato especial no seu carro? Temos um brinde esperando por você no seu próximo serviço! 😉" },
                { title: "Desconto de Retorno", text: "Oi, {{CLIENTE_NOME}}! Faz um tempo que não nos vemos. Seu carro merece o melhor cuidado! Agende um serviço conosco esta semana e ganhe 10% de desconto. ✨" },
                { title: "Lembrete de Cuidado", text: "{{CLIENTE_NOME}}, o cuidado contínuo é o segredo para manter seu carro sempre novo. Temos um plano de manutenção ideal para você. Vamos conversar?" },
                { title: "Estamos com Novidades!", text: "{{CLIENTE_NOME}}, faz tempo que você não aparece e nós não paramos de inovar! Venha conhecer nossos novos serviços e tecnologias. A primeira demonstração é por nossa conta!" }
            ],
            "Promoção": [
                { title: "Polimento + Cristalização", text: "📢 PROMOÇÃO IMPERDÍVEL! Olá {{CLIENTE_NOME}}, nesta semana, o pacote de polimento + cristalização está com 20% OFF. Deixe seu carro brilhando como novo! Agende já!" },
                { title: "Promoção de Inverno", text: "Olá, {{CLIENTE_NOME}}! O inverno chegou e a pintura do seu carro precisa de proteção extra. Contrate nossa vitrificação e ganhe a cristalização dos vidros!" },
                { title: "Prepare-se para Viajar", text: "{{CLIENTE_NOME}}, vai pegar a estrada nas férias? Deixe seu carro pronto e protegido! Pacote de viagem: Higienização + Polimento com Cera por um preço especial." },
                { title: "Indique um Amigo", text: "Olá {{CLIENTE_NOME}}! Gostou do nosso serviço? Indique um amigo e, se ele fechar um serviço conosco, você ganha 20% de desconto no seu próximo!" }
            ],
            "Datas Comemorativas": [
                { title: "Dia dos Pais", text: "Seu pai te levou pra tanto lugar, que tal retribuir o carinho deixando o carro dele impecável? Surpreenda com um vale-presente da nossa estética e ganhe 15% de desconto!" },
                { title: "Dia das Mães", text: "Neste Dia das Mães, dê um presente que ela vai usar todo dia: o conforto de um carro limpo e cheiroso. Pacotes de higienização interna com desconto especial para ela!" },
                { title: "Black Friday", text: "NOSSA BLACK FRIDAY COMEÇOU! Olá {{CLIENTE_NOME}}, descontos de até 40% em vitrificação e polimento. Vagas limitadíssimas! Garanta a sua!" },
                { title: "Natal e Fim de Ano", text: "Deixe seu carro brilhando para as festas de fim de ano! Agende seu serviço e prepare-se para viajar com estilo e conforto. Desejamos a você, {{CLIENTE_NOME}}, um Feliz Natal!" }
            ],
            "Pós-serviço": [
                { title: "Agradecimento e Feedback", text: "Olá {{CLIENTE_NOME}}, tudo bem? Gostaríamos de agradecer por confiar seu carro aos nossos cuidados. Sua satisfação é nossa prioridade! Se puder, deixe uma avaliação sobre nosso trabalho, nos ajuda muito: [LINK DO GOOGLE REVIEW]" },
                { title: "Dicas de Manutenção", text: "Oi {{CLIENTE_NOME}}! Para manter o brilho do serviço que fizemos, lembre-se de usar shampoo automotivo neutro e secar com uma toalha de microfibra macia. Qualquer dúvida, estamos aqui!" },
                { title: "Manutenção da Vitrificação", text: "Olá {{CLIENTE_NOME}}, passando para lembrar que a vitrificação que aplicamos no seu carro está completando 6 meses. É o momento ideal para a manutenção, que garante a durabilidade da proteção e reativa o brilho. Vamos agendar?" },
                { title: "Pesquisa Rápida", text: "Olá {{CLIENTE_NOME}}, esperamos que você tenha gostado do resultado do serviço! De 0 a 10, o quanto você recomendaria nossos serviços a um amigo? Sua resposta é muito importante para nós!" }
            ],
            "Avisos Gerais": [
                { title: "Lembrete de Agendamento", text: "Olá {{CLIENTE_NOME}}, passando para lembrar do seu agendamento conosco amanhã, às [HORA]. Estamos ansiosos para recebê-lo!" },
                { title: "Feliz Aniversário!", text: "Parabéns, {{CLIENTE_NOME}}! 🎉 A equipe R.M. Estética deseja a você um feliz aniversário, com muita saúde e sucesso! Como presente, seu próximo serviço tem um desconto especial." }
            ]
        };

        const state = {
            clientes: [],
            servicos: [],
            orcamentos: [],
            orcamentoItens: [],
            crmInteractions: [],
            despesas: [],
            crmTasks: [],
            agendamentos: [],
            crmFilteredClients: [],
            
            editandoClienteId: null,
            editandoServicoId: null,
            editandoDespesaId: null,
            editandoAgendamentoId: null,
            editandoTaskId: null,

            orcamentoSelecionado: null,
            agendaDataAtual: new Date(),
            
            isSyncing: false,
            isOffline: !navigator.onLine,

            novoOrcamentoItens: [],

            configuracoes: {
                id: 1, // Static ID for the single settings row
                empresa: {
                    nome: "R.M. Estética Automotiva",
                    cnpj: "00.000.000/0001-00",
                    telefone: "(XX) XXXXX-XXXX",
                    endereco: "Sua Rua, 123, Sua Cidade",
                    logo: "https://placehold.co/100x100/1E1E1E/E8EAED?text=RM",
                    catalogoLink: ""
                },
                templates: {
                    orcamento: `ORÇAMENTO\n----------------------------------------\n{{NOME_EMPRESA}}\n{{ENDERECO_EMPRESA}}\nTelefone: {{TELEFONE_EMPRESA}}\nCNPJ: {{CNPJ_EMPRESA}}\n\nData: {{DATA}}\n\nCliente: {{CLIENTE_NOME}}\nVeículo: {{CLIENTE_CARRO}} - {{CLIENTE_PLACA}}\n\nSERVIÇOS:\n{{LISTA_SERVICOS}}\n\n----------------------------------------\nSubtotal: {{SUBTOTAL}}\nDesconto ({{DESCONTO_PERCENTUAL}}%): {{DESCONTO}}\nTOTAL: {{TOTAL}}\n\nFormas de Pagamento: {{METODOS_PAGAMENTO}}\n\nEste orçamento é válido por 7 dias.\n\n{{AGRADECIMENTO_CLIENTE}}`,
                    recibo: `CUPOM NÃO FISCAL\n----------------------------------------\n{{NOME_EMPRESA}}\n{{ENDERECO_EMPRESA}}\nTelefone: {{TELEFONE_EMPRESA}}\nCNPJ: {{CNPJ_EMPRESA}}\n\nData: {{DATA}}\n\nCliente: {{CLIENTE_NOME}}\n\nRECIBO DE PAGAMENTO\n\nServiços Prestados:\n{{LISTA_SERVICOS}}\n\n----------------------------------------\nTOTAL PAGO: {{TOTAL}}\nFormas de Pagamento: {{METODOS_PAGAMENTO}}\n\n{{AGRADECIMENTO_CLIENTE}}`,
                },
                crmTemplates: JSON.parse(JSON.stringify(defaultCrmTemplates)),
                visual: {
                    theme: 'dark',
                    colors: { ...defaultColors },
                    watermarkEnabled: false,
                    watermarkOpacity: 0.05,
                    backgroundImage: '',
                    backgroundImageOpacity: 0.1,
                }
            },

            supabaseListeners: [],
            aceEditors: {},
            campaign: {
                clients: [],
                currentIndex: 0,
                message: ''
            }
        };

        // --- DOM ELEMENT SELECTORS ---
        const DOMElements = {
            body: document.body,
            headerTitle: document.getElementById('header-title'),
            headerLogo: document.getElementById('header-logo'),
            hamburgerMenu: document.getElementById('hamburger-menu'),
            mainNav: document.getElementById('main-nav'),
            navLinks: document.querySelectorAll('.nav-link'),
            tabContents: document.querySelectorAll('.tab-content'),
            
            backToTopBtn: document.getElementById('back-to-top-btn'),
            syncButton: document.getElementById('sync-button'),
            
            notificationBellBtn: document.getElementById('notification-bell-btn'),
            notificationBadge: document.getElementById('notification-badge'),
            notificationPanel: document.getElementById('notification-panel'),
            notificationList: document.getElementById('notification-list'),

            syncOverlay: document.getElementById('sync-overlay'),
            modalOverlay: document.getElementById('modal-overlay'),
            confirmationModal: {
                modal: document.getElementById('confirmation-modal'),
                title: document.getElementById('confirmation-title'),
                message: document.getElementById('confirmation-message'),
                confirmBtn: document.getElementById('confirm-btn'),
                cancelBtn: document.getElementById('cancel-btn'),
            },
            createTaskModal: {
                modal: document.getElementById('create-task-modal'),
                form: document.getElementById('create-task-form'),
                formTitle: document.getElementById('create-task-form-title'),
                clientSelect: document.getElementById('task-cliente'),
                deleteBtn: document.getElementById('delete-task-btn'),
                closeBtn: document.querySelector('#create-task-modal .modal-close-btn'),
            },
            orcamentoDetailsModal: {
                modal: document.getElementById('orcamento-details-modal'),
                title: document.getElementById('orcamento-details-title'),
                closeBtn: document.querySelector('#orcamento-details-modal .modal-close-btn'),
                orcamentoText: document.getElementById('detalhes-orcamento-texto'),
                reciboText: document.getElementById('detalhes-recibo-texto'),
                copyBtn: document.getElementById('copy-orcamento-btn'),
                whatsappBtn: document.getElementById('whatsapp-orcamento-btn'),
                pdfBtn: document.getElementById('pdf-orcamento-btn'),
                statusActions: document.getElementById('orcamento-status-actions'),
                viewSwitcher: document.querySelector('#orcamento-details-modal .details-view-switcher'),
                orcamentoView: document.getElementById('orcamento-view'),
                reciboView: document.getElementById('recibo-view'),
            },

            clientDetailsPanel: {
                panel: document.getElementById('client-details-panel'),
                closeBtn: document.querySelector('#client-details-panel .panel-close-btn'),
                // NOTE: Os elementos internos agora são gerados dinamicamente
            },
            
            dashboard: {
                dataInicioInput: document.getElementById('dashboard-data-inicio'),
                dataFimInput: document.getElementById('dashboard-data-fim'),
                filterBtn: document.getElementById('dashboard-filter-btn'),
                clearFilterBtn: document.getElementById('dashboard-clear-filter-btn'),
                statNovosClientes: document.getElementById('stat-novos-clientes'),
                statRecorrentes: document.getElementById('stat-recorrentes'),
                statFinalizados: document.getElementById('stat-finalizados'),
                statFaturamento: document.getElementById('stat-faturamento'),
                recentActivityList: document.getElementById('recent-activity-list'),
                monthlyStatsChart: document.getElementById('monthlyStatsChart'),
                topServicesList: document.getElementById('top-services-list'),
            },

            clienteForm: document.getElementById('cliente-form'),
            clienteFormTitle: document.getElementById('cliente-form-title'),
            clienteIdInput: document.getElementById('cliente-id'),
            clienteNomeInput: document.getElementById('cliente-nome'),
            clienteTelefoneInput: document.getElementById('cliente-telefone'),
            clienteCarroInput: document.getElementById('cliente-carro'),
            clientePlacaInput: document.getElementById('cliente-placa'),
            cancelEditClienteBtn: document.getElementById('cancel-edit-cliente-btn'),
            clientesLista: document.getElementById('clientes-lista'),
            searchClienteInput: document.getElementById('search-cliente'),
            sortClienteSelect: document.getElementById('sort-cliente'),

            servicoForm: document.getElementById('servico-form'),
            servicoFormTitle: document.getElementById('servico-form-title'),
            servicoIdInput: document.getElementById('servico-id'),
            servicoDescricaoInput: document.getElementById('servico-descricao'),
            servicoValorInput: document.getElementById('servico-valor'),
            cancelEditServicoBtn: document.getElementById('cancel-edit-servico-btn'),
            servicosLista: document.getElementById('servicos-lista'),
            searchServicoInput: document.getElementById('search-servico'),
            sortServicoSelect: document.getElementById('sort-servico'),

            orcamentoForm: document.getElementById('orcamento-form'),
            orcamentoClienteSelect: document.getElementById('orcamento-cliente'),
            orcamentoServicoSelect: document.getElementById('orcamento-servico-select'),
            orcamentoServicoQtdInput: document.getElementById('orcamento-servico-qtd'),
            addServicoBtn: document.getElementById('add-servico-btn'),
            orcamentoItensTbody: document.getElementById('orcamento-servicos-adicionados'),
            orcamentoDescontoInput: document.getElementById('orcamento-desconto-percentual'),
            orcamentoTotalSpan: document.getElementById('orcamento-total'),
            paymentMethodToggles: document.getElementById('payment-method-toggles'),
            
            historicoLista: document.getElementById('historico-lista'),
            historicoSearchInput: document.getElementById('historico-search'),
            historicoStatusFilter: document.getElementById('historico-status-filter'),
            historicoDataInicioInput: document.getElementById('historico-data-inicio'),
            historicoDataFimInput: document.getElementById('historico-data-fim'),
            historicoLimparFiltrosBtn: document.getElementById('historico-limpar-filtros'),
            
            crm: {
                metricOportunidades: document.getElementById('crm-metric-oportunidades'),
                metricConversao: document.getElementById('crm-metric-conversao'),
                metricTarefas: document.getElementById('crm-metric-tarefas'),
                tasksBoard: document.getElementById('tasks-board'),
                form: document.getElementById('crm-form'),
                clientSelect: document.getElementById('crm-cliente-select'),
                interactionsList: document.getElementById('crm-interactions-list'),
                segmentButtons: document.getElementById('crm-segment-buttons'),
                inactiveClientsList: document.getElementById('crm-inactive-clients-list'),
                bulkMessageBtn: document.getElementById('crm-bulk-message-btn'),
                createTaskBtn: document.getElementById('create-task-btn'),
            },
            crmBulkModal: {
                modal: document.getElementById('crm-bulk-modal'),
                closeBtn: document.querySelector('#crm-bulk-modal .modal-close-btn'),
                setupPanel: document.getElementById('crm-campaign-setup'),
                controlPanel: document.getElementById('crm-campaign-control-panel'),
                progressText: document.getElementById('crm-campaign-progress'),
                nextClientText: document.getElementById('crm-campaign-next-client'),
                sendNextBtn: document.getElementById('crm-send-next-btn'),
                clientsList: document.getElementById('crm-bulk-clients-list'),
                selectAll: document.getElementById('crm-bulk-select-all'),
                message: document.getElementById('crm-bulk-message'),
                startBtn: document.getElementById('crm-start-campaign-btn'),
                templateCategory: document.getElementById('crm-template-category'),
                templateSelect: document.getElementById('crm-template-select'),
            },
            
            agenda: {
                datePicker: document.getElementById('agenda-date-picker'),
                prevDayBtn: document.getElementById('prev-day-btn'),
                nextDayBtn: document.getElementById('next-day-btn'),
                addBtn: document.getElementById('add-agendamento-btn'),
                gridContainer: document.getElementById('agenda-grid-container'),
                modal: document.getElementById('agendamento-modal'),
                form: document.getElementById('agendamento-form'),
                formTitle: document.getElementById('agendamento-form-title'),
                deleteBtn: document.getElementById('delete-agendamento-btn'),
                closeBtn: document.querySelector('#agendamento-modal .modal-close-btn'),
                idInput: document.getElementById('agendamento-id'),
                clienteSelect: document.getElementById('agendamento-cliente'),
                servicosInput: document.getElementById('agendamento-servicos'),
                dataInput: document.getElementById('agendamento-data'),
                horaInput: document.getElementById('agendamento-hora'),
                statusSelect: document.getElementById('agendamento-status'),
                observacoesInput: document.getElementById('agendamento-observacoes'),
            },

            fluxoCaixa: {
                dataInicioInput: document.getElementById('fluxo-caixa-data-inicio'),
                dataFimInput: document.getElementById('fluxo-caixa-data-fim'),
                receitas: document.getElementById('fluxo-caixa-receitas'),
                despesas: document.getElementById('fluxo-caixa-despesas'),
                lucro: document.getElementById('fluxo-caixa-lucro'),
                despesaForm: document.getElementById('despesa-form'),
                despesasLista: document.getElementById('despesas-lista'),
            },

            config: {
                nome: document.getElementById('config-nome'),
                cnpj: document.getElementById('config-cnpj'),
                telefone: document.getElementById('config-telefone'),
                endereco: document.getElementById('config-endereco'),
                catalogoLink: document.getElementById('config-catalogo-link'),
                logoUpload: document.getElementById('config-logo-upload'),
                logoPreview: document.getElementById('config-logo-preview'),
                watermarkToggle: document.getElementById('config-watermark-toggle'),
                themeToggle: document.getElementById('theme-toggle'),
                templateOrcamento: document.getElementById('config-template-orcamento'),
                templateRecibo: document.getElementById('config-template-recibo'),
                crmTemplatesEditorContainer: document.getElementById('crm-templates-editor-container'),
                exportBtn: document.getElementById('export-data-btn'),
                importInput: document.getElementById('import-data-input'),
                resetColorsBtn: document.getElementById('reset-colors-btn'),
                bgImageUpload: document.getElementById('config-bg-image-upload'),
                bgImageOpacity: document.getElementById('config-bg-image-opacity'),
                removeBgImageBtn: document.getElementById('remove-bg-image-btn'),
                colorPickers: document.querySelectorAll('#configuracoes-tab input[type="color"]'),
            },
            accordionItems: document.querySelectorAll('.accordion-item'),
        };

        // --- UTILITY FUNCTIONS ---
const closeModal = (modal, useOverlay = true) => {
    if (!modal) return;

    // --- Bloco Adicionado ---
    // Verifica se existe um formulário dentro do modal e o limpa.
    if (modal.querySelector('form')) {
        const form = modal.querySelector('form');
        form.reset();
        clearFormValidation(form);
        
        // Lógica extra para resetar completamente os formulários de edição
        if (form.id === 'cliente-form') resetClienteForm();
        if (form.id === 'servico-form') resetServicoForm();
        if (form.id === 'agendamento-form') state.editandoAgendamentoId = null;
        if (form.id === 'create-task-form') state.editandoTaskId = null;
    }
    // --- Fim do Bloco Adicionado ---

    if (modal.classList.contains('side-panel')) {
        modal.classList.remove('open');
    } else {
        modal.style.display = 'none';
    }

    const anyVisible = Array.from(document.querySelectorAll('.modal, .side-panel.open'))
        .some(m => m.style.display === 'block' || m.classList.contains('open'));

    if (!anyVisible && useOverlay) {
        DOMElements.modalOverlay.style.display = 'none';
    }
};

        const openModal = (modal) => {
            DOMElements.modalOverlay.style.display = 'flex';
            if (modal.classList.contains('side-panel')) {
                modal.classList.add('open');
            } else {
                modal.style.display = 'block';
            }
        };

        const formatCurrency = (value) => {
            if (typeof value !== 'number') value = 0;
            return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        };

        const showNotification = (message, type = 'info', duration = 3000) => {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            container.appendChild(notification);
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.4s ease-out forwards';
                setTimeout(() => notification.remove(), 400);
            }, duration);
        };

        const showConfirmation = ({ title = 'Confirmar Ação', message = 'Você tem certeza?', confirmText = 'Confirmar', cancelText = 'Cancelar' }) => {
            return new Promise(resolve => {
                const { modal, title: titleEl, message: msgEl, confirmBtn, cancelBtn } = DOMElements.confirmationModal;
                
                titleEl.textContent = title;
                msgEl.textContent = message;
                confirmBtn.textContent = confirmText;
                cancelBtn.textContent = cancelText;

                const closeConfirmation = (result) => {
                    closeModal(modal);
                    confirmBtn.onclick = null;
                    cancelBtn.onclick = null;
                    resolve(result);
                };

                openModal(modal);

                confirmBtn.onclick = () => closeConfirmation(true);
                cancelBtn.onclick = () => closeConfirmation(false);
            });
        };

        const showConfetti = () => {
            const confettiContainer = DOMElements.body;
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.top = `${Math.random() * -50}vh`;
                confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                confetti.style.animationDelay = `${Math.random() * 2}s`;
                confetti.style.transform = `scale(${Math.random() * 0.5 + 0.5})`;
                confettiContainer.appendChild(confetti);
                setTimeout(() => confetti.remove(), 4000);
            }
        };

        const rippleEffect = (event, btn) => {
            const circle = document.createElement("span");
            const diameter = Math.max(btn.clientWidth, btn.clientHeight);
            const radius = diameter / 2;
            const rect = btn.getBoundingClientRect();

            circle.style.width = circle.style.height = `${diameter}px`;
            circle.style.left = `${event.clientX - rect.left - radius}px`;
            circle.style.top = `${event.clientY - rect.top - radius}px`;
            circle.classList.add("ripple");

            const ripple = btn.getElementsByClassName("ripple")[0];
            if (ripple) ripple.remove();
            
            btn.appendChild(circle);
        };

        const debounce = (func, delay) => {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        };

        const setSyncing = (isSyncing) => {
            state.isSyncing = isSyncing;
            DOMElements.syncOverlay.style.display = isSyncing ? 'flex' : 'none';
            const syncIcon = DOMElements.syncButton.querySelector('i');
            if (isSyncing) {
                syncIcon.classList.add('fa-spin');
            } else {
                syncIcon.classList.remove('fa-spin');
            }
        };

        // --- INÍCIO: LÓGICA CDP 360° ---


const calculateAndCacheInsightsForClient = (cliente) => {
    if (!cliente) return {};

    const orcamentosDoCliente = state.orcamentos.filter(o => o.cliente_id === cliente.id && ['Finalizado', 'Pago'].includes(o.status));
    const interacoesDoCliente = state.crmInteractions.filter(i => i.cliente_id === cliente.id);

    const insights = {
        ticketMedio: calculateTicketMedio(orcamentosDoCliente),
        frequenciaMedia: calculateFrequenciaMedia(orcamentosDoCliente),
        scoreSatisfacao: calculateSatisfactionScore(interacoesDoCliente),
        riscoChurn: calculateChurnRisk(cliente, orcamentosDoCliente),
        proximoServicoSugerido: predictNextService(orcamentosDoCliente)
    };

    // Atualiza o objeto do cliente no estado principal e também o localStorage
    cliente.insights = insights;
    localStorage.setItem(`insights_${cliente.id}`, JSON.stringify(insights));
    
    return insights;
};
 const processAllCustomerInsights = () => {
            if (!state.clientes || state.clientes.length === 0) return;

            state.clientes.forEach(cliente => {
                const orcamentosDoCliente = state.orcamentos.filter(o => o.cliente_id === cliente.id && ['Finalizado', 'Pago'].includes(o.status));
                const interacoesDoCliente = state.crmInteractions.filter(i => i.cliente_id === cliente.id);

                const ticketMedio = calculateTicketMedio(orcamentosDoCliente);
                const frequenciaMedia = calculateFrequenciaMedia(orcamentosDoCliente);
                const scoreSatisfacao = calculateSatisfactionScore(interacoesDoCliente);
                const riscoChurn = calculateChurnRisk(cliente, orcamentosDoCliente);
                const proximoServicoSugerido = predictNextService(orcamentosDoCliente);

                cliente.insights = {
                    ticketMedio,
                    frequenciaMedia,
                    scoreSatisfacao,
                    riscoChurn,
                    proximoServicoSugerido
                };

                localStorage.setItem(`insights_${cliente.id}`, JSON.stringify(cliente.insights));
            });
            console.log("Insights de todos os clientes processados e cacheados.");
        };

        function calculateTicketMedio(orcamentosFinalizados) {
            if (orcamentosFinalizados.length === 0) return 0;
            const totalGasto = orcamentosFinalizados.reduce((acc, o) => acc + o.valor_total, 0);
            return totalGasto / orcamentosFinalizados.length;
        }

        function calculateFrequenciaMedia(orcamentosFinalizados) {
            if (orcamentosFinalizados.length < 2) return 0;

            const datas = orcamentosFinalizados
                .map(o => new Date(o.created_at).getTime())
                .sort((a, b) => a - b);

            const diffs = [];
            for (let i = 1; i < datas.length; i++) {
                const diffMs = datas[i] - datas[i - 1];
                diffs.push(diffMs / (1000 * 60 * 60 * 24));
            }

            const mediaDias = diffs.reduce((acc, diff) => acc + diff, 0) / diffs.length;
            return Math.round(mediaDias);
        }

        function calculateSatisfactionScore(interacoes) {
            const avaliacoes = interacoes
                .map(i => i.satisfacao_declarada)
                .filter(s => s !== null && s !== undefined);

            if (avaliacoes.length === 0) return 5;
            const media = avaliacoes.reduce((acc, s) => acc + s, 0) / avaliacoes.length;
            return Math.round(media);
        }

        function calculateChurnRisk(cliente, orcamentosFinalizados) {
            if (orcamentosFinalizados.length === 0) return 5;

            const ultimoServico = new Date(orcamentosFinalizados.sort((a, b) => new Date(b.created_at) - new Date(a.created_at))[0].created_at);
            const hoje = new Date();
            const diasSemServico = Math.round((hoje - ultimoServico) / (1000 * 60 * 60 * 24));
            
            if (diasSemServico > 120) return 10;
            if (diasSemServico > 90) return 8;
            if (diasSemServico > 60) return 6;
            if (diasSemServico < 30) return 2;
            return 4;
        }

        function predictNextService(orcamentosFinalizados) {
            if (orcamentosFinalizados.length === 0) return "Primeiro serviço";
            
            const todosItens = state.orcamentoItens.filter(item => 
                orcamentosFinalizados.some(o => o.id === item.orcamento_id)
            );

            if(todosItens.length === 0) return "N/A";

            const contagemServicos = todosItens.reduce((acc, item) => {
                acc[item.descricao_servico] = (acc[item.descricao_servico] || 0) + 1;
                return acc;
            }, {});
            
            return Object.keys(contagemServicos).reduce((a, b) => contagemServicos[a] > contagemServicos[b] ? a : b);
        }
        
        // --- FIM: LÓGICA CDP 360° ---


        // --- SUPABASE INTEGRATION ---
        const fetchAllData = async (showOverlay = true) => {
            if (state.isSyncing) return;
            setSyncing(showOverlay);

            try {
                const [
                    { data: clientes, error: e1 }, { data: servicos, error: e2 },
                    { data: orcamentos, error: e3 }, { data: orcamentoItens, error: e4 },
                    { data: despesas, error: e5 }, { data: crmInteractions, error: e6 }, // Mantendo crm_interactions por enquanto
                    { data: crmTasks, error: e8 },
                    { data: agendamentos, error: e9 },
                ] = await Promise.all([
                    supabase.from('clientes').select('*').order('created_at', { ascending: false }),
                    supabase.from('servicos').select('*').order('descricao'),
                    supabase.from('orcamentos').select('*, clientes(nome, carro, placa, telefone)').order('created_at', { ascending: false }),
                    supabase.from('orcamento_itens').select('*'),
                    supabase.from('despesas').select('*').order('data_despesa', { ascending: false }),
                    supabase.from('crm_interactions').select('*, clientes(nome)').order('created_at', { ascending: false }),
                    supabase.from('crm_tasks').select('*').order('created_at', { ascending: false }),
                    supabase.from('agendamentos').select('*, clientes(nome)').order('data_agendamento, hora_agendamento'),
                ]);

                if (e1) throw e1; if (e2) throw e2; if (e3) throw e3; if (e4) throw e4; if (e5) throw e5; if (e6) throw e6;
                if (e8) throw e8; if (e9) throw e9;

                state.clientes = clientes || [];
                state.servicos = servicos || [];
                state.orcamentos = orcamentos || [];
                state.orcamentoItens = orcamentoItens || [];
                state.despesas = despesas || [];
                state.crmInteractions = crmInteractions || [];
                state.crmTasks = crmTasks || [];
                state.agendamentos = agendamentos || [];
                
// --- INÍCIO: INTEGRAÇÃO CDP ---
// Processa os insights do cliente após buscar todos os dados
// processAllCustomerInsights(); // <<< LINHA COMENTADA/DESATIVADA
// --- FIM: INTEGRAÇÃO CDP ---


                await loadConfig(); // Carrega as configurações da nuvem
                renderAllContent();
                updateNotifications();
                if (showOverlay) showNotification('✅ Dados sincronizados com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao buscar dados:', error);
                showNotification(`❌ Erro de sincronização: ${error.message}`, 'error');
            } finally {
                setSyncing(false);
            }
        };

        const setupSupabaseListeners = () => {
            const tables = ['clientes', 'servicos', 'orcamentos', 'orcamento_itens', 'despesas', 'crm_interactions', 'crm_tasks', 'agendamentos', 'configuracoes'];
            
            state.supabaseListeners.forEach(listener => supabase.removeChannel(listener));
            state.supabaseListeners = [];

            tables.forEach(table => {
                const listener = supabase.channel(`public:${table}`)
                    .on('postgres_changes', { event: '*', schema: 'public', table }, (payload) => {
                        console.log(`Alteração na tabela ${table}:`, payload);
                        showNotification(`🔄 Atualização em ${table} recebida.`, 'info', 1500);
                        fetchAllData(false);
                    })
                    .subscribe();
                state.supabaseListeners.push(listener);
            });
        };

        // --- RENDER FUNCTIONS ---
        const renderAllContent = () => {
            const activeTab = document.querySelector('.tab-content.active');
            if (activeTab) {
                showTab(activeTab.id, false);
            } else {
                showTab('dashboard-tab', false);
            }
        };

        const showTab = (tabId, resetScroll = true) => {
            DOMElements.tabContents.forEach(tab => tab.classList.remove('active'));
            DOMElements.navLinks.forEach(link => link.classList.remove('active'));
            
            const tabToShow = document.getElementById(tabId);
            const linkToActivate = document.querySelector(`.nav-link[data-tab="${tabId}"]`);

            if (tabToShow) tabToShow.classList.add('active');
            if (linkToActivate) linkToActivate.classList.add('active');

            switch (tabId) {
                case 'dashboard-tab': renderDashboard(); break;
                case 'agenda-tab': renderAgenda(); break;
                case 'clientes-tab': renderClientes(); break;
                case 'servicos-tab': renderServicos(); break;
                case 'orcamento-tab': renderOrcamentoForm(); break;
                case 'historico-tab': renderHistorico(); break;
                case 'crm-tab': renderCRM(); break;
                case 'fluxo-caixa-tab': renderFluxoDeCaixa(); break;
                case 'configuracoes-tab': populateConfigForm(); break;
            }
            if (resetScroll) {
                window.scrollTo(0, 0);
            }
        };

        let monthlyChartInstance = null;
        const renderDashboard = () => {
            const { dashboard } = DOMElements;
            const startDate = dashboard.dataInicioInput.value;
            const endDate = dashboard.dataFimInput.value;

            const filterByDate = (items, dateField = 'created_at') => {
                return items.filter(item => {
                    if (!startDate && !endDate) return true;
                    const itemDate = new Date(item[dateField]);
                    const start = startDate ? new Date(startDate) : null;
                    const end = endDate ? new Date(endDate + 'T23:59:59') : null;
                    // Ajuste para datas que não têm hora (como data_despesa)
                    const itemDateOnly = new Date(itemDate.getFullYear(), itemDate.getMonth(), itemDate.getDate());
                    return (!start || itemDateOnly >= start) && (!end || itemDateOnly <= end);
                });
            };

            const filteredClients = filterByDate(state.clientes);
            const filteredOrcamentos = filterByDate(state.orcamentos);
            const filteredDespesas = filterByDate(state.despesas, 'data_despesa');
            
            const finalizados = filteredOrcamentos.filter(o => ['Finalizado', 'Pago'].includes(o.status));
            
            const faturamento = finalizados.reduce((sum, o) => sum + (o.valor_total || 0), 0);
            
            const allTimeFinalizados = state.orcamentos.filter(o => ['Finalizado', 'Pago'].includes(o.status));
            const clientsInPeriod = new Set(finalizados.map(o => o.cliente_id));
            let recurringClientsCount = 0;
            clientsInPeriod.forEach(clientId => {
                const hasPreviousService = allTimeFinalizados.some(o => o.cliente_id === clientId && new Date(o.created_at) < (startDate ? new Date(startDate) : new Date(0)));
                if (hasPreviousService) {
                    recurringClientsCount++;
                }
            });

            dashboard.statNovosClientes.textContent = filteredClients.length;
            dashboard.statFinalizados.textContent = finalizados.length;
            dashboard.statFaturamento.textContent = formatCurrency(faturamento);
            dashboard.statRecorrentes.textContent = recurringClientsCount;

            dashboard.recentActivityList.innerHTML = state.orcamentos.slice(0, 8).map(o => `
                <li data-action="view-orcamento" data-id="${o.id}" style="cursor:pointer;">
                    <div class="list-item-main">
                        <p class="item-title">${o.clientes?.nome || 'Cliente Removido'}</p>
                        <p class="item-subtitle">${new Date(o.created_at).toLocaleDateString()} - ${formatCurrency(o.valor_total)}</p>
                    </div>
                    <span class="status-badge ${o.status?.toLowerCase()}">${o.status}</span>
                </li>
            `).join('') || '<li>Nenhuma atividade recente.</li>';
            
            const serviceReport = {};
            finalizados.forEach(orcamento => {
                const items = state.orcamentoItens.filter(i => i.orcamento_id === orcamento.id);
                items.forEach(item => {
                    const revenue = item.quantidade * item.valor_unitario;
                    if (!serviceReport[item.descricao_servico]) {
                        serviceReport[item.descricao_servico] = { count: 0, revenue: 0 };
                    }
                    serviceReport[item.descricao_servico].count += item.quantidade;
                    serviceReport[item.descricao_servico].revenue += revenue;
                });
            });
            const topServices = Object.entries(serviceReport)
                .sort((a, b) => b[1].revenue - a[1].revenue)
                .slice(0, 5);

            dashboard.topServicesList.innerHTML = topServices.length > 0 ? topServices.map(([descricao, data]) => `
                <li>
                    <div class="list-item-main">
                        <p class="item-title">${descricao}</p>
                        <p class="item-subtitle">${data.count}x vendido(s)</p>
                    </div>
                    <strong style="color: var(--accent-green);">${formatCurrency(data.revenue)}</strong>
                </li>
            `).join('') : '<li>Nenhum serviço finalizado no período.</li>';

            // --- Lógica do Gráfico Aprimorada ---
            const monthlyData = { revenue: {}, expenses: {}, serviceDetails: {} };

            finalizados.forEach(o => {
                const d = new Date(o.created_at);
                const monthKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                if (!monthlyData.revenue[monthKey]) monthlyData.revenue[monthKey] = 0;
                monthlyData.revenue[monthKey] += o.valor_total;

                // Coleta de detalhes dos serviços para o tooltip
                if(!monthlyData.serviceDetails[monthKey]) monthlyData.serviceDetails[monthKey] = {};
                const items = state.orcamentoItens.filter(i => i.orcamento_id === o.id);
                items.forEach(item => {
                    if (!monthlyData.serviceDetails[monthKey][item.descricao_servico]) {
                        monthlyData.serviceDetails[monthKey][item.descricao_servico] = { count: 0, revenue: 0 };
                    }
                    monthlyData.serviceDetails[monthKey][item.descricao_servico].count += item.quantidade;
                    monthlyData.serviceDetails[monthKey][item.descricao_servico].revenue += item.quantidade * item.valor_unitario;
                });
            });
            
            filteredDespesas.forEach(d => {
                const date = new Date(d.data_despesa + 'T00:00:00'); // Garante que a data seja lida corretamente
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                if (!monthlyData.expenses[monthKey]) monthlyData.expenses[monthKey] = 0;
                monthlyData.expenses[monthKey] += d.valor;
            });

            const allMonths = [...new Set([...Object.keys(monthlyData.revenue), ...Object.keys(monthlyData.expenses)])].sort();

            if (monthlyChartInstance) monthlyChartInstance.destroy();
            monthlyChartInstance = new Chart(dashboard.monthlyStatsChart, {
                type: 'bar',
                data: {
                    labels: allMonths,
                    datasets: [
                        {
                            label: 'Receitas',
                            data: allMonths.map(month => monthlyData.revenue[month] || 0),
                            backgroundColor: state.configuracoes.visual.colors.accentGreen + 'B3',
                            borderColor: state.configuracoes.visual.colors.accentGreen,
                            borderWidth: 1,
                            borderRadius: 5,
                        },
                        {
                            label: 'Despesas',
                            data: allMonths.map(month => monthlyData.expenses[month] || 0),
                            backgroundColor: state.configuracoes.visual.colors.primaryRed + 'B3',
                            borderColor: state.configuracoes.visual.colors.primaryRed,
                            borderWidth: 1,
                            borderRadius: 5,
                        }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: true, position: 'top', labels: { color: '#9AA0A6' } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${formatCurrency(context.raw)}`;
                                },
                                // NOVO: Tooltip com detalhamento dos serviços
                                footer: function(tooltipItems) {
                                    const monthKey = tooltipItems[0].label;
                                    const details = monthlyData.serviceDetails[monthKey];
                                    if (!details || tooltipItems[0].dataset.label !== 'Receitas') {
                                        return '';
                                    }
                                    
                                    const footerLines = ['--- Serviços ---'];
                                    Object.entries(details)
                                        .sort((a,b) => b[1].revenue - a[1].revenue) // Ordena por mais rentável
                                        .forEach(([service, data]) => {
                                            footerLines.push(`${service}: ${data.count}x (${formatCurrency(data.revenue)})`);
                                        });

                                    return footerLines;
                                }
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(232, 234, 237, 0.1)' }, ticks: { color: '#9AA0A6' } },
                        x: { grid: { display: false }, ticks: { color: '#9AA0A6' } }
                    }
                }
            });
        };

        const renderClientes = () => {
            const searchTerm = DOMElements.searchClienteInput.value.toLowerCase();
            const sortOrder = DOMElements.sortClienteSelect.value;

            let filteredClientes = state.clientes.filter(c => 
                c.nome.toLowerCase().includes(searchTerm) ||
                (c.placa && c.placa.toLowerCase().includes(searchTerm))
            );

            filteredClientes.sort((a, b) => {
                switch (sortOrder) {
                    case 'nome-asc': return a.nome.localeCompare(b.nome);
                    case 'nome-desc': return b.nome.localeCompare(a.nome);
                    case 'recentes': return new Date(b.created_at) - new Date(a.created_at);
                    default: return 0;
                }
            });

            DOMElements.clientesLista.innerHTML = filteredClientes.length > 0
                ? filteredClientes.map(cliente => `
                    <li>
                        <div class="list-item-main">
                            <p class="item-title">${cliente.nome}</p>
                            <p class="item-subtitle">${cliente.carro || 'Carro não informado'} - ${cliente.placa}</p>
                        </div>
                        <div class="list-item-actions">
                            <button class="btn btn-secondary btn-sm" data-action="details-cliente" data-id="${cliente.id}"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-secondary btn-sm" data-action="edit-cliente" data-id="${cliente.id}"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-danger btn-sm" data-action="delete-cliente" data-id="${cliente.id}"><i class="fas fa-trash"></i></button>
                        </div>
                    </li>
                `).join('')
                : '<li>Nenhum cliente encontrado.</li>';
        };

        const renderServicos = () => {
            const searchTerm = DOMElements.searchServicoInput.value.toLowerCase();
            const sortOrder = DOMElements.sortServicoSelect.value;

            let filteredServicos = state.servicos.filter(s => 
                s.descricao.toLowerCase().includes(searchTerm)
            );

            filteredServicos.sort((a, b) => {
                switch (sortOrder) {
                    case 'descricao-asc': return a.descricao.localeCompare(b.descricao);
                    case 'valor-asc': return a.valor - b.valor;
                    case 'valor-desc': return b.valor - a.valor;
                    default: return 0;
                }
            });

            DOMElements.servicosLista.innerHTML = filteredServicos.length > 0
                ? filteredServicos.map(servico => `
                    <li>
                        <div class="list-item-main">
                            <p class="item-title">${servico.descricao}</p>
                            <p class="item-subtitle">${formatCurrency(servico.valor)}</p>
                        </div>
                        <div class="list-item-actions">
                            <button class="btn btn-secondary btn-sm" data-action="edit-servico" data-id="${servico.id}"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-danger btn-sm" data-action="delete-servico" data-id="${servico.id}"><i class="fas fa-trash"></i></button>
                        </div>
                    </li>
                `).join('')
                : '<li>Nenhum serviço encontrado.</li>';
        };

        const renderOrcamentoForm = () => {
            DOMElements.orcamentoClienteSelect.innerHTML = '<option value="">Selecione um cliente</option>' + 
                state.clientes.map(c => `<option value="${c.id}">${c.nome} - ${c.placa}</option>`).join('');
            
            DOMElements.orcamentoServicoSelect.innerHTML = '<option value="">Selecione um serviço</option>' +
                state.servicos.map(s => `<option value="${s.id}">${s.descricao} - ${formatCurrency(s.valor)}</option>`).join('');
            
            renderOrcamentoItens();
        };

        const renderOrcamentoItens = () => {
            DOMElements.orcamentoItensTbody.innerHTML = state.novoOrcamentoItens.map((item, index) => `
                <tr data-index="${index}">
                    <td>${item.descricao}</td>
                    <td>${item.quantidade}</td>
                    <td>${formatCurrency(item.valor_unitario)}</td>
                    <td>${formatCurrency(item.quantidade * item.valor_unitario)}</td>
                    <td>
                        <button type="button" class="btn btn-danger btn-sm" data-action="remove-orc-item"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
            updateOrcamentoTotal();
        };

        const renderHistorico = () => {
            const searchTerm = DOMElements.historicoSearchInput.value.toLowerCase();
            const statusFilter = DOMElements.historicoStatusFilter.value;
            const dataInicio = DOMElements.historicoDataInicioInput.value;
            const dataFim = DOMElements.historicoDataFimInput.value;

            let filtered = [...state.orcamentos];

            if (searchTerm) {
                filtered = filtered.filter(o => 
                    (o.clientes?.nome && o.clientes.nome.toLowerCase().includes(searchTerm)) ||
                    state.orcamentoItens.filter(i => i.orcamento_id === o.id).some(i => i.descricao_servico.toLowerCase().includes(searchTerm))
                );
            }
            if (statusFilter) filtered = filtered.filter(o => o.status === statusFilter);
            if (dataInicio) filtered = filtered.filter(o => new Date(o.created_at) >= new Date(dataInicio));
            if (dataFim) filtered = filtered.filter(o => new Date(o.created_at) <= new Date(dataFim + 'T23:59:59'));

            DOMElements.historicoLista.innerHTML = filtered.length > 0 ? filtered.map(o => `
                <li>
                    <div class="list-item-main" data-action="view-orcamento" data-id="${o.id}" style="cursor: pointer;">
                        <p class="item-title">${o.clientes?.nome || 'Cliente Removido'} (${new Date(o.created_at).toLocaleDateString()})</p>
                        <p class="item-subtitle">${formatCurrency(o.valor_total)}</p>
                    </div>
                    <div class="list-item-actions">
                        <span class="status-badge ${o.status?.toLowerCase()}">${o.status}</span>
                        <button class="btn btn-danger btn-sm btn-icon" data-action="delete-orcamento" data-id="${o.id}" title="Excluir Orçamento"><i class="fas fa-trash"></i></button>
                    </div>
                </li>
            `).join('') : '<li>Nenhum orçamento encontrado com os filtros aplicados.</li>';
        };

        const renderFluxoDeCaixa = () => {
            const { fluxoCaixa } = DOMElements;
            const startDate = fluxoCaixa.dataInicioInput.value;
            const endDate = fluxoCaixa.dataFimInput.value;

            const filterByDate = (items, dateField) => {
                return items.filter(item => {
                    if (!startDate && !endDate) return true;
                    const itemDate = new Date(item[dateField]);
                    const start = startDate ? new Date(startDate) : null;
                    const end = endDate ? new Date(endDate + 'T23:59:59') : null;
                    const itemDateOnly = new Date(itemDate.getFullYear(), itemDate.getMonth(), itemDate.getDate());
                    return (!start || itemDateOnly >= start) && (!end || itemDateOnly <= end);
                });
            };

            const orcamentosPagos = filterByDate(state.orcamentos.filter(o => o.status === 'Pago'));
            const despesasPeriodo = filterByDate(state.despesas, 'data_despesa');
            
            const totalReceitas = orcamentosPagos.reduce((sum, o) => sum + o.valor_total, 0);
            const totalDespesas = despesasPeriodo.reduce((sum, d) => sum + d.valor, 0);
            const lucroLiquido = totalReceitas - totalDespesas;

            fluxoCaixa.receitas.textContent = formatCurrency(totalReceitas);
            fluxoCaixa.despesas.textContent = formatCurrency(totalDespesas);
            fluxoCaixa.lucro.textContent = formatCurrency(lucroLiquido);
            
            fluxoCaixa.despesasLista.innerHTML = despesasPeriodo.length > 0
                ? despesasPeriodo.map(d => `
                    <li>
                        <div class="list-item-main">
                            <p class="item-title">${d.descricao}</p>
                            <p class="item-subtitle">${new Date(d.data_despesa + 'T00:00:00').toLocaleDateString()}</p>
                        </div>
                        <div class="list-item-actions" style="align-items: center; gap: 16px;">
                            <strong style="color: var(--primary-red);">${formatCurrency(d.valor)}</strong>
                            <button class="btn btn-danger btn-sm btn-icon" data-action="delete-despesa" data-id="${d.id}" title="Excluir Despesa"><i class="fas fa-trash"></i></button>
                        </div>
                    </li>
                `).join('')
                : `<li>Nenhuma despesa no período selecionado.</li>`;
        };

        // --- FORM HANDLERS & CRUD ---
        const handleClienteSubmit = async (e) => {
            e.preventDefault();
            if (!validateForm(DOMElements.clienteForm)) return;

            const clienteData = {
                nome: DOMElements.clienteNomeInput.value.trim(),
                telefone: DOMElements.clienteTelefoneInput.value.trim(),
                carro: DOMElements.clienteCarroInput.value.trim(),
                placa: DOMElements.clientePlacaInput.value.trim().toUpperCase(),
            };

            setSyncing(true);
            try {
                const { error } = state.editandoClienteId
                    ? await supabase.from('clientes').update(clienteData).eq('id', state.editandoClienteId)
                    : await supabase.from('clientes').insert(clienteData);
                
                if (error) throw error;
                
                showNotification(`Cliente ${state.editandoClienteId ? 'atualizado ✅' : 'salvo ✅'} com sucesso!`, 'success');
                showConfetti();
                resetClienteForm();
                await fetchAllData(false);
            } catch (error) {
                console.error('Erro ao salvar cliente:', error);
                showNotification(`❌ Erro ao salvar cliente: ${error.message}`, 'error');
            } finally {
                setSyncing(false);
            }
        };

        const handleEditCliente = (id) => {
            const cliente = state.clientes.find(c => c.id === id);
            if (!cliente) return;

            state.editandoClienteId = id;
            DOMElements.clienteFormTitle.textContent = '👤 Editar Cliente';
            DOMElements.clienteIdInput.value = cliente.id;
            DOMElements.clienteNomeInput.value = cliente.nome;
            DOMElements.clienteTelefoneInput.value = cliente.telefone;
            DOMElements.clienteCarroInput.value = cliente.carro;
            DOMElements.clientePlacaInput.value = cliente.placa;
            DOMElements.cancelEditClienteBtn.style.display = 'inline-flex';
            DOMElements.clienteNomeInput.focus();
        };

        const handleDeleteCliente = async (id) => {
            const confirmed = await showConfirmation({
                title: 'Excluir Cliente',
                message: 'Esta ação é IRREVERSÍVEL e também excluirá TODOS os orçamentos e interações associados a este cliente. Deseja continuar?',
                confirmText: 'Sim, Excluir Tudo'
            });

            if (confirmed) {
                setSyncing(true);
                try {
                    const clientOrcamentoIds = state.orcamentos.filter(o => o.cliente_id === id).map(o => o.id);

                    if (clientOrcamentoIds.length > 0) {
                        await supabase.from('orcamento_itens').delete().in('orcamento_id', clientOrcamentoIds);
                    }
                    
                    await supabase.from('orcamentos').delete().eq('cliente_id', id);
                    await supabase.from('crm_interactions').delete().eq('cliente_id', id);
                    await supabase.from('crm_tasks').delete().eq('cliente_id', id);
                    await supabase.from('agendamentos').delete().eq('cliente_id', id);
                    const { error } = await supabase.from('clientes').delete().eq('id', id);
                    if (error) throw error;
                    
                    showNotification('Cliente e todos os seus dados foram excluídos com sucesso! 🗑️', 'success');
                    await fetchAllData(false);

                } catch (error) {
                    console.error('Erro ao excluir cliente e seus dados:', error);
                    showNotification(`❌ Erro ao excluir cliente: ${error.message}`, 'error');
                } finally {
                    setSyncing(false);
                }
            }
        };

        const resetClienteForm = () => {
            state.editandoClienteId = null;
            DOMElements.clienteForm.reset();
            DOMElements.clienteFormTitle.textContent = '👤 Adicionar Novo Cliente';
            DOMElements.cancelEditClienteBtn.style.display = 'none';
            clearFormValidation(DOMElements.clienteForm);
        };
        
        const handleServicoSubmit = async (e) => {
            e.preventDefault();
            if (!validateForm(DOMElements.servicoForm)) return;
            
            const servicoData = {
                descricao: DOMElements.servicoDescricaoInput.value.trim(),
                valor: parseFloat(DOMElements.servicoValorInput.value),
            };

            setSyncing(true);
            try {
                const { error } = state.editandoServicoId
                    ? await supabase.from('servicos').update(servicoData).eq('id', state.editandoServicoId)
                    : await supabase.from('servicos').insert(servicoData);
                
                if (error) throw error;
                
                showNotification('Serviço salvo com sucesso! ✨', 'success');
                resetServicoForm();
                await fetchAllData(false);
            } catch (error) {
                console.error('Erro ao salvar serviço:', error);
                showNotification(`❌ Erro ao salvar serviço: ${error.message}`, 'error');
            } finally {
                setSyncing(false);
            }
        };

        const handleEditServico = (id) => {
            const servico = state.servicos.find(s => s.id === id);
            if (!servico) return;

            state.editandoServicoId = id;
            DOMElements.servicoFormTitle.textContent = '✨ Editar Serviço';
            DOMElements.servicoIdInput.value = servico.id;
            DOMElements.servicoDescricaoInput.value = servico.descricao;
            DOMElements.servicoValorInput.value = servico.valor;
            DOMElements.cancelEditServicoBtn.style.display = 'inline-flex';
            DOMElements.servicoDescricaoInput.focus();
        };

        const handleDeleteServico = async (id) => {
            const confirmed = await showConfirmation({ title: 'Excluir Serviço', message: 'Tem certeza que deseja excluir este serviço?' });
            if (confirmed) {
                setSyncing(true);
                try {
                    const { error } = await supabase.from('servicos').delete().eq('id', id);
                    if (error) throw error;
                    
                    showNotification('Serviço excluído com sucesso! 🗑️', 'success');
                    await fetchAllData(false);
                } catch (error) {
                    console.error('Erro ao excluir serviço:', error);
                    showNotification(`❌ Erro ao excluir serviço: ${error.message}`, 'error');
                } finally {
                    setSyncing(false);
                }
            }
        };

        const resetServicoForm = () => {
            state.editandoServicoId = null;
            DOMElements.servicoForm.reset();
            DOMElements.servicoFormTitle.textContent = '✨ Adicionar Novo Serviço';
            DOMElements.cancelEditServicoBtn.style.display = 'none';
            clearFormValidation(DOMElements.servicoForm);
        };

        const handleOrcamentoSubmit = async (e) => {
            e.preventDefault();
            if (!validateForm(DOMElements.orcamentoForm)) return;
            
            const clienteId = DOMElements.orcamentoClienteSelect.value;
            const metodosPagamento = Array.from(DOMElements.paymentMethodToggles.querySelectorAll('.active')).map(btn => btn.dataset.value).join(', ');

            if (state.novoOrcamentoItens.length === 0) {
                showNotification('Adicione pelo menos um serviço ao orçamento.', 'error');
                return;
            }

            const subtotal = state.novoOrcamentoItens.reduce((sum, item) => sum + (item.quantidade * item.valor_unitario), 0);
            const percentual = parseFloat(DOMElements.orcamentoDescontoInput.value) || 0;
            const descontoValor = subtotal * (percentual / 100);
            const total = subtotal - descontoValor;

            const orcamentoData = {
                cliente_id: clienteId,
                valor_total: total,
                desconto: descontoValor,
                desconto_percentual: percentual,
                metodo_pagamento: metodosPagamento,
                status: 'Pendente',
            };

            setSyncing(true);
            try {
                const { data: newOrcamento, error: orcamentoError } = await supabase
                    .from('orcamentos').insert(orcamentoData).select('*, clientes(*)').single();
                if (orcamentoError) throw orcamentoError;

                const itensData = state.novoOrcamentoItens.map(item => ({
                    orcamento_id: newOrcamento.id,
                    servico_id: item.servico_id,
                    descricao_servico: item.descricao,
                    quantidade: item.quantidade,
                    valor_unitario: item.valor_unitario,
                }));

                const { error: itensError } = await supabase.from('orcamento_itens').insert(itensData);
                if (itensError) {
                    await supabase.from('orcamentos').delete().eq('id', newOrcamento.id);
                    throw itensError;
                }
                
                showNotification('Orçamento salvo com sucesso! 📄', 'success');
                showConfetti();
                resetOrcamentoForm();
                await fetchAllData(false);
                showTab('historico-tab');

            } catch (error) {
                console.error('Erro ao salvar orçamento:', error);
                showNotification(`❌ Erro ao salvar orçamento: ${error.message}`, 'error');
            } finally {
                setSyncing(false);
            }
        };
        
        const handleAddServicoToOrcamento = () => {
            const servicoId = DOMElements.orcamentoServicoSelect.value;
            const quantidade = parseInt(DOMElements.orcamentoServicoQtdInput.value);

            if (!servicoId || quantidade < 1) {
                showNotification('Selecione um serviço e uma quantidade válida.', 'error');
                return;
            }

            const servico = state.servicos.find(s => s.id === servicoId);
            if (!servico) return;

            const novoItem = {
                servico_id: servico.id,
                descricao: servico.descricao,
                quantidade: quantidade,
                valor_unitario: servico.valor,
            };

            state.novoOrcamentoItens.push(novoItem);
            renderOrcamentoItens();

            DOMElements.orcamentoServicoSelect.value = "";
            DOMElements.orcamentoServicoQtdInput.value = 1;
        };
        
        const handleRemoveOrcamentoItem = (index) => {
            state.novoOrcamentoItens.splice(index, 1);
            renderOrcamentoItens();
        };

        const resetOrcamentoForm = () => {
            state.novoOrcamentoItens = [];
            DOMElements.orcamentoForm.reset();
            DOMElements.paymentMethodToggles.querySelectorAll('.active').forEach(b => b.classList.remove('active'));
            clearFormValidation(DOMElements.orcamentoForm);
            renderOrcamentoItens();
        };

        const handleDeleteOrcamento = async (id) => {
            const confirmed = await showConfirmation({
                title: 'Excluir Orçamento',
                message: 'Tem certeza que deseja excluir este orçamento e todos os seus itens? Esta ação é irreversível.',
                confirmText: 'Sim, Excluir'
            });

            if(confirmed) {
                setSyncing(true);
                try {
                    await supabase.from('orcamento_itens').delete().eq('orcamento_id', id);
                    const { error } = await supabase.from('orcamentos').delete().eq('id', id);
                    if (error) throw error;

                    showNotification('Orçamento excluído com sucesso! 🗑️', 'success');
                    await fetchAllData(false);

                } catch (error) {
                    console.error('Erro ao excluir orçamento:', error);
                    showNotification(`❌ Erro ao excluir orçamento: ${error.message}`, 'error');
                } finally {
                    setSyncing(false);
                }
            }
        };

        const handleViewOrcamento = (id) => {
            const orcamento = state.orcamentos.find(o => o.id === id);
            if (!orcamento) return;

            state.orcamentoSelecionado = orcamento;
            openModal(DOMElements.orcamentoDetailsModal.modal);
            DOMElements.orcamentoDetailsModal.title.textContent = `Detalhes do Orçamento #${orcamento.id.substring(0, 8)}`;
            displayOrcamentoDetails();
            renderStatusActions();
        };
        
        const handleViewClientDetails = (id) => {
    const cliente = state.clientes.find(c => c.id === id);
    if (!cliente) return;

    // A MUDANÇA PRINCIPAL ESTÁ AQUI: O cálculo agora é feito sob demanda
    const insights = calculateAndCacheInsightsForClient(cliente);

    const { panel } = DOMElements.clientDetailsPanel;
    const panelContent = panel.querySelector('.panel-content');
    panelContent.innerHTML = '';

    const riscoChurn = insights.riscoChurn || 0;
    const corRisco = riscoChurn > 7 ? 'var(--danger-red)' : (riscoChurn > 4 ? 'var(--accent-orange)' : 'var(--accent-green)');

    const dashboardHTML = `
        <h2 id="client-details-name">${cliente.nome}</h2>
        <p><i class="fas fa-id-card"></i> Placa: <span id="client-details-plate">${cliente.placa}</span></p>
        <p><i class="fas fa-phone"></i> Telefone: <span id="client-details-phone">${cliente.telefone}</span></p>
        
        <div class="cliente-360-dashboard" style="margin-top: var(--space-lg); border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); padding: var(--space-md);">
            <div class="cliente-scores" style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md); text-align: center;">
                <div><p style="margin:0; font-size: 0.8rem; color: var(--text-muted);">Ticket Médio</p><p style="margin:0; font-weight: 600;">${formatCurrency(insights.ticketMedio || 0)}</p></div>
                <div><p style="margin:0; font-size: 0.8rem; color: var(--text-muted);">Frequência</p><p style="margin:0; font-weight: 600;">${insights.frequenciaMedia || 'N/A'} dias</p></div>
                <div><p style="margin:0; font-size: 0.8rem; color: var(--text-muted);">Satisfação</p><p style="margin:0; font-weight: 600;">${insights.scoreSatisfacao || 5}/10</p></div>
                <div><p style="margin:0; font-size: 0.8rem; color: var(--text-muted);">Risco de Saída</p><p style="margin:0; font-weight: 600; color: ${corRisco};">${riscoChurn}/10</p></div>
            </div>
            <div class="cliente-insights" style="margin-top: var(--space-lg); background-color: var(--bg-primary); padding: var(--space-sm); border-radius: var(--border-radius-sm);">
                <p style="margin:0; font-size: 0.9rem;">💡 <strong>Próximo serviço sugerido:</strong> ${insights.proximoServicoSugerido || 'Analisando...'}</p>
            </div>
        </div>

        <hr style="margin: 16px 0; border-color: var(--border-color);">
        <h3>Histórico de Orçamentos</h3>
        <ul id="client-details-orcamentos-list" class="data-list"></ul>
        <hr style="margin: 16px 0; border-color: var(--border-color);">
        <h3>Histórico de Contatos</h3>
        <ul id="client-details-interactions-list" class="data-list"></ul>
    `;
    panelContent.insertAdjacentHTML('beforeend', dashboardHTML);
    
    const clientOrcamentos = state.orcamentos.filter(o => o.cliente_id === id).sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
    panelContent.querySelector('#client-details-orcamentos-list').innerHTML = clientOrcamentos.length > 0 ? clientOrcamentos.map(o => `
        <li data-action="view-orcamento" data-id="${o.id}" style="cursor:pointer;">
            <div class="list-item-main">
                <p class="item-title">${new Date(o.created_at).toLocaleDateString()} - ${formatCurrency(o.valor_total)}</p>
            </div>
            <span class="status-badge ${o.status?.toLowerCase()}">${o.status}</span>
        </li>
    `).join('') : '<li>Nenhum orçamento para este cliente.</li>';

    const clientInteractions = state.crmInteractions.filter(i => i.cliente_id === id).sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
    panelContent.querySelector('#client-details-interactions-list').innerHTML = clientInteractions.length > 0 ? clientInteractions.map(i => `
        <li>
            <div class="list-item-main">
                <p class="item-title">${i.tipo_interacao} em ${new Date(i.created_at).toLocaleString()}</p>
                <p class="item-subtitle">${i.descricao || 'Nenhuma descrição.'}</p>
            </div>
        </li>
    `).join('') : '<li>Nenhuma interação registrada.</li>';

    openModal(panel);
};

        const displayOrcamentoDetails = () => {
            const orcamento = state.orcamentoSelecionado;
            if (!orcamento) return;

            const itens = state.orcamentoItens.filter(i => i.orcamento_id === orcamento.id);
            const cliente = orcamento.clientes;
            const subtotal = itens.reduce((sum, i) => sum + (i.quantidade * i.valor_unitario), 0);

            const replacements = {
                '{{NOME_EMPRESA}}': state.configuracoes.empresa.nome,
                '{{CNPJ_EMPRESA}}': state.configuracoes.empresa.cnpj,
                '{{TELEFONE_EMPRESA}}': state.configuracoes.empresa.telefone,
                '{{ENDERECO_EMPRESA}}': state.configuracoes.empresa.endereco,
                '{{LINK_CATALOGO}}': state.configuracoes.empresa.catalogoLink,
                '{{CLIENTE_NOME}}': cliente?.nome || 'N/A',
                '{{CLIENTE_TELEFONE}}': cliente?.telefone || 'N/A',
                '{{CLIENTE_CARRO}}': cliente?.carro || 'N/A',
                '{{CLIENTE_PLACA}}': cliente?.placa || 'N/A',
                '{{DATA}}': new Date(orcamento.created_at).toLocaleDateString(),
                '{{LISTA_SERVICOS}}': itens.map(i => `${i.quantidade}x ${i.descricao_servico} - ${formatCurrency(i.quantidade * i.valor_unitario)}`).join('\n'),
                '{{SUBTOTAL}}': formatCurrency(subtotal),
                '{{DESCONTO_PERCENTUAL}}': orcamento.desconto_percentual || 0,
                '{{DESCONTO}}': formatCurrency(orcamento.desconto),
                '{{TOTAL}}': formatCurrency(orcamento.valor_total),
                '{{METODOS_PAGAMENTO}}': orcamento.metodo_pagamento,
                '{{AGRADECIMENTO_CLIENTE}}': `Agradecemos a preferência, ${cliente?.nome.split(' ')[0] || ''}!`,
            };

            let orcamentoText = state.aceEditors.orcamento ? state.aceEditors.orcamento.getValue() : state.configuracoes.templates.orcamento;
            let reciboText = state.aceEditors.recibo ? state.aceEditors.recibo.getValue() : state.configuracoes.templates.recibo;

            for (const key in replacements) {
                const regex = new RegExp(key.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1"), 'g');
                orcamentoText = orcamentoText.replace(regex, replacements[key]);
                reciboText = reciboText.replace(regex, replacements[key]);
            }

            DOMElements.orcamentoDetailsModal.orcamentoText.textContent = orcamentoText;
            DOMElements.orcamentoDetailsModal.reciboText.textContent = reciboText;
        };
        

        // --- FORM VALIDATION ---
        const validateForm = (form) => {
            let isValid = true;
            let firstInvalidField = null;

            form.querySelectorAll('[required], [minlength], [pattern], input[type="number"]').forEach(input => {
                const isFieldValid = validateField(input);
                if (!isFieldValid && !firstInvalidField) {
                    firstInvalidField = input;
                }
                isValid = isValid && isFieldValid;
            });
            
            if(form.id === 'orcamento-form') {
                const paymentGroup = DOMElements.paymentMethodToggles.closest('.form-group');
                const isPaymentValid = Array.from(DOMElements.paymentMethodToggles.querySelectorAll('.active')).length > 0;
                paymentGroup.classList.toggle('invalid', !isPaymentValid);
                paymentGroup.classList.toggle('valid', isPaymentValid);
                if (!isPaymentValid) isValid = false;
            }

            if (!isValid) {
                showNotification('Por favor, corrija os campos inválidos.', 'error');
                if (firstInvalidField) firstInvalidField.focus();
            }
            return isValid;
        };
        
        const validateField = (input) => {
            const formGroup = input.closest('.form-group');
            if (!formGroup) return true;

            let valid = true;
            if (input.hasAttribute('required') && !input.value.trim()) {
                valid = false;
            }
            if (valid && input.minLength > 0 && input.value.trim().length < input.minLength) {
                valid = false;
            }
            if (valid && input.type === 'number' && input.hasAttribute('min') && parseFloat(input.value) < parseFloat(input.min)) {
                valid = false;
            }
            if (valid && (input.id === 'cliente-telefone' || input.id === 'lead-telefone')) {
                 const phoneRegex = /^\(\d{2}\) \d{5}-\d{4}$/;
                 if (input.value && !phoneRegex.test(input.value)) valid = false;
            }
            if (valid && input.id === 'cliente-placa') {
                const plateRegex = /^[A-Z]{3}[0-9][A-Z0-9][0-9]{2}$/; // Mercosul or old
                 if (input.value && !plateRegex.test(input.value.toUpperCase().replace('-', ''))) valid = false;
            }

            formGroup.classList.toggle('invalid', !valid);
            formGroup.classList.toggle('valid', valid);
            return valid;
        };

        const clearFormValidation = (form) => {
            form.querySelectorAll('.form-group').forEach(fg => {
                fg.classList.remove('valid', 'invalid');
            });
        };


        // --- CRM ---
        const renderCRM = () => {
            DOMElements.crm.clientSelect.innerHTML = '<option value="">Selecione um cliente</option>' + 
                state.clientes.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');
            
            renderCrmClientList({ all: true });
            renderCrmKanban();
        };
        
        const renderCrmKanban = () => {
            const board = DOMElements.crm.tasksBoard;
            board.innerHTML = '';
            const columns = ['A Fazer', 'Em Andamento', 'Concluído'];
            
            const clientMap = new Map(state.clientes.map(c => [c.id, c.nome]));

            columns.forEach(status => {
                const columnEl = document.createElement('div');
                columnEl.className = 'kanban-column';
                columnEl.dataset.status = status;
                
                const headerEl = document.createElement('div');
                headerEl.className = 'kanban-column-header';
                
                const cardsEl = document.createElement('div');
                cardsEl.className = 'kanban-cards';

                const tasksInColumn = state.crmTasks.filter(task => (task.status || 'A Fazer') === status);
                
                headerEl.textContent = `${status} (${tasksInColumn.length})`;

                tasksInColumn.forEach(task => {
                    const cardEl = document.createElement('div');
                    const priorityClass = `task-priority-${(task.prioridade || 'baixa').toLowerCase()}`;
                    cardEl.className = `kanban-card ${priorityClass}`;
                    cardEl.dataset.id = task.id;
                    cardEl.dataset.action = 'edit-task';
                    cardEl.draggable = true;
                    
                    const clienteNome = clientMap.get(task.cliente_id) || 'Sem cliente associado';

                    cardEl.innerHTML = `
                        <p class="card-title">${task.titulo}</p>
                        <p class="card-subtitle">${clienteNome}</p>
                        ${task.data_vencimento ? `<p class="card-subtitle">Vence em: ${new Date(task.data_vencimento + 'T00:00:00').toLocaleDateString()}</p>` : ''}
                    `;
                    cardsEl.appendChild(cardEl);
                });

                columnEl.appendChild(headerEl);
                columnEl.appendChild(cardsEl);
                board.appendChild(columnEl);
            });
        };

        const handleCrmInteractionSubmit = async (e) => {
            e.preventDefault();
            const form = DOMElements.crm.form;
            const interactionData = {
                cliente_id: form.querySelector('#crm-cliente-select').value,
                tipo_interacao: form.querySelector('#crm-tipo-interacao').value,
                descricao: form.querySelector('#crm-descricao').value.trim(),
                data_proxima_acao: form.querySelector('#crm-proxima-acao').value || null,
            };

            if (!interactionData.cliente_id) {
                showNotification('Selecione um cliente.', 'error');
                return;
            }

            setSyncing(true);
            try {
                // Mudar para a nova tabela 'interacoes_cliente' seria o ideal aqui
                const { error: interactionError } = await supabase.from('crm_interactions').insert(interactionData);
                if (interactionError) throw interactionError;
                
                showNotification('Interação registrada com sucesso! 📞', 'success');

                if (interactionData.data_proxima_acao) {
                    const cliente = state.clientes.find(c => c.id === interactionData.cliente_id);
                    const taskData = {
                        cliente_id: interactionData.cliente_id,
                        titulo: `Follow-up com ${cliente?.nome || 'Cliente'}`,
                        descricao: `Referente à interação: ${interactionData.descricao || 'N/A'}`,
                        data_vencimento: interactionData.data_proxima_acao,
                        status: 'A Fazer',
                        prioridade: 'Média'
                    };
                    const { error: taskError } = await supabase.from('crm_tasks').insert(taskData);
                    if (taskError) throw taskError;
                    showNotification('Tarefa de follow-up criada no Kanban! ✅', 'success');
                }

                form.reset();
                await fetchAllData(false);
            } catch (error) {
                console.error('Erro ao registrar interação/tarefa:', error);
                showNotification(`❌ Erro: ${error.message}`, 'error');
            } finally {
                setSyncing(false);
            }
        };
        
        const renderCrmClientList = (options = { all: true }) => {
            const { minDays, maxDays, all } = options;
            const hoje = new Date();
            
            const clientLastServiceMap = new Map();
            state.clientes.forEach(cliente => {
                const clientOrcamentos = state.orcamentos
                    .filter(o => o.cliente_id === cliente.id && ['Finalizado', 'Pago'].includes(o.status))
                    .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                if (clientOrcamentos.length > 0) {
                    clientLastServiceMap.set(cliente.id, new Date(clientOrcamentos[0].created_at));
                }
            });

            let filteredClients = [];
            if (all) {
                filteredClients = [...state.clientes];
            } else {
                filteredClients = state.clientes.filter(cliente => {
                    const lastServiceDate = clientLastServiceMap.get(cliente.id);
                    if (!lastServiceDate) return false;

                    const diffTime = Math.abs(hoje - lastServiceDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    if (maxDays) {
                        return diffDays >= minDays && diffDays <= maxDays;
                    } else {
                        return diffDays >= minDays;
                    }
                });
            }
            
            state.crmFilteredClients = filteredClients;

            DOMElements.crm.inactiveClientsList.innerHTML = filteredClients.length > 0
                ? filteredClients.map(c => {
                    const lastServiceDate = clientLastServiceMap.get(c.id);
                    const lastServiceInfo = lastServiceDate 
                        ? `Último serviço em: ${lastServiceDate.toLocaleDateString()}`
                        : 'Nenhum serviço finalizado.';

                    return `
                        <li>
                            <div class="list-item-main">
                                <p class="item-title">${c.nome}</p>
                                <p class="item-subtitle">${lastServiceInfo}</p>
                            </div>
                            <button class="btn btn-sm btn-success whatsapp-link-btn" data-phone="${c.telefone}" title="Enviar WhatsApp"><i class="fab fa-whatsapp"></i></button>
                        </li>
                    `;
                }).join('')
                : `<li>Nenhum cliente encontrado para este filtro.</li>`;
        };

        const openBulkCrmModal = () => {
            const { modal, clientsList, templateCategory, templateSelect, message, setupPanel, controlPanel, startBtn } = DOMElements.crmBulkModal;
            
            setupPanel.style.display = 'block';
            controlPanel.style.display = 'none';
            startBtn.style.display = 'inline-flex';
            startBtn.disabled = false;

            const clientsToList = state.crmFilteredClients;

            clientsList.innerHTML = clientsToList.length > 0 
                ? clientsToList.map(c => {
                    return `
                        <li>
                            <label>
                                <input type="checkbox" class="crm-bulk-client-checkbox" value="${c.id}">
                                <div class="list-item-main">
                                    <p class="item-title">${c.nome}</p>
                                    <p class="item-subtitle">${c.carro || 'Carro não informado'} - ${c.placa}</p>
                                </div>
                            </label>
                        </li>
                    `;
                }).join('')
                : '<li>Nenhum cliente para selecionar.</li>';
            
            const templates = state.configuracoes.crmTemplates;
            templateCategory.innerHTML = `<option value="">Selecione uma categoria</option>` + 
                Object.keys(templates).map(cat => `<option value="${cat}">${cat}</option>`).join('');
            
            templateSelect.innerHTML = `<option value="">Selecione um template</option>`;
            message.value = '';

            openModal(modal);
        };

        const handleStartCampaign = () => {
            const { clientsList, message, startBtn, setupPanel, controlPanel } = DOMElements.crmBulkModal;
            const selectedCheckboxes = clientsList.querySelectorAll('.crm-bulk-client-checkbox:checked');
            
            if (selectedCheckboxes.length === 0 || !message.value) {
                showNotification('Selecione ao menos um cliente e uma mensagem.', 'error');
                return;
            }

            state.campaign.clients = Array.from(selectedCheckboxes).map(cb => state.clientes.find(c => c.id === cb.value));
            state.campaign.currentIndex = 0;
            state.campaign.message = message.value;

            startBtn.disabled = true;
            setupPanel.style.display = 'none';
            controlPanel.style.display = 'block';

            updateCampaignProgress();
        };

        const processNextClient = () => {
            const { clients, currentIndex, message } = state.campaign;
            if (currentIndex >= clients.length) return;

            const client = clients[currentIndex];
            if (client && client.telefone) {
                const personalizedMessage = message.replace(/{{CLIENTE_NOME}}/g, client.nome.split(' ')[0]);
                const phone = `55${client.telefone.replace(/\D/g, '')}`;
                const url = `https://wa.me/${phone}?text=${encodeURIComponent(personalizedMessage)}`;
                window.open(url, '_blank');
            }

            state.campaign.currentIndex++;
            updateCampaignProgress();
        };

        const updateCampaignProgress = () => {
            const { clients, currentIndex } = state.campaign;
            const { progressText, nextClientText, sendNextBtn } = DOMElements.crmBulkModal;

            if (currentIndex < clients.length) {
                progressText.textContent = `Enviando ${currentIndex + 1} de ${clients.length}`;
                nextClientText.textContent = `Próximo: ${clients[currentIndex].nome}`;
                sendNextBtn.disabled = false;
            } else {
                progressText.innerHTML = `<i class="fas fa-check-circle" style="color: var(--accent-green);"></i> Campanha Concluída!`;
                nextClientText.textContent = `${clients.length} mensagens preparadas.`;
                sendNextBtn.disabled = true;
                sendNextBtn.textContent = "Finalizado";
            }
        };

        const openTaskModal = (id = null) => {
            const { createTaskModal } = DOMElements;
            createTaskModal.form.reset();
            clearFormValidation(createTaskModal.form);
            state.editandoTaskId = null;

            createTaskModal.clientSelect.innerHTML = '<option value="">Nenhum cliente</option>' +
                state.clientes.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');

            if (id) {
                const task = state.crmTasks.find(t => t.id === id);
                if (task) {
                    state.editandoTaskId = id;
                    createTaskModal.formTitle.textContent = "Editar Tarefa";
                    createTaskModal.form.querySelector('#task-id').value = task.id;
                    createTaskModal.form.querySelector('#task-titulo').value = task.titulo;
                    createTaskModal.form.querySelector('#task-cliente').value = task.cliente_id || "";
                    createTaskModal.form.querySelector('#task-data-vencimento').value = task.data_vencimento;
                    createTaskModal.form.querySelector('#task-prioridade').value = task.prioridade;
                    createTaskModal.form.querySelector('#task-descricao').value = task.descricao;
                    createTaskModal.deleteBtn.style.display = 'inline-flex';
                }
            } else {
                createTaskModal.formTitle.textContent = "Criar Nova Tarefa";
                createTaskModal.deleteBtn.style.display = 'none';
            }
            openModal(createTaskModal.modal);
        };

        const handleEditTask = (id) => {
            openTaskModal(id);
        };

        const handleTaskSubmit = async (e) => {
            e.preventDefault();
            const form = DOMElements.createTaskModal.form;
            if (!validateForm(form)) return;

            const taskData = {
                titulo: form.querySelector('#task-titulo').value.trim(),
                cliente_id: form.querySelector('#task-cliente').value || null,
                data_vencimento: form.querySelector('#task-data-vencimento').value || null,
                prioridade: form.querySelector('#task-prioridade').value,
                descricao: form.querySelector('#task-descricao').value.trim(),
                status: state.editandoTaskId ? state.crmTasks.find(t => t.id === state.editandoTaskId).status : 'A Fazer'
            };

            setSyncing(true);
            try {
                const { error } = state.editandoTaskId
                    ? await supabase.from('crm_tasks').update(taskData).eq('id', state.editandoTaskId)
                    : await supabase.from('crm_tasks').insert(taskData);

                if (error) throw error;
                showNotification(`Tarefa ${state.editandoTaskId ? 'atualizada' : 'criada'} com sucesso!`, 'success');
                closeModal(DOMElements.createTaskModal.modal);
                await fetchAllData(false);
            } catch (error) {
                console.error('Erro ao salvar tarefa:', error);
                showNotification(`❌ Erro ao salvar tarefa: ${error.message}`, 'error');
            } finally {
                setSyncing(false);
            }
        };

        const handleDeleteTask = async (id) => {
            if (!id) return;
            const confirmed = await showConfirmation({ title: 'Excluir Tarefa', message: 'Tem certeza que deseja excluir esta tarefa?' });
            if (confirmed) {
                setSyncing(true);
                try {
                    const { error } = await supabase.from('crm_tasks').delete().eq('id', id);
                    if (error) throw error;
                    showNotification('Tarefa excluída com sucesso.', 'success');
                    closeModal(DOMElements.createTaskModal.modal);
                    await fetchAllData(false);
                } catch(error) {
                    console.error('Erro ao excluir tarefa:', error);
                    showNotification(`❌ Erro ao excluir: ${error.message}`, 'error');
                } finally {
                    setSyncing(false);
                }
            }
        };

        // --- CONFIGURAÇÕES ---
        const saveConfig = async () => {
            try {
                // Remove a propriedade 'id' do objeto principal para evitar conflito na atualização do JSONB
                const configToSave = { ...state.configuracoes };
                delete configToSave.id;

                const { error } = await supabase
                    .from('configuracoes')
                    .update(configToSave)
                    .eq('id', state.configuracoes.id);
                if (error) throw error;
                showNotification('⚙️ Configurações salvas na nuvem!', 'info', 1500);
            } catch (error) {
                console.error("Erro ao salvar configurações:", error);
                showNotification(`❌ Erro ao salvar configurações: ${error.message}`, 'error');
            }
        };

        const loadConfig = async () => {
            try {
                const { data, error } = await supabase.from('configuracoes').select('*').eq('id', 1).single();
                if (data) {
                    const parsedConfig = data;
                    state.configuracoes.empresa = {...state.configuracoes.empresa, ...parsedConfig.empresa};
                    state.configuracoes.templates = {...state.configuracoes.templates, ...parsedConfig.templates};
                    state.configuracoes.crmTemplates = {
                        ...JSON.parse(JSON.stringify(defaultCrmTemplates)), 
                        ...(parsedConfig.crmTemplates || {})
                    };
                    state.configuracoes.visual = {
                        ...state.configuracoes.visual, 
                        ...parsedConfig.visual,
                        colors: { ...defaultColors, ...(parsedConfig.visual.colors || {}) }
                    };
                } else {
                   if (error && error.code !== 'PGRST116') throw error; // PGRST116 = no rows found
                   console.log("Nenhuma configuração encontrada na nuvem, usando e salvando padrão.");
                   await saveConfig(); // Salva a configuração padrão se nenhuma existir
                }
            } catch (error) {
                 console.error("Erro ao carregar configurações:", error);
            } finally {
                applyConfig();
            }
        };
        
        const applyConfig = () => {
            const { visual, empresa } = state.configuracoes;
            const root = document.documentElement;

            Object.keys(visual.colors).forEach(key => {
                const cssVar = '--' + key.replace(/([A-Z])/g, '-$1').toLowerCase();
                root.style.setProperty(cssVar, visual.colors[key]);
            });
            root.style.setProperty('--primary-red-dark', darkenColor(visual.colors.primaryRed, 15));
            document.body.classList.toggle('light-mode', visual.theme === 'light');
            DOMElements.headerTitle.textContent = empresa.nome;
            DOMElements.headerLogo.src = empresa.logo;
            root.style.setProperty('--watermark-url', visual.watermarkEnabled ? `url(${empresa.logo})` : 'none');
            root.style.setProperty('--bg-image-url', visual.backgroundImage ? `url(${visual.backgroundImage})` : 'none');
            root.style.setProperty('--bg-image-opacity', visual.backgroundImageOpacity);
        };

        const populateConfigForm = () => {
            const { config } = DOMElements;
            const { empresa, visual, templates } = state.configuracoes;
            config.nome.value = empresa.nome;
            config.cnpj.value = empresa.cnpj;
            config.telefone.value = empresa.telefone;
            config.endereco.value = empresa.endereco;
            config.catalogoLink.value = empresa.catalogoLink;
            config.logoPreview.src = empresa.logo;
            
            const themeIcon = DOMElements.config.themeToggle.querySelector('i');
            themeIcon.className = visual.theme === 'light' ? 'fas fa-sun' : 'fas fa-moon';
            
            config.watermarkToggle.checked = visual.watermarkEnabled;
            config.bgImageOpacity.value = visual.backgroundImageOpacity;
            
            config.colorPickers.forEach(picker => {
                const colorVar = picker.dataset.colorVar.replace('--','').replace(/-([a-z])/g, g => g[1].toUpperCase());
                if(visual.colors[colorVar]) {
                    picker.value = visual.colors[colorVar];
                }
            });
            
            setupAceEditor('orcamento', config.templateOrcamento, templates.orcamento);
            setupAceEditor('recibo', config.templateRecibo, templates.recibo);
            
            populateCrmTemplatesConfig();
        };

        const populateCrmTemplatesConfig = () => {
            const container = DOMElements.config.crmTemplatesEditorContainer;
            const templates = state.configuracoes.crmTemplates;
            let html = `<p class="text-muted" style="font-size: 0.8rem; line-height: 1.5; margin-bottom: var(--space-md);"><b>Gabarito de Variáveis:</b><br>{{CLIENTE_NOME}}, {{LINK_CATALOGO}}</p>`;

            for (const category in templates) {
                const categoryTemplates = templates[category];
                let templatesHTML = categoryTemplates.map((template, index) => `
                    <div class="template-editor-item">
                        <div class="form-group">
                            <label>Título do Template</label>
                            <input type="text" class="template-title-input" value="${template.title}" data-category="${category}" data-index="${index}">
                        </div>
                        <div class="form-group">
                            <label>Texto da Mensagem</label>
                            <textarea rows="4" class="template-text-input" data-category="${category}" data-index="${index}">${template.text}</textarea>
                        </div>
                        <div class="template-editor-actions">
                            <button class="btn btn-danger btn-sm btn-icon" data-action="delete-crm-template" data-category="${category}" data-index="${index}" title="Excluir Template">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');

                html += `
                    <div class="template-category">
                        <h4>${category}</h4>
                        ${templatesHTML}
                        <button class="btn btn-secondary btn-sm" data-action="add-crm-template" data-category="${category}">
                            <i class="fas fa-plus"></i> Adicionar Novo Template em ${category}
                        </button>
                    </div>
                `;
            }
            container.innerHTML = html;
        };
        
        const setupAceEditor = (name, element, content) => {
            if (state.aceEditors[name]) {
                state.aceEditors[name].setValue(content, 1);
                return;
            }
            const editor = ace.edit(element);
            const theme = state.configuracoes.visual.theme === 'dark' ? 'ace/theme/tomorrow_night' : 'ace/theme/github';
            editor.setTheme(theme);
            editor.session.setMode("ace/mode/text");
            editor.setValue(content, 1);
            editor.session.on('change', debounce(() => {
                if (name === 'orcamento') state.configuracoes.templates.orcamento = editor.getValue();
                if (name === 'recibo') state.configuracoes.templates.recibo = editor.getValue();
                saveConfig();
            }, 500));
            state.aceEditors[name] = editor;
        };
        
        const handleConfigChange = (e) => {
            const { id, value, type, checked } = e.target;
            const { visual, empresa } = state.configuracoes;

            switch(id) {
                case 'config-nome': empresa.nome = value; break;
                case 'config-cnpj': empresa.cnpj = value; break;
                case 'config-telefone': empresa.telefone = value; break;
                case 'config-endereco': empresa.endereco = value; break;
                case 'config-catalogo-link': empresa.catalogoLink = value; break;
                case 'config-watermark-toggle': visual.watermarkEnabled = checked; break;
                case 'config-bg-image-opacity': visual.backgroundImageOpacity = value; break;
            }
            applyConfig();
            saveConfig();
        };
        
        const handleColorChange = (e) => {
            const colorVar = e.target.dataset.colorVar.replace('--','').replace(/-([a-z])/g, g => g[1].toUpperCase());
            state.configuracoes.visual.colors[colorVar] = e.target.value;
            applyConfig();
            saveConfig();
        };

        const handleImageUpload = (e, target) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                if (target === 'logo') {
                    state.configuracoes.empresa.logo = event.target.result;
                } else if (target === 'background') {
                    state.configuracoes.visual.backgroundImage = event.target.result;
                }
                applyConfig();
                saveConfig();
                populateConfigForm();
            };
            reader.readAsDataURL(file);
        };
        
        const darkenColor = (hex, percent) => {
            let r = parseInt(hex.slice(1, 3), 16),
                g = parseInt(hex.slice(3, 5), 16),
                b = parseInt(hex.slice(5, 7), 16);
            r = Math.floor(r * (100 - percent) / 100);
            g = Math.floor(g * (100 - percent) / 100);
            b = Math.floor(b * (100 - percent) / 100);
            return `#${((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1)}`;
        };
        
        // --- PDF, COPY, STATUS ---
        const handleCopyToClipboard = async () => {
            const activeView = DOMElements.orcamentoDetailsModal.orcamentoView.style.display !== 'none' ? 'orcamento' : 'recibo';
            const textToCopy = activeView === 'orcamento' 
                ? DOMElements.orcamentoDetailsModal.orcamentoText.textContent
                : DOMElements.orcamentoDetailsModal.reciboText.textContent;
            
            try {
                await navigator.clipboard.writeText(textToCopy);
                showNotification('Texto copiado para a área de transferência!', 'success');
            } catch (err) {
                showNotification('Falha ao copiar texto.', 'error');
                console.error('Clipboard error:', err);
            }
        };

        const handleGeneratePdf = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const activeView = DOMElements.orcamentoDetailsModal.orcamentoView.style.display !== 'none' ? 'orcamento' : 'recibo';
            const text = activeView === 'orcamento' 
                ? DOMElements.orcamentoDetailsModal.orcamentoText.textContent
                : DOMElements.orcamentoDetailsModal.reciboText.textContent;

            doc.setFont('courier');
            doc.setFontSize(10);
            doc.text(text, 10, 10);
            doc.save(`${activeView}_${state.orcamentoSelecionado.id.substring(0,8)}.pdf`);
        };

        const renderStatusActions = () => {
            const { status } = state.orcamentoSelecionado;
            const actionsContainer = DOMElements.orcamentoDetailsModal.statusActions;
            actionsContainer.innerHTML = '';

            const possibleActions = {
                'Pendente': [
                    { label: 'Aprovar', newStatus: 'Aprovado', class: 'btn-success' },
                    { label: 'Cancelar', newStatus: 'Cancelado', class: 'btn-danger' }
                ],
                'Aprovado': [
                    { label: 'Finalizar Serviço', newStatus: 'Finalizado', class: 'btn-primary' },
                    { label: 'Cancelar', newStatus: 'Cancelado', class: 'btn-danger' }
                ],
                'Finalizado': [
                    { label: 'Marcar como Pago', newStatus: 'Pago', class: 'btn-success' }
                ],
                'Pago': [],
                'Cancelado': []
            };

            if (possibleActions[status]) {
                possibleActions[status].forEach(action => {
                    const button = document.createElement('button');
                    button.className = `btn btn-sm ${action.class}`;
                    button.textContent = action.label;
                    button.onclick = () => handleChangeStatus(action.newStatus);
                    actionsContainer.appendChild(button);
                });
            }
        };

        const handleChangeStatus = async (newStatus) => {
            const confirmed = await showConfirmation({
                title: 'Mudar Status',
                message: `Tem certeza que deseja mudar o status para "${newStatus}"?`
            });
            if (!confirmed) return;

            setSyncing(true);
            try {
                const updateData = { status: newStatus };
                if (newStatus === 'Finalizado') {
                    updateData.data_finalizado = new Date().toISOString();
                }
                const { error } = await supabase.from('orcamentos')
                    .update(updateData)
                    .eq('id', state.orcamentoSelecionado.id);
                
                if (error) throw error;
                
                showNotification(`Status atualizado para ${newStatus}!`, 'success');

                // Automação de Follow-up
                if (newStatus === 'Pago') {
                    const cliente = state.orcamentos.find(o => o.id === state.orcamentoSelecionado.id)?.clientes;
                    if (cliente) {
                        const dueDate = new Date();
                        dueDate.setDate(dueDate.getDate() + 3);
                        const taskData = {
                            cliente_id: cliente.id,
                            titulo: `Pedir feedback para ${cliente.nome.split(' ')[0]}`,
                            descricao: `Entrar em contato para pedir feedback sobre o serviço do orçamento #${state.orcamentoSelecionado.id.substring(0, 8)}.`,
                            data_vencimento: dueDate.toISOString().split('T')[0],
                            status: 'A Fazer',
                            prioridade: 'Baixa'
                        };
                        const { error: taskError } = await supabase.from('crm_tasks').insert(taskData);
                        if (taskError) throw taskError;
                        showNotification('Tarefa de feedback criada no CRM!', 'success');
                    }
                }

                await fetchAllData(false);
                
                 const updatedOrcamento = state.orcamentos.find(o => o.id === state.orcamentoSelecionado.id);
                 if (updatedOrcamento) {
                       state.orcamentoSelecionado = updatedOrcamento;
                       renderStatusActions();
                 } else {
                       closeModal(DOMElements.orcamentoDetailsModal.modal);
                 }

            } catch (error) {
                console.error('Erro ao mudar status:', error);
                showNotification(`❌ Erro: ${error.message}`, 'error');
            } finally {
                setSyncing(false);
            }
        };

        // --- AGENDA FUNCTIONS ---
        const renderAgenda = () => {
            const { agenda } = DOMElements;
            const todayStr = state.agendaDataAtual.toISOString().split('T')[0];
            agenda.datePicker.value = todayStr;
        
            const container = agenda.gridContainer;
            container.innerHTML = ''; 
        
            const agendamentosDoDia = state.agendamentos
                .filter(a => a.data_agendamento === todayStr)
                .sort((a, b) => a.hora_agendamento.localeCompare(b.hora_agendamento));
        
            if (agendamentosDoDia.length === 0) {
                container.innerHTML = `<div class="no-agenda-message"><i class="fas fa-calendar-times fa-2x"></i><p>Nenhum agendamento para este dia.</p></div>`;
                return;
            }
        
            agendamentosDoDia.forEach(agendamento => {
                const card = document.createElement('div');
                card.className = `agenda-card status-${agendamento.status.toLowerCase()}`;
                card.dataset.id = agendamento.id;
        
                card.innerHTML = `
                    <div class="agenda-card-header">
                        <span class="agenda-card-time">${agendamento.hora_agendamento.substring(0, 5)}</span>
                        <span class="status-badge ${agendamento.status.toLowerCase()}">${agendamento.status}</span>
                    </div>
                    <div class="agenda-card-body">
                        <p class="client-name">${agendamento.clientes?.nome || 'Cliente não encontrado'}</p>
                        <p class="services">${agendamento.descricao}</p>
                    </div>
                `;
                container.appendChild(card);
            });
        };

        const openAgendamentoModal = (id = null) => {
            const { agenda } = DOMElements;
            agenda.form.reset();
            clearFormValidation(agenda.form);
            state.editandoAgendamentoId = null;

            agenda.clienteSelect.innerHTML = '<option value="">Selecione um cliente</option>' + 
                state.clientes.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');

            if (id) {
                const agendamento = state.agendamentos.find(a => a.id === id);
                if (agendamento) {
                    state.editandoAgendamentoId = id;
                    agenda.formTitle.textContent = "Editar Agendamento";
                    agenda.idInput.value = agendamento.id;
                    agenda.clienteSelect.value = agendamento.cliente_id;
                    agenda.servicosInput.value = agendamento.descricao;
                    agenda.dataInput.value = agendamento.data_agendamento;
                    agenda.horaInput.value = agendamento.hora_agendamento;
                    agenda.statusSelect.value = agendamento.status;
                    agenda.observacoesInput.value = agendamento.observacoes;
                    agenda.deleteBtn.style.display = 'inline-flex';
                }
            } else {
                agenda.formTitle.textContent = "Novo Agendamento";
                agenda.dataInput.value = state.agendaDataAtual.toISOString().split('T')[0];
                agenda.deleteBtn.style.display = 'none';
            }
            openModal(agenda.modal);
        };
        
        const handleAgendamentoSubmit = async (e) => {
            e.preventDefault();
            if(!validateForm(DOMElements.agenda.form)) return;

            const { agenda } = DOMElements;
            const agendamentoData = {
                cliente_id: agenda.clienteSelect.value,
                descricao: agenda.servicosInput.value.trim(),
                data_agendamento: agenda.dataInput.value,
                hora_agendamento: agenda.horaInput.value,
                status: agenda.statusSelect.value,
                observacoes: agenda.observacoesInput.value.trim(),
            };

            setSyncing(true);
            try {
                const { error } = state.editandoAgendamentoId
                    ? await supabase.from('agendamentos').update(agendamentoData).eq('id', state.editandoAgendamentoId)
                    : await supabase.from('agendamentos').insert(agendamentoData);

                if (error) throw error;

                showNotification(`Agendamento ${state.editandoAgendamentoId ? 'atualizado' : 'criado'} com sucesso! 📅`, 'success');
                closeModal(agenda.modal);
                await fetchAllData(false);
            } catch (error) {
                console.error("Erro ao salvar agendamento:", error);
                showNotification(`❌ Erro ao salvar agendamento: ${error.message}`, 'error');
            } finally {
                setSyncing(false);
            }
        };

        const handleDeleteAgendamento = async (id) => {
            if (!id) return;
            const confirmed = await showConfirmation({ title: 'Excluir Agendamento', message: 'Tem certeza que deseja excluir este agendamento?' });
            if (confirmed) {
                setSyncing(true);
                try {
                    const { error } = await supabase.from('agendamentos').delete().eq('id', id);
                    if (error) throw error;
                    showNotification('Agendamento excluído com sucesso. 🗑️', 'success');
                    closeModal(DOMElements.agenda.modal);
                    await fetchAllData(false);
                } catch(error) {
                    console.error('Erro ao excluir agendamento:', error);
                    showNotification(`❌ Erro ao excluir: ${error.message}`, 'error');
                } finally {
                    setSyncing(false);
                }
            }
        };
        
        // --- FLUXO DE CAIXA HANDLERS ---
        const handleDespesaSubmit = async (e) => {
            e.preventDefault();
            const form = DOMElements.fluxoCaixa.despesaForm;
            if (!validateForm(form)) return;

            const despesaData = {
                descricao: form.querySelector('#despesa-descricao').value,
                valor: parseFloat(form.querySelector('#despesa-valor').value),
                data_despesa: form.querySelector('#despesa-data').value,
            };

            setSyncing(true);
            try {
                const { error } = await supabase.from('despesas').insert(despesaData);
                if (error) throw error;

                showNotification('Despesa adicionada com sucesso!', 'success');
                form.reset();
                clearFormValidation(form);
                await fetchAllData(false); // Refetch to update list and totals
            } catch (error) {
                console.error('Erro ao salvar despesa:', error);
                showNotification(`❌ Erro ao salvar despesa: ${error.message}`, 'error');
            } finally {
                setSyncing(false);
            }
        };

        const handleDeleteDespesa = async (id) => {
            const confirmed = await showConfirmation({ title: 'Excluir Despesa', message: 'Tem certeza?' });
            if (confirmed) {
                setSyncing(true);
                try {
                    const { error } = await supabase.from('despesas').delete().eq('id', id);
                    if (error) throw error;
                    showNotification('Despesa excluída com sucesso.', 'success');
                    await fetchAllData(false);
                } catch(error) {
                    console.error('Erro ao excluir despesa:', error);
                    showNotification(`❌ Erro ao excluir despesa: ${error.message}`, 'error');
                } finally {
                    setSyncing(false);
                }
            }
        };

        // --- NOTIFICATION SYSTEM ---
        const updateNotifications = () => {
            const { notificationBadge, notificationList } = DOMElements;
            const notifications = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const todayStr = `${year}-${month}-${day}`;

            // 1. Agendamentos para hoje
            const agendamentosHoje = state.agendamentos.filter(a => a.data_agendamento === todayStr);
            agendamentosHoje.forEach(a => {
                notifications.push({
                    icon: 'fa-calendar-day',
                    text: `${a.hora_agendamento.substring(0,5)} - ${a.clientes?.nome || 'Cliente'}`,
                    subtitle: a.descricao
                });
            });

            // 2. Follow-ups (Tarefas) Vencidos ou Vencendo Hoje
            const tarefasPendentes = state.crmTasks.filter(t => {
                if (t.status === 'Concluído' || !t.data_vencimento) return false;
                const taskDate = new Date(t.data_vencimento + 'T00:00:00');
                return taskDate <= today;
            });

            tarefasPendentes.forEach(t => {
                const cliente = state.clientes.find(c => c.id === t.cliente_id);
                notifications.push({
                    icon: 'fa-clipboard-list',
                    text: `Follow-up: ${t.titulo}`,
                    subtitle: `Cliente: ${cliente?.nome || 'N/A'}`
                });
            });
            
            // 3. Alertas de Churn (Clientes em Risco) - MODIFICAÇÃO CDP 360°
            const clientesEmRisco = state.clientes.filter(c => c.insights?.riscoChurn >= 8);
            clientesEmRisco.forEach(c => {
                const orcamentosDoCliente = state.orcamentos.filter(o => o.cliente_id === c.id);
                if (orcamentosDoCliente.length > 0) {
                    const ultimoServico = orcamentosDoCliente.sort((a, b) => new Date(b.created_at) - new Date(a.created_at))[0];
                    const diasSemRetorno = Math.round((new Date() - new Date(ultimoServico.created_at)) / (1000 * 60 * 60 * 24));

                    notifications.push({
                        icon: 'fa-user-clock',
                        text: `Risco de Churn: ${c.nome}`,
                        subtitle: `Sem retorno há ${diasSemRetorno} dias. Iniciar campanha!`
                    });
                }
            });
            
            // Renderiza as notificações
            if (notifications.length > 0) {
                notificationBadge.textContent = notifications.length;
                notificationBadge.style.display = 'flex';
                notificationList.innerHTML = notifications.map(n => `
                    <li>
                        <div class="list-item-main">
                            <i class="fas ${n.icon}"></i>
                            <div>
                                <p class="item-title">${n.text}</p>
                                <p class="item-subtitle">${n.subtitle}</p>
                            </div>
                        </div>
                    </li>
                `).join('');
            } else {
                notificationBadge.style.display = 'none';
                notificationList.innerHTML = `<li><p class="text-muted" style="text-align:center; padding: var(--space-md) 0;">Nenhuma notificação para hoje.</p></li>`;
            }
        };

        // --- EVENT LISTENERS ---
        const updateOrcamentoTotal = () => {
            const subtotal = state.novoOrcamentoItens.reduce((sum, item) => sum + (item.quantidade * item.valor_unitario), 0);
            const percentual = parseFloat(DOMElements.orcamentoDescontoInput.value) || 0;
            const descontoValor = subtotal * (percentual / 100);
            const total = subtotal - descontoValor;
            DOMElements.orcamentoTotalSpan.textContent = formatCurrency(total);
        };

        const setupEventListeners = () => {
            document.addEventListener('click', (e) => {
                const button = e.target.closest('.btn, .nav-link');
                if (button) {
                    rippleEffect(e, button);
                }

                if (DOMElements.mainNav.classList.contains('open') && !DOMElements.mainNav.contains(e.target) && !DOMElements.hamburgerMenu.contains(e.target)) {
                    DOMElements.mainNav.classList.remove('open');
                }
                
                if (DOMElements.notificationPanel.classList.contains('open') && !DOMElements.notificationPanel.contains(e.target) && !DOMElements.notificationBellBtn.contains(e.target)) {
                    DOMElements.notificationPanel.classList.remove('open');
                }

                const actionTarget = e.target.closest('[data-action]');
                if (actionTarget) {
                    e.preventDefault();
                    const { action, id, tab, category, index } = actionTarget.dataset;
                    switch (action) {
                        case 'navigate': showTab(tab); break;
                        case 'edit-cliente': handleEditCliente(id); break;
                        case 'delete-cliente': handleDeleteCliente(id); break;
                        case 'details-cliente': handleViewClientDetails(id); break;
                        case 'edit-servico': handleEditServico(id); break;
                        case 'delete-servico': handleDeleteServico(id); break;
                        case 'remove-orc-item': handleRemoveOrcamentoItem(parseInt(actionTarget.closest('tr').dataset.index)); break;
                        case 'view-orcamento': handleViewOrcamento(id); break;
                        case 'delete-orcamento': handleDeleteOrcamento(id); break;
                        case 'delete-despesa': handleDeleteDespesa(id); break;
                        case 'add-crm-template':
                            state.configuracoes.crmTemplates[category].push({ title: 'Novo Template', text: 'Nova mensagem...' });
                            saveConfig();
                            populateCrmTemplatesConfig();
                            break;
                        case 'delete-crm-template':
                            state.configuracoes.crmTemplates[category].splice(index, 1);
                            saveConfig();
                            populateCrmTemplatesConfig();
                            break;
                    }
                }
                
                const agendaItem = e.target.closest('.agenda-card');
                if (agendaItem) {
                    openAgendamentoModal(agendaItem.dataset.id);
                }
                
                const kanbanCard = e.target.closest('.kanban-card');
                if(kanbanCard) {
                    handleEditTask(kanbanCard.dataset.id);
                }

                const whatsappBtn = e.target.closest('.whatsapp-link-btn');
                if (whatsappBtn) {
                    const phone = whatsappBtn.dataset.phone;
                    if (phone && phone.replace(/\D/g, '').length > 10) {
                        window.open(`https://wa.me/55${phone.replace(/\D/g, '')}`, '_blank');
                    } else {
                        showNotification('Este cliente não possui um número de telefone válido.', 'error');
                    }
                }
            });

            DOMElements.hamburgerMenu.addEventListener('click', () => DOMElements.mainNav.classList.toggle('open'));
            DOMElements.notificationBellBtn.addEventListener('click', () => DOMElements.notificationPanel.classList.toggle('open'));

            DOMElements.navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    showTab(link.dataset.tab);
                    DOMElements.mainNav.classList.remove('open');
                });
            });
            
            window.addEventListener('scroll', () => {
                DOMElements.backToTopBtn.classList.toggle('show', window.scrollY > 300);
            });
            DOMElements.backToTopBtn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));

            DOMElements.syncButton.addEventListener('click', () => fetchAllData(true));
            DOMElements.clienteForm.addEventListener('submit', handleClienteSubmit);
            DOMElements.cancelEditClienteBtn.addEventListener('click', resetClienteForm);
            DOMElements.servicoForm.addEventListener('submit', handleServicoSubmit);
            DOMElements.cancelEditServicoBtn.addEventListener('click', resetServicoForm);
            DOMElements.orcamentoForm.addEventListener('submit', handleOrcamentoSubmit);
            DOMElements.crm.form.addEventListener('submit', handleCrmInteractionSubmit);
            DOMElements.agenda.form.addEventListener('submit', handleAgendamentoSubmit);
            DOMElements.fluxoCaixa.despesaForm.addEventListener('submit', handleDespesaSubmit);
            
            const applyPhoneMask = (e) => {
                let v = e.target.value.replace(/\D/g, '');
                v = v.replace(/^(\d{2})(\d)/g, '($1) $2');
                v = v.replace(/(\d{5})(\d)/, '$1-$2');
                e.target.value = v.slice(0, 15);
            };
const applyCnpjMask = (e) => {
    let v = e.target.value.replace(/\D/g, '');
    v = v.replace(/^(\d{2})(\d)/, '$1.$2');
    v = v.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
    v = v.replace(/\.(\d{3})(\d)/, '.$1/$2');
    v = v.replace(/(\d{4})(\d)/, '$1-$2');
    e.target.value = v.slice(0, 18);
};

            DOMElements.clienteTelefoneInput.addEventListener('input', applyPhoneMask);
            DOMElements.config.cnpj.addEventListener('input', applyCnpjMask);
            DOMElements.clientePlacaInput.addEventListener('input', (e) => {
                e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '').slice(0, 7);
            });

            DOMElements.searchClienteInput.addEventListener('input', debounce(renderClientes, 300));
            DOMElements.sortClienteSelect.addEventListener('change', renderClientes);
            DOMElements.searchServicoInput.addEventListener('input', debounce(renderServicos, 300));
            DOMElements.sortServicoSelect.addEventListener('change', renderServicos);

            DOMElements.addServicoBtn.addEventListener('click', handleAddServicoToOrcamento);
            DOMElements.orcamentoDescontoInput.addEventListener('input', updateOrcamentoTotal);
            DOMElements.paymentMethodToggles.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;
                button.classList.toggle('active');
                validateForm(DOMElements.orcamentoForm);
            });

            [DOMElements.historicoSearchInput, DOMElements.historicoStatusFilter, DOMElements.historicoDataInicioInput, DOMElements.historicoDataFimInput].forEach(el => {
                el.addEventListener('input', debounce(renderHistorico, 300));
            });
            DOMElements.historicoLimparFiltrosBtn.addEventListener('click', () => {
                DOMElements.historicoSearchInput.value = '';
                DOMElements.historicoStatusFilter.value = '';
                DOMElements.historicoDataInicioInput.value = '';
                DOMElements.historicoDataFimInput.value = '';
                renderHistorico();
            });
            
            DOMElements.orcamentoDetailsModal.viewSwitcher.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;
                const view = button.dataset.view;
                DOMElements.orcamentoDetailsModal.orcamentoView.style.display = view === 'orcamento' ? 'block' : 'none';
                DOMElements.orcamentoDetailsModal.reciboView.style.display = view === 'recibo' ? 'block' : 'none';
                DOMElements.orcamentoDetailsModal.viewSwitcher.querySelectorAll('.active').forEach(b => b.classList.remove('active'));
                button.classList.add('active');
            });
            
            DOMElements.orcamentoDetailsModal.copyBtn.addEventListener('click', handleCopyToClipboard);
            DOMElements.orcamentoDetailsModal.pdfBtn.addEventListener('click', handleGeneratePdf);
            DOMElements.orcamentoDetailsModal.whatsappBtn.addEventListener('click', () => {
                if (!state.orcamentoSelecionado || !state.orcamentoSelecionado.clientes || !state.orcamentoSelecionado.clientes.telefone) {
                    showNotification('Cliente não possui um telefone válido.', 'error');
                    return;
                }
                const phone = `55${state.orcamentoSelecionado.clientes.telefone.replace(/\D/g, '')}`;
                const activeView = DOMElements.orcamentoDetailsModal.orcamentoView.style.display !== 'none' ? 'orcamento' : 'recibo';
                const text = activeView === 'orcamento'
                    ? DOMElements.orcamentoDetailsModal.orcamentoText.textContent
                    : DOMElements.orcamentoDetailsModal.reciboText.textContent;
                window.open(`https://wa.me/${phone}?text=${encodeURIComponent(text)}`, '_blank');
            });
            
           // CÓDIGO NOVO - DEPOIS
document.querySelectorAll('.modal-close-btn, .panel-close-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const modal = btn.closest('.modal, .side-panel');
        closeModal(modal);
    });
});
            document.addEventListener('keydown', (e) => {
                if (e.key === "Escape") {
                    document.querySelectorAll('.modal, .side-panel.open').forEach(modal => closeModal(modal));
                }
            });
            
            DOMElements.modalOverlay.addEventListener('click', (e) => {
                if(e.target === DOMElements.modalOverlay) {
                    document.querySelectorAll('.modal').forEach(modal => closeModal(modal));
                    closeModal(DOMElements.clientDetailsPanel.panel);
                }
            });
            
            document.querySelectorAll('form[novalidate]').forEach(form => {
                form.addEventListener('input', e => validateField(e.target));
                form.addEventListener('focusout', e => validateField(e.target));
            });
            
            DOMElements.crm.createTaskBtn.addEventListener('click', () => openTaskModal());
            DOMElements.createTaskModal.form.addEventListener('submit', handleTaskSubmit);
            DOMElements.createTaskModal.deleteBtn.addEventListener('click', () => handleDeleteTask(state.editandoTaskId));

            // Config Listeners
            DOMElements.config.logoUpload.addEventListener('change', (e) => handleImageUpload(e, 'logo'));
            DOMElements.config.bgImageUpload.addEventListener('change', (e) => handleImageUpload(e, 'background'));
            DOMElements.config.removeBgImageBtn.addEventListener('click', () => {
                state.configuracoes.visual.backgroundImage = '';
                applyConfig();
                saveConfig();
            });
            DOMElements.config.resetColorsBtn.addEventListener('click', () => {
                state.configuracoes.visual.colors = { ...defaultColors };
                applyConfig();
                saveConfig();
                populateConfigForm();
            });
            DOMElements.config.colorPickers.forEach(picker => picker.addEventListener('input', debounce(handleColorChange, 200)));
            ['config-nome', 'config-cnpj', 'config-telefone', 'config-endereco', 'config-catalogo-link', 'config-watermark-toggle', 'config-bg-image-opacity'].forEach(id => {
                 const element = document.getElementById(id);
                 if(element) element.addEventListener('input', debounce(handleConfigChange, 400));
            });

            DOMElements.config.themeToggle.addEventListener('click', () => {
                state.configuracoes.visual.theme = state.configuracoes.visual.theme === 'dark' ? 'light' : 'dark';
                applyConfig();
                saveConfig();
                populateConfigForm();
                Object.values(state.aceEditors).forEach(editor => {
                    editor.setTheme(state.configuracoes.visual.theme === 'dark' ? 'ace/theme/tomorrow_night' : 'ace/theme/github');
                });
            });
            
            DOMElements.accordionItems.forEach(item => {
                const header = item.querySelector('.accordion-header');
                const content = item.querySelector('.accordion-content');
                if (header && content) {
                    header.addEventListener('click', () => {
                        const isActive = item.classList.contains('active');
                        DOMElements.accordionItems.forEach(otherItem => {
                           if (otherItem !== item) {
                                otherItem.classList.remove('active');
                                otherItem.querySelector('.accordion-content').style.maxHeight = null;
                           }
                        });
                        if (!isActive) {
                            item.classList.add('active');
                            content.style.maxHeight = content.scrollHeight + "px";
                        } else {
                            item.classList.remove('active');
                            content.style.maxHeight = null;
                        }
                    });
                }
            });

            DOMElements.crm.segmentButtons.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;
                DOMElements.crm.segmentButtons.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                const { filter, minDays, maxDays } = button.dataset;
                if (filter === 'all') {
                    renderCrmClientList({ all: true });
                } else {
                    renderCrmClientList({ 
                        minDays: parseInt(minDays), 
                        maxDays: maxDays ? parseInt(maxDays) : null 
                    });
                }
            });
            
            DOMElements.crm.bulkMessageBtn.addEventListener('click', openBulkCrmModal);
            DOMElements.crmBulkModal.startBtn.addEventListener('click', handleStartCampaign);
            DOMElements.crmBulkModal.sendNextBtn.addEventListener('click', processNextClient);
            DOMElements.crmBulkModal.selectAll.addEventListener('change', (e) => {
                DOMElements.crmBulkModal.clientsList.querySelectorAll('input[type="checkbox"]')
                    .forEach(checkbox => checkbox.checked = e.target.checked);
            });
            DOMElements.crmBulkModal.templateCategory.addEventListener('change', (e) => {
                const category = e.target.value;
                const { templateSelect, message } = DOMElements.crmBulkModal;
                const templates = state.configuracoes.crmTemplates;
                if (category && templates[category]) {
                    templateSelect.innerHTML = `<option value="">Selecione um template</option>` +
                        templates[category].map((tmpl, index) => `<option value="${index}">${tmpl.title}</option>`).join('');
                } else {
                    templateSelect.innerHTML = `<option value="">Selecione um template</option>`;
                }
                message.value = '';
            });
            DOMElements.crmBulkModal.templateSelect.addEventListener('change', (e) => {
                const category = DOMElements.crmBulkModal.templateCategory.value;
                const templateIndex = e.target.value;
                if (category && templateIndex !== "") {
                    DOMElements.crmBulkModal.message.value = state.configuracoes.crmTemplates[category][templateIndex].text;
                }
            });
            
            DOMElements.config.crmTemplatesEditorContainer.addEventListener('input', debounce((e) => {
                const target = e.target;
                if (target.matches('.template-title-input') || target.matches('.template-text-input')) {
                    const { category, index } = target.dataset;
                    const property = target.matches('.template-title-input') ? 'title' : 'text';
                    state.configuracoes.crmTemplates[category][index][property] = target.value;
                    saveConfig();
                }
            }, 500));
            
            DOMElements.dashboard.filterBtn.addEventListener('click', renderDashboard);
            DOMElements.dashboard.clearFilterBtn.addEventListener('click', () => {
                DOMElements.dashboard.dataInicioInput.value = '';
                DOMElements.dashboard.dataFimInput.value = '';
                renderDashboard();
            });

            DOMElements.agenda.addBtn.addEventListener('click', () => openAgendamentoModal());
            DOMElements.agenda.datePicker.addEventListener('change', (e) => {
                state.agendaDataAtual = new Date(e.target.value + 'T00:00:00');
                renderAgenda();
            });
            DOMElements.agenda.prevDayBtn.addEventListener('click', () => {
                state.agendaDataAtual.setDate(state.agendaDataAtual.getDate() - 1);
                renderAgenda();
            });
            DOMElements.agenda.nextDayBtn.addEventListener('click', () => {
                state.agendaDataAtual.setDate(state.agendaDataAtual.getDate() + 1);
                renderAgenda();
            });
            DOMElements.agenda.deleteBtn.addEventListener('click', () => handleDeleteAgendamento(state.editandoAgendamentoId));

            // --- KANBAN DRAG AND DROP LOGIC ---
            const kanbanBoard = DOMElements.crm.tasksBoard;
            let draggedItem = null;

            kanbanBoard.addEventListener('dragstart', (e) => {
                if (e.target.classList.contains('kanban-card')) {
                    draggedItem = e.target;
                    setTimeout(() => e.target.classList.add('dragging'), 0);
                }
            });

            kanbanBoard.addEventListener('dragend', () => {
                if (draggedItem) {
                    draggedItem.classList.remove('dragging');
                    draggedItem = null;
                }
            });

            kanbanBoard.addEventListener('dragover', (e) => {
                e.preventDefault();
                const column = e.target.closest('.kanban-column');
                if (column) {
                    // Futuro: Adicionar classe de highlight na coluna
                }
            });

            kanbanBoard.addEventListener('drop', async (e) => {
                e.preventDefault();
                const column = e.target.closest('.kanban-column');

                if (column && draggedItem) {
                    const taskId = draggedItem.dataset.id;
                    const newStatus = column.dataset.status;
                    
                    column.querySelector('.kanban-cards').appendChild(draggedItem);
                    
                    try {
                        setSyncing(true);
                        const { error } = await supabase
                            .from('crm_tasks')
                            .update({ status: newStatus })
                            .eq('id', taskId);

                        if (error) throw error;
                        
                        const taskInState = state.crmTasks.find(t => t.id === taskId);
                        if (taskInState) taskInState.status = newStatus;
                        
                        showNotification('Tarefa movida com sucesso!', 'success');
                        renderCrmKanban(); // Re-renderiza para atualizar contadores
                    } catch (error) {
                        showNotification(`Erro ao atualizar tarefa: ${error.message}`, 'error');
                        renderCrmKanban(); 
                    } finally {
                        setSyncing(false);
                    }
                }
            });
            
            // Fluxo de Caixa Listeners
            DOMElements.fluxoCaixa.dataInicioInput.addEventListener('input', debounce(renderFluxoDeCaixa, 300));
            DOMElements.fluxoCaixa.dataFimInput.addEventListener('input', debounce(renderFluxoDeCaixa, 300));
        };

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log('R.M. Estética Automotiva PRO+ 6.0 (Visão 360°) inicializado.');
            setupEventListeners();
            setupSupabaseListeners();
            fetchAllData(true);
        });
    </script>
</body>
</html>
