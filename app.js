// ============================================================================
// üöó R.M. EST√âTICA PRO+ - SISTEMA COMPLETO CORRIGIDO
// Vers√£o corrigida com navega√ß√£o funcional e todas as corre√ß√µes implementadas
// ============================================================================

// --------------------------- CONSTANTES -------------------------------------
const SUPABASE_URL = "https://bezbszbkaifcanqsmdbi.supabase.co/";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJlemJzemJrYWlmY2FucXNtZGJpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2MTM5MTksImV4cCI6MjA2ODE4OTkxOX0.zLXAuQz7g5ym3Bd5pkhg5vsnf_3rdJFRAXI_kX8tM18";

const ESTABELECIMENTO = {
    nome: "R.M. Est√©tica Automotiva",
    cnpj: "18.637.639/0001-48",
    telefone: "24999486232",
    endereco: "Rua 40, TV - Recanto dos P√°ssaros, Pq. Mambucaba, Angra dos Reis - RJ",
    agradecimento: "Obrigado pela prefer√™ncia e volte sempre! üëç"
};

// Templates com emojis
const TEMPLATE_ORCAMENTO = `üöó R.M. EST√âTICA AUTOMOTIVA üöó
CNPJ: 18.637.639/0001-48
üìû (24) 99948-6232
üìç Rua 40, TV - Recanto dos P√°ssaros
    Pq. Mambucaba, Angra dos Reis - RJ

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
               OR√áAMENTO #{{id}}
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üë§ CLIENTE: {{cliente.nome}}
üöô VE√çCULO: {{cliente.carro}}
üöó PLACA: {{cliente.placa}}
üìû CONTATO: {{cliente.telefone}}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
üìã SERVI√áOS:
{{servicos}}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

üí∞ SUBTOTAL: {{subtotal}}
üéØ DESCONTO: {{desconto}}
üíµ VALOR TOTAL: {{total}}

üí≥ FORMA(S) DE PAGAMENTO:
{{formasPagamento}}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
‚è∞ Data: {{data}}
üì± WhatsApp: (24) 99948-6232

Obrigado pela prefer√™ncia e volte sempre! üëç
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`;

const TEMPLATE_RECIBO = `üßæ RECIBO N√ÉO FISCAL üßæ

üè™ R.M. EST√âTICA AUTOMOTIVA
CNPJ: 18.637.639/0001-48
üìç Rua 40, TV - Recanto dos P√°ssaros
    Pq. Mambucaba, Angra dos Reis - RJ
üìû (24) 99948-6232

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Recebi de: {{cliente.nome}}
Ve√≠culo: {{cliente.carro}} - {{cliente.placa}}
Referente a: Servi√ßos de est√©tica automotiva

üìã DISCRIMINA√á√ÉO:
{{servicos}}

üíµ VALOR TOTAL: {{total}}
üí≥ PAGAMENTO: {{formasPagamento}}

‚è∞ {{cidade}}, {{dataCompleta}}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚úÖ Servi√ßos executados com garantia
üì± D√∫vidas: (24) 99948-6232

Obrigado pela prefer√™ncia e volte sempre! üëç
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`;

// --------------------------- CLIENTE SUPABASE ------------------------------
let supabase;
if (typeof window !== 'undefined' && window.supabase) {
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    console.log('üì° Supabase conectado!');
} else {
    console.warn('‚ö†Ô∏è Supabase n√£o dispon√≠vel - modo offline');
}

// --------------------------- ESTADO GLOBAL ---------------------------------
const state = {
    // Dados principais
    clientes: [],
    servicos: [],
    orcamentos: [],
    despesas: [],
    crmInteractions: [],
    
    // Configura√ß√µes
    estabelecimento: { ...ESTABELECIMENTO },
    theme: 'dark',
    
    // Controle de or√ßamento
    novoOrcamentoItens: [],
    orcamentoSelecionado: null,
    
    // Charts
    monthlyChart: null,
    despesasChart: null,
    
    // Realtime
    realtimeChannel: null,
    
    // Controle de abas
    currentTab: 'dashboard'
};

// ----------------------------- UTILIT√ÅRIOS ---------------------------------
const $ = (selector) => document.querySelector(selector);
const $$ = (selector) => document.querySelectorAll(selector);

function showNotification(message, type = 'success') {
    console.log(`[${type.toUpperCase()}] ${message}`);
    
    const notification = $('#notification');
    const messageElement = $('#notification-message');
    
    if (notification && messageElement) {
        messageElement.textContent = message;
        notification.className = `show ${type}`;
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, 4000);
    }
}

function formatCurrency(value) {
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    }).format(value || 0);
}

function formatDate(dateString) {
    if (!dateString) return 'Data n√£o informada';
    return new Intl.DateTimeFormat('pt-BR', {
        day: '2-digit',
        month: '2-digit', 
        year: 'numeric'
    }).format(new Date(dateString));
}

// =================== M√ÅSCARAS DE FORMATA√á√ÉO AUTOM√ÅTICA ===================
function formatPhone(value) {
    if (!value) return '';
    // Remove todos os caracteres n√£o num√©ricos
    const numbers = value.replace(/\D/g, '');
    
    // Aplica a m√°scara baseada no tamanho
    if (numbers.length <= 10) {
        // Telefone fixo: (XX) XXXX-XXXX
        return numbers.replace(/^(\d{2})(\d{4})(\d{4}).*/, '($1) $2-$3');
    } else {
        // Celular: (XX) XXXXX-XXXX
        return numbers.replace(/^(\d{2})(\d{5})(\d{4}).*/, '($1) $2-$3');
    }
}

function formatPlaca(value) {
    if (!value) return '';
    // Remove caracteres especiais e converte para mai√∫sculo
    const clean = value.replace(/[^A-Za-z0-9]/g, '').toUpperCase();
    
    if (clean.length <= 3) {
        return clean;
    } else if (clean.length <= 7) {
        // Verifica se √© formato Mercosul (ABC1D23) ou antigo (ABC1234)
        const letters = clean.substring(0, 3);
        const numbers = clean.substring(3);
        
        if (numbers.length >= 4) {
            // Formato antigo: ABC-1234
            return `${letters}-${numbers}`;
        } else if (numbers.length === 3 && /[A-Z]/.test(numbers.charAt(1))) {
            // Formato Mercosul: ABC1D23
            return clean;
        } else {
            return `${letters}${numbers}`;
        }
    }
    
    return clean.substring(0, 8);
}

// Aplicar m√°scaras nos campos em tempo real
function setupInputMasks() {
    // M√°scara para telefones
    const phoneInputs = ['#cliente-telefone', '#empresa-telefone'];
    phoneInputs.forEach(selector => {
        const input = $(selector);
        if (input) {
            input.addEventListener('input', (e) => {
                e.target.value = formatPhone(e.target.value);
            });
        }
    });
    
    // M√°scara para placas
    const placaInput = $('#cliente-placa');
    if (placaInput) {
        placaInput.addEventListener('input', (e) => {
            e.target.value = formatPlaca(e.target.value);
        });
    }
    
    console.log('‚úÖ M√°scaras de formata√ß√£o configuradas');
}

// ------------------------- SISTEMA DE TEMAS ----------------------------
function applyTheme(theme) {
    state.theme = theme;
    const root = document.body;
    
    if (theme === 'auto') {
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        root.dataset.theme = prefersDark ? 'dark' : 'light';
    } else {
        root.dataset.theme = theme;
    }
    
    // Atualiza √≠cone do header
    const themeIcon = $('#theme-toggle-btn i');
    if (themeIcon) {
        if (theme === 'light' || (theme === 'auto' && !window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            themeIcon.className = 'fas fa-sun';
        } else {
            themeIcon.className = 'fas fa-moon';
        }
    }
    
    // Atualiza radio buttons na configura√ß√£o
    const radio = $(`#theme-${theme}`);
    if (radio) {
        radio.checked = true;
    }
    
    showNotification(`üé® Tema alterado para: ${theme}`, 'success');
}

function toggleTheme() {
    const currentTheme = state.theme;
    let nextTheme;
    
    if (currentTheme === 'dark') {
        nextTheme = 'light';
    } else {
        nextTheme = 'dark';
    }
    
    applyTheme(nextTheme);
}

// ========================= SISTEMA DE NAVEGA√á√ÉO CORRIGIDO =========================
function showTab(tabId) {
    console.log(`üß≠ Navegando para aba: ${tabId}`);
    
    // Atualiza estado da aba atual
    state.currentTab = tabId;
    
    // Remove classe active de todas as abas e conte√∫dos
    $$('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    $$('.tab-content').forEach(content => {
        content.classList.remove('active');
        content.style.display = 'none';
    });
    
    // Ativa o bot√£o de navega√ß√£o
    const targetBtn = $(`.nav-btn[data-tab="${tabId}"]`);
    if (targetBtn) {
        targetBtn.classList.add('active');
    }
    
    // Ativa o conte√∫do da aba
    const targetContent = $(`#${tabId}-tab`);
    if (targetContent) {
        targetContent.classList.add('active');
        targetContent.style.display = 'block';
        
        // Aplica anima√ß√£o
        targetContent.style.animation = 'slideInUp 0.4s ease-out';
    }
    
    // Scroll para o topo
    setTimeout(() => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }, 100);
    
    // Renderiza√ß√µes espec√≠ficas por aba
    setTimeout(() => {
        switch (tabId) {
            case 'dashboard':
                renderDashboard();
                renderMonthlyChart();
                break;
            case 'clientes':
                renderClientes();
                break;
            case 'servicos':
                renderServicos();
                break;
            case 'novo-orcamento':
                renderOrcamentoOptions();
                break;
            case 'historico':
                renderHistorico();
                break;
            case 'crm':
                renderCrmData();
                break;
            case 'despesas':
                renderDespesas();
                renderDespesasChart();
                break;
            case 'configuracoes':
                loadConfigurationForms();
                break;
        }
    }, 150);
    
    showNotification(`üöÄ Navegando para: ${getTabName(tabId)}`, 'success');
}

function getTabName(tabId) {
    const names = {
        'dashboard': 'üìä Painel',
        'clientes': 'üë• Clientes', 
        'servicos': 'üîß Servi√ßos',
        'novo-orcamento': 'üìù Or√ßamento',
        'historico': 'üìã Hist√≥rico',
        'crm': 'üí¨ CRM',
        'despesas': 'üí∞ Despesas',
        'configuracoes': '‚öôÔ∏è Configura√ß√µes'
    };
    return names[tabId] || tabId;
}

// ======================= REAL-TIME SYNC COM SUPABASE =====================
function setupRealtimeListeners() {
    if (!supabase) {
        console.warn('‚ö†Ô∏è Supabase n√£o dispon√≠vel para real-time');
        return;
    }
    
    try {
        // Configura listener para mudan√ßas em tempo real
        const channel = supabase
            .channel('db-changes')
            .on('postgres_changes', 
                { event: '*', schema: 'public', table: 'clientes' },
                () => {
                    console.log('üì° Mudan√ßa detectada: clientes');
                    refreshCurrentTabSilently();
                })
            .on('postgres_changes',
                { event: '*', schema: 'public', table: 'orcamentos' }, 
                () => {
                    console.log('üì° Mudan√ßa detectada: or√ßamentos');
                    refreshCurrentTabSilently();
                })
            .on('postgres_changes',
                { event: '*', schema: 'public', table: 'servicos' }, 
                () => {
                    console.log('üì° Mudan√ßa detectada: servi√ßos');
                    refreshCurrentTabSilently();
                })
            .on('postgres_changes',
                { event: '*', schema: 'public', table: 'despesas' }, 
                () => {
                    console.log('üì° Mudan√ßa detectada: despesas');
                    refreshCurrentTabSilently();
                })
            .subscribe();
            
        state.realtimeChannel = channel;
        
        console.log('‚úÖ Real-time listeners configurados');
        
        // Atualiza indicador de sincroniza√ß√£o
        const syncBtn = $('#sync-btn');
        if (syncBtn) {
            syncBtn.style.opacity = '1';
            syncBtn.title = 'üì° Conectado em tempo real';
        }
        
    } catch (error) {
        console.error('‚ùå Erro ao configurar real-time:', error);
    }
}

function refreshCurrentTabSilently() {
    // Atualiza apenas a aba atual sem mudar de posi√ß√£o
    const activeTab = state.currentTab;
    if (!activeTab) return;
    
    console.log(`üîÑ Atualizando aba ${activeTab} silenciosamente`);
    
    // Atualiza apenas os dados da aba atual
    switch(activeTab) {
        case 'dashboard':
            renderDashboard();
            break;
        case 'clientes':
            renderClientes();
            break;
        case 'servicos':
            renderServicos();
            break;
        case 'historico':
            renderHistorico();
            break;
        case 'despesas':
            renderDespesas();
            break;
        case 'crm':
            renderCrmData();
            break;
    }
}

// -------------------------- DADOS DE DEMONSTRA√á√ÉO --------------------------
function loadDemoData() {
    console.log('üìä Carregando dados de demonstra√ß√£o...');
    
    // Clientes de demonstra√ß√£o
    state.clientes = [
        {
            id: '1',
            nome: 'Jo√£o Silva',
            telefone: '24999887766',
            carro: 'Honda Civic 2020',
            placa: 'ABC-1234',
            created_at: new Date().toISOString()
        },
        {
            id: '2',
            nome: 'Maria Santos',
            telefone: '24988776655',
            carro: 'Toyota Corolla 2021', 
            placa: 'XYZ-5678',
            created_at: new Date().toISOString()
        },
        {
            id: '3',
            nome: 'Pedro Oliveira',
            telefone: '24977665544',
            carro: 'Volkswagen Gol 2019',
            placa: 'DEF1G23',
            created_at: new Date().toISOString()
        }
    ];
    
    // Servi√ßos de demonstra√ß√£o  
    state.servicos = [
        {
            id: '1',
            descricao: 'Lavagem Completa',
            valor: 25.00,
            created_at: new Date().toISOString()
        },
        {
            id: '2', 
            descricao: 'Enceramento',
            valor: 40.00,
            created_at: new Date().toISOString()
        },
        {
            id: '3',
            descricao: 'Lavagem Simples',
            valor: 15.00,
            created_at: new Date().toISOString()
        },
        {
            id: '4',
            descricao: 'Aspira√ß√£o Completa',
            valor: 20.00,
            created_at: new Date().toISOString()
        },
        {
            id: '5',
            descricao: 'Limpeza de Bancos',
            valor: 30.00,
            created_at: new Date().toISOString()
        }
    ];
    
    // Or√ßamentos de demonstra√ß√£o
    state.orcamentos = [
        {
            id: '1',
            cliente_id: '1',
            status: 'Pago',
            desconto: 0,
            valor_total: 65.00,
            formas_pagamento: ['Pix'],
            created_at: new Date(Date.now() - 86400000).toISOString(),
            updated_at: new Date().toISOString(),
            clientes: state.clientes[0],
            orcamento_itens: [
                {
                    id: '1',
                    servico_id: '1',
                    quantidade: 1,
                    valor_unitario: 25.00,
                    servicos: state.servicos[0]
                },
                {
                    id: '2',
                    servico_id: '2', 
                    quantidade: 1,
                    valor_unitario: 40.00,
                    servicos: state.servicos[1]
                }
            ]
        },
        {
            id: '2',
            cliente_id: '2',
            status: 'Aprovado',
            desconto: 5.00,
            valor_total: 50.00,
            formas_pagamento: ['Dinheiro', 'Pix'],
            created_at: new Date(Date.now() - 172800000).toISOString(),
            updated_at: new Date().toISOString(),
            clientes: state.clientes[1],
            orcamento_itens: [
                {
                    id: '3',
                    servico_id: '1',
                    quantidade: 1,
                    valor_unitario: 25.00,
                    servicos: state.servicos[0]
                },
                {
                    id: '4',
                    servico_id: '3',
                    quantidade: 2,
                    valor_unitario: 15.00,
                    servicos: state.servicos[2]
                }
            ]
        },
        {
            id: '3',
            cliente_id: '3',
            status: 'Or√ßamento',
            desconto: 0,
            valor_total: 45.00,
            formas_pagamento: ['Cr√©dito'],
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString(),
            clientes: state.clientes[2],
            orcamento_itens: [
                {
                    id: '5',
                    servico_id: '1',
                    quantidade: 1,
                    valor_unitario: 25.00,
                    servicos: state.servicos[0]
                },
                {
                    id: '6',
                    servico_id: '4',
                    quantidade: 1,
                    valor_unitario: 20.00,
                    servicos: state.servicos[3]
                }
            ]
        }
    ];
    
    // Despesas de demonstra√ß√£o
    state.despesas = [
        {
            id: '1',
            descricao: 'Compra de produtos de limpeza',
            valor: 150.00,
            categoria: 'Produtos',
            data: new Date().toISOString().split('T')[0],
            created_at: new Date().toISOString()
        },
        {
            id: '2',
            descricao: 'Manuten√ß√£o de equipamentos',
            valor: 80.00,
            categoria: 'Equipamentos',
            data: new Date(Date.now() - 86400000).toISOString().split('T')[0],
            created_at: new Date().toISOString()
        },
        {
            id: '3',
            descricao: 'Combust√≠vel para deslocamentos',
            valor: 45.00,
            categoria: 'Combust√≠vel',
            data: new Date(Date.now() - 172800000).toISOString().split('T')[0],
            created_at: new Date().toISOString()
        }
    ];
    
    // Intera√ß√µes CRM de demonstra√ß√£o
    state.crmInteractions = [
        {
            id: '1',
            cliente_id: '1',
            type: 'WhatsApp',
            notes: 'Cliente satisfeito com o servi√ßo',
            interaction_date: new Date().toISOString().split('T')[0],
            created_at: new Date().toISOString(),
            clientes: state.clientes[0]
        }
    ];
    
    showNotification('üìä Dados de demonstra√ß√£o carregados!', 'success');
}

// ---------------------------- RENDERIZA√á√ïES --------------------------------
function renderDashboard() {
    // Atualiza m√©tricas
    const totalClientes = state.clientes.length;
    const orcamentosPendentes = state.orcamentos.filter(o => o.status === 'Or√ßamento').length;
    const orcamentosAprovados = state.orcamentos.filter(o => o.status === 'Aprovado').length;
    
    const inicioMes = new Date();
    inicioMes.setDate(1);
    const finalizadosMes = state.orcamentos.filter(o => 
        (o.status === 'Finalizado' || o.status === 'Pago') && 
        new Date(o.updated_at || o.created_at) >= inicioMes
    ).length;
    
    const faturamentoTotal = state.orcamentos
        .filter(o => o.status === 'Pago' || o.status === 'Finalizado')
        .reduce((total, o) => total + (o.valor_total || 0), 0);
    
    // Atualiza elementos DOM
    if ($('#stat-clientes')) $('#stat-clientes').textContent = totalClientes;
    if ($('#stat-pendentes')) $('#stat-pendentes').textContent = orcamentosPendentes;
    if ($('#stat-aprovados')) $('#stat-aprovados').textContent = orcamentosAprovados;
    if ($('#stat-finalizados-mes')) $('#stat-finalizados-mes').textContent = finalizadosMes;
    if ($('#stat-faturamento-total')) $('#stat-faturamento-total').textContent = formatCurrency(faturamentoTotal);
    
    // Renderiza atividade recente
    renderRecentActivity();
}

function renderRecentActivity() {
    const recentList = $('#recent-activity-list');
    if (!recentList) return;
    
    const recentOrcamentos = state.orcamentos
        .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
        .slice(0, 5);
    
    if (recentOrcamentos.length === 0) {
        recentList.innerHTML = `
            <div class="empty-list-message">
                <p>üì≠ Nenhuma atividade recente</p>
                <small>Crie seu primeiro or√ßamento para come√ßar</small>
            </div>
        `;
        return;
    }
    
    recentList.innerHTML = recentOrcamentos.map(orc => `
        <li class="fade-in">
            <div>
                <strong>üöó ${orc.clientes?.nome || 'Cliente n√£o encontrado'}</strong>
                <small>üìã ${orc.clientes?.carro || 'Carro n√£o informado'} - ${orc.clientes?.placa || 'Placa n√£o informada'}</small>
                <small>üìÖ ${formatDate(orc.created_at)} - ${getStatusEmoji(orc.status)} ${orc.status}</small>
            </div>
            <div class="item-actions">
                <span style="font-weight: bold; color: var(--color-success);">
                    üí∞ ${formatCurrency(orc.valor_total)}
                </span>
            </div>
        </li>
    `).join('');
}

function renderClientes() {
    const clientesList = $('#clientes-lista');
    if (!clientesList) return;
    
    if (state.clientes.length === 0) {
        clientesList.innerHTML = `
            <div class="empty-list-message">
                <p>üì≠ Nenhum cliente cadastrado</p>
                <small>Cadastre o primeiro cliente para come√ßar</small>
            </div>
        `;
        return;
    }
    
    clientesList.innerHTML = state.clientes.map(cliente => `
        <li data-id="${cliente.id}" class="cliente-item fade-in">
            <div>
                <strong>üë§ ${cliente.nome}</strong>
                <small>üöó ${cliente.carro} - üöô ${cliente.placa}</small>
                <small>üì± ${formatPhone(cliente.telefone)}</small>
            </div>
            <div class="item-actions">
                <button class="btn btn-sm btn-secondary btn-hover-effect" onclick="editarCliente('${cliente.id}')">
                    <i class="fas fa-edit"></i> <span>‚úèÔ∏è Editar</span>
                </button>
                <button class="btn btn-sm btn-danger btn-hover-effect" onclick="excluirCliente('${cliente.id}')">
                    <i class="fas fa-trash"></i> <span>üóëÔ∏è Excluir</span>
                </button>
            </div>
        </li>
    `).join('');
}

function renderServicos() {
    const servicosList = $('#servicos-lista');
    if (!servicosList) return;
    
    if (state.servicos.length === 0) {
        servicosList.innerHTML = `
            <div class="empty-list-message">
                <p>üì≠ Nenhum servi√ßo cadastrado</p>
                <small>Cadastre o primeiro servi√ßo para come√ßar</small>
            </div>
        `;
        return;
    }
    
    servicosList.innerHTML = state.servicos.map(servico => `
        <li data-id="${servico.id}" class="servico-item fade-in">
            <div>
                <strong>üîß ${servico.descricao}</strong>
                <small>üí∞ ${formatCurrency(servico.valor)}</small>
            </div>
            <div class="item-actions">
                <button class="btn btn-sm btn-secondary btn-hover-effect" onclick="editarServico('${servico.id}')">
                    <i class="fas fa-edit"></i> <span>‚úèÔ∏è Editar</span>
                </button>
                <button class="btn btn-sm btn-danger btn-hover-effect" onclick="excluirServico('${servico.id}')">
                    <i class="fas fa-trash"></i> <span>üóëÔ∏è Excluir</span>
                </button>
            </div>
        </li>
    `).join('');
}

function renderOrcamentoOptions() {
    // Popula select de clientes
    const clienteSelect = $('#orcamento-cliente');
    if (clienteSelect) {
        clienteSelect.innerHTML = '<option value="">üë§ Selecione um cliente</option>' +
            state.clientes.map(cliente => `
                <option value="${cliente.id}">üë§ ${cliente.nome} - üöó ${cliente.carro}</option>
            `).join('');
    }
    
    // Popula select de servi√ßos
    const servicoSelect = $('#orcamento-servico-select');
    if (servicoSelect) {
        servicoSelect.innerHTML = '<option value="">üîß Selecione um servi√ßo</option>' +
            state.servicos.map(servico => `
                <option value="${servico.id}">üîß ${servico.descricao} - üí∞ ${formatCurrency(servico.valor)}</option>
            `).join('');
    }
    
    renderOrcamentoItens();
}

function renderOrcamentoItens() {
    const servicosContainer = $('#orcamento-servicos-adicionados');
    if (!servicosContainer) return;
    
    if (state.novoOrcamentoItens.length === 0) {
        servicosContainer.innerHTML = '<p style="text-align: center; color: var(--color-text-secondary);">üì≠ Nenhum servi√ßo adicionado</p>';
        updateOrcamentoTotal();
        return;
    }
    
    servicosContainer.innerHTML = state.novoOrcamentoItens.map((item, index) => `
        <li class="fade-in">
            <div>
                <strong>üîß ${item.descricao_servico}</strong>
                <small>üí∞ ${formatCurrency(item.valor_cobrado)} cada x ${item.quantidade}</small>
                <small>üíµ Total: ${formatCurrency(item.valor_cobrado * item.quantidade)}</small>
            </div>
            <div class="item-actions">
                <input type="number" class="form-control" style="width: 80px;" 
                       value="${item.quantidade}" min="1" max="99" data-index="${index}"
                       title="Quantidade">
                <button type="button" class="btn btn-sm btn-danger remove-servico-btn btn-hover-effect" data-index="${index}">
                    <i class="fas fa-trash"></i> üóëÔ∏è
                </button>
            </div>
        </li>
    `).join('');
    
    updateOrcamentoTotal();
}

function updateOrcamentoTotal() {
    const subtotal = state.novoOrcamentoItens.reduce((total, item) => {
        return total + (item.valor_cobrado * item.quantidade);
    }, 0);
    
    const desconto = parseFloat($('#orcamento-desconto')?.value || 0);
    const total = Math.max(0, subtotal - desconto);
    
    const totalElement = $('#orcamento-total');
    if (totalElement) {
        totalElement.innerHTML = `<strong>üí∞ Total: ${formatCurrency(total)}</strong>`;
    }
}

// ================= HIST√ìRICO COM FUNCIONALIDADE COMPLETA =================
function renderHistorico() {
    const orcamentosList = $('#historico-lista');
    if (!orcamentosList) return;
    
    if (state.orcamentos.length === 0) {
        orcamentosList.innerHTML = `
            <div class="empty-list-message">
                <p>üì≠ Nenhum or√ßamento encontrado</p>
                <small>Crie o primeiro or√ßamento para come√ßar</small>
            </div>
        `;
        return;
    }
    
    orcamentosList.innerHTML = state.orcamentos.map(orcamento => `
        <li data-id="${orcamento.id}" class="historico-item fade-in" onclick="selecionarOrcamentoHistorico('${orcamento.id}')">
            <div>
                <strong>üë§ ${orcamento.clientes?.nome || 'Cliente n√£o encontrado'}</strong>
                <small>üöó ${orcamento.clientes?.carro || 'Carro n√£o informado'} - üöô ${orcamento.clientes?.placa || 'Placa n√£o informada'}</small>
                <small>üìÖ ${formatDate(orcamento.created_at)} - ${getStatusEmoji(orcamento.status)} ${orcamento.status}</small>
            </div>
            <div class="item-actions">
                <span style="font-weight: bold; color: var(--color-success);">
                    üí∞ ${formatCurrency(orcamento.valor_total)}
                </span>
                <span class="status-badge status-${orcamento.status.toLowerCase()}">
                    ${getStatusEmoji(orcamento.status)}
                </span>
            </div>
        </li>
    `).join('');
    
    console.log('üìã Hist√≥rico renderizado com', state.orcamentos.length, 'or√ßamentos');
}

function selecionarOrcamentoHistorico(orcamentoId) {
    console.log('üéØ Selecionando or√ßamento:', orcamentoId);
    
    // Remove sele√ß√£o anterior
    $$('.historico-item').forEach(item => item.classList.remove('selected'));
    
    // Adiciona sele√ß√£o atual
    const selectedItem = $(`.historico-item[data-id="${orcamentoId}"]`);
    if (selectedItem) {
        selectedItem.classList.add('selected');
    }
    
    // Encontra o or√ßamento
    const orcamento = state.orcamentos.find(o => o.id === orcamentoId);
    if (!orcamento) {
        showNotification('‚ùå Or√ßamento n√£o encontrado', 'error');
        return;
    }
    
    state.orcamentoSelecionado = orcamento;
    
    // Mostra painel de detalhes
    const detalhesPanel = $('#detalhes-panel');
    if (detalhesPanel) {
        detalhesPanel.style.display = 'block';
        detalhesPanel.classList.add('slide-in-right');
    }
    
    // Renderiza detalhes
    renderDetalhesOrcamento(orcamento);
    renderDetalhesRecibo(orcamento);
    
    showNotification(`‚úÖ Or√ßamento #${orcamento.id} selecionado`, 'success');
}

function renderDetalhesOrcamento(orcamento) {
    const textoOrcamento = $('#texto-orcamento');
    if (!textoOrcamento) return;
    
    // Gera texto do or√ßamento
    let servicosTexto = '';
    if (orcamento.orcamento_itens && orcamento.orcamento_itens.length > 0) {
        servicosTexto = orcamento.orcamento_itens.map(item => {
            const descricao = item.servicos?.descricao || 'Servi√ßo n√£o encontrado';
            const quantidade = item.quantidade || 1;
            const valorUnitario = formatCurrency(item.valor_unitario || 0);
            const valorTotal = formatCurrency((item.valor_unitario || 0) * quantidade);
            return `${quantidade}x ${descricao} - ${valorUnitario} = ${valorTotal}`;
        }).join('\n');
    }
    
    const subtotal = (orcamento.orcamento_itens || []).reduce((total, item) => {
        return total + ((item.valor_unitario || 0) * (item.quantidade || 1));
    }, 0);
    
    const texto = TEMPLATE_ORCAMENTO
        .replace('{{id}}', orcamento.id)
        .replace('{{cliente.nome}}', orcamento.clientes?.nome || 'Cliente n√£o encontrado')
        .replace('{{cliente.carro}}', orcamento.clientes?.carro || 'Carro n√£o informado')
        .replace('{{cliente.placa}}', orcamento.clientes?.placa || 'Placa n√£o informada')
        .replace('{{cliente.telefone}}', formatPhone(orcamento.clientes?.telefone || ''))
        .replace('{{servicos}}', servicosTexto)
        .replace('{{subtotal}}', formatCurrency(subtotal))
        .replace('{{desconto}}', formatCurrency(orcamento.desconto || 0))
        .replace('{{total}}', formatCurrency(orcamento.valor_total || 0))
        .replace('{{formasPagamento}}', (orcamento.formas_pagamento || []).join(', '))
        .replace('{{data}}', formatDate(orcamento.created_at));
    
    textoOrcamento.textContent = texto;
}

function renderDetalhesRecibo(orcamento) {
    const textoRecibo = $('#texto-recibo');
    if (!textoRecibo) return;
    
    // Gera texto do recibo
    let servicosTexto = '';
    if (orcamento.orcamento_itens && orcamento.orcamento_itens.length > 0) {
        servicosTexto = orcamento.orcamento_itens.map(item => {
            const descricao = item.servicos?.descricao || 'Servi√ßo n√£o encontrado';
            const quantidade = item.quantidade || 1;
            const valorTotal = formatCurrency((item.valor_unitario || 0) * quantidade);
            return `${quantidade}x ${descricao} - ${valorTotal}`;
        }).join('\n');
    }
    
    const hoje = new Date();
    const dataCompleta = hoje.toLocaleDateString('pt-BR', {
        day: '2-digit',
        month: 'long',
        year: 'numeric'
    });
    
    const texto = TEMPLATE_RECIBO
        .replace('{{cliente.nome}}', orcamento.clientes?.nome || 'Cliente n√£o encontrado')
        .replace('{{cliente.carro}}', orcamento.clientes?.carro || 'Carro n√£o informado')
        .replace('{{cliente.placa}}', orcamento.clientes?.placa || 'Placa n√£o informada')
        .replace('{{servicos}}', servicosTexto)
        .replace('{{total}}', formatCurrency(orcamento.valor_total || 0))
        .replace('{{formasPagamento}}', (orcamento.formas_pagamento || []).join(', '))
        .replace('{{cidade}}', 'Angra dos Reis - RJ')
        .replace('{{dataCompleta}}', dataCompleta);
    
    textoRecibo.textContent = texto;
}

function renderDespesas() {
    const despesasList = $('#despesas-lista');
    if (!despesasList) return;
    
    if (state.despesas.length === 0) {
        despesasList.innerHTML = `
            <div class="empty-list-message">
                <p>üì≠ Nenhuma despesa cadastrada</p>
                <small>Registre a primeira despesa para come√ßar</small>
            </div>
        `;
        return;
    }
    
    despesasList.innerHTML = state.despesas.map(despesa => `
        <li data-id="${despesa.id}" class="despesa-item fade-in">
            <div>
                <strong>üìù ${despesa.descricao}</strong>
                <small>üìÇ ${despesa.categoria} - üìÖ ${formatDate(despesa.data)}</small>
            </div>
            <div class="item-actions">
                <span style="font-weight: bold; color: var(--color-error);">
                    üí∏ ${formatCurrency(despesa.valor)}
                </span>
                <button class="btn btn-sm btn-secondary btn-hover-effect" onclick="editarDespesa('${despesa.id}')">
                    <i class="fas fa-edit"></i> ‚úèÔ∏è
                </button>
                <button class="btn btn-sm btn-danger btn-hover-effect" onclick="excluirDespesa('${despesa.id}')">
                    <i class="fas fa-trash"></i> üóëÔ∏è
                </button>
            </div>
        </li>
    `).join('');
    
    // Atualiza m√©tricas
    const hoje = new Date().toISOString().split('T')[0];
    const inicioMes = new Date();
    inicioMes.setDate(1);
    const inicioMesStr = inicioMes.toISOString().split('T')[0];
    
    const totalMes = state.despesas
        .filter(d => d.data >= inicioMesStr)
        .reduce((total, d) => total + (d.valor || 0), 0);
    
    const totalHoje = state.despesas
        .filter(d => d.data === hoje)
        .reduce((total, d) => total + (d.valor || 0), 0);
    
    const diasNoMes = new Date().getDate();
    const mediaDiaria = totalMes / diasNoMes;
    
    if ($('#despesas-total-mes')) $('#despesas-total-mes').textContent = formatCurrency(totalMes);
    if ($('#despesas-hoje')) $('#despesas-hoje').textContent = formatCurrency(totalHoje);
    if ($('#despesas-media-diaria')) $('#despesas-media-diaria').textContent = formatCurrency(mediaDiaria);
}

function renderCrmData() {
    // M√©tricas CRM
    const totalInteractions = state.crmInteractions.length;
    const activeClients = state.clientes.length; // Simplificado para demo
    
    if ($('#crm-total-interactions')) $('#crm-total-interactions').textContent = totalInteractions;
    if ($('#crm-active-clients')) $('#crm-active-clients').textContent = activeClients;
    if ($('#crm-pending-followups')) $('#crm-pending-followups').textContent = '2';
    
    // Popula select de cliente para intera√ß√µes
    const clientSelect = $('#interaction-client');
    if (clientSelect) {
        clientSelect.innerHTML = '<option value="">üë§ Selecione um cliente</option>' +
            state.clientes.map(cliente => `
                <option value="${cliente.id}">üë§ ${cliente.nome} - üöó ${cliente.carro}</option>
            `).join('');
    }
}

// ======================= FUN√á√ïES DE DETALHES DO HIST√ìRICO =======================
// Tornar fun√ß√µes globais para uso nos bot√µes
window.copyText = function(tipo) {
    const elemento = tipo === 'orcamento' ? $('#texto-orcamento') : $('#texto-recibo');
    if (!elemento) return;
    
    navigator.clipboard.writeText(elemento.textContent).then(() => {
        showNotification(`üìã ${tipo === 'orcamento' ? 'Or√ßamento' : 'Recibo'} copiado!`, 'success');
    }).catch(() => {
        showNotification('‚ùå Erro ao copiar texto', 'error');
    });
};

window.baixarPDF = function(tipo) {
    if (!window.jsPDF) {
        showNotification('‚ùå Biblioteca PDF n√£o dispon√≠vel', 'error');
        return;
    }
    
    try {
        const elemento = tipo === 'orcamento' ? $('#texto-orcamento') : $('#texto-recibo');
        if (!elemento) return;
        
        const doc = new jsPDF();
        const texto = elemento.textContent;
        const linhas = doc.splitTextToSize(texto, 180);
        
        doc.setFont('courier');
        doc.setFontSize(10);
        doc.text(linhas, 15, 20);
        
        const nomeArquivo = `${tipo}_${state.orcamentoSelecionado?.id || 'documento'}.pdf`;
        doc.save(nomeArquivo);
        
        showNotification(`üìÑ PDF ${tipo} baixado!`, 'success');
    } catch (error) {
        console.error('Erro ao gerar PDF:', error);
        showNotification('‚ùå Erro ao gerar PDF', 'error');
    }
};

window.enviarWhatsApp = function(tipo) {
    const elemento = tipo === 'orcamento' ? $('#texto-orcamento') : $('#texto-recibo');
    if (!elemento) return;
    
    const texto = encodeURIComponent(elemento.textContent);
    const telefone = state.orcamentoSelecionado?.clientes?.telefone;
    
    if (telefone) {
        const numeroLimpo = telefone.replace(/\D/g, '');
        const whatsappUrl = `https://wa.me/55${numeroLimpo}?text=${texto}`;
        window.open(whatsappUrl, '_blank');
        showNotification(`üì± ${tipo === 'orcamento' ? 'Or√ßamento' : 'Recibo'} enviado via WhatsApp!`, 'success');
    } else {
        const whatsappUrl = `https://wa.me/?text=${texto}`;
        window.open(whatsappUrl, '_blank');
        showNotification('üì± WhatsApp aberto para envio', 'success');
    }
};

window.alterarStatus = function(novoStatus) {
    if (!state.orcamentoSelecionado) {
        showNotification('‚ùå Nenhum or√ßamento selecionado', 'error');
        return;
    }
    
    // Encontra o or√ßamento no array e atualiza
    const index = state.orcamentos.findIndex(o => o.id === state.orcamentoSelecionado.id);
    if (index >= 0) {
        state.orcamentos[index].status = novoStatus;
        state.orcamentos[index].updated_at = new Date().toISOString();
        state.orcamentoSelecionado.status = novoStatus;
        
        // Atualiza a renderiza√ß√£o
        renderHistorico();
        
        // Mant√©m a sele√ß√£o
        setTimeout(() => {
            selecionarOrcamentoHistorico(state.orcamentoSelecionado.id);
        }, 100);
        
        showNotification(`‚úÖ Status alterado para: ${getStatusEmoji(novoStatus)} ${novoStatus}`, 'success');
        
        // Atualiza dashboard se estiver na aba
        if (state.currentTab === 'dashboard') {
            renderDashboard();
        }
    }
};

window.editarOrcamento = function() {
    if (!state.orcamentoSelecionado) {
        showNotification('‚ùå Nenhum or√ßamento selecionado', 'error');
        return;
    }
    
    showNotification('üìù Redirecionando para edi√ß√£o...', 'success');
    showTab('novo-orcamento');
    
    // TODO: Implementar carregamento dos dados do or√ßamento para edi√ß√£o
};

window.excluirOrcamento = function() {
    if (!state.orcamentoSelecionado) {
        showNotification('‚ùå Nenhum or√ßamento selecionado', 'error');
        return;
    }
    
    if (confirm('üóëÔ∏è Tem certeza que deseja excluir este or√ßamento?')) {
        const index = state.orcamentos.findIndex(o => o.id === state.orcamentoSelecionado.id);
        if (index >= 0) {
            state.orcamentos.splice(index, 1);
            state.orcamentoSelecionado = null;
            
            // Esconde painel de detalhes
            const detalhesPanel = $('#detalhes-panel');
            if (detalhesPanel) {
                detalhesPanel.style.display = 'none';
            }
            
            renderHistorico();
            showNotification('üóëÔ∏è Or√ßamento exclu√≠do com sucesso!', 'success');
        }
    }
};

function getStatusEmoji(status) {
    const emojis = {
        'Or√ßamento': 'üìù',
        'Aprovado': 'üëç',
        'Pago': 'üí∞',
        'Finalizado': '‚úÖ',
        'Cancelado': '‚ùå'
    };
    return emojis[status] || 'üìã';
}

// ========================== CHARTS =======================================
function renderMonthlyChart() {
    const canvas = $('#monthly-finalized-chart-canvas');
    if (!canvas || !window.Chart) return;
    
    const ctx = canvas.getContext('2d');
    
    if (state.monthlyChart) {
        state.monthlyChart.destroy();
    }
    
    // Dados dos √∫ltimos 6 meses
    const monthlyData = [];
    const monthLabels = [];
    
    for (let i = 5; i >= 0; i--) {
        const date = new Date();
        date.setMonth(date.getMonth() - i);
        
        const monthStart = new Date(date.getFullYear(), date.getMonth(), 1);
        const monthEnd = new Date(date.getFullYear(), date.getMonth() + 1, 0);
        
        const finalizados = state.orcamentos.filter(o => 
            (o.status === 'Finalizado' || o.status === 'Pago') && 
            new Date(o.updated_at || o.created_at) >= monthStart && 
            new Date(o.updated_at || o.created_at) <= monthEnd
        ).length;
        
        monthlyData.push(finalizados);
        monthLabels.push(date.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' }));
    }
    
    try {
        state.monthlyChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: monthLabels,
                datasets: [{
                    label: 'üìä Or√ßamentos Finalizados',
                    data: monthlyData,
                    backgroundColor: ['#1FB8CD', '#FFC185', '#B4413C', '#ECEBD5', '#5D878F', '#DB4545'],
                    borderColor: '#16a4b8',
                    borderWidth: 2,
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { 
                        beginAtZero: true,
                        ticks: { precision: 0 }
                    }
                }
            }
        });
    } catch (error) {
        console.error('‚ùå Erro ao criar gr√°fico:', error);
    }
}

function renderDespesasChart() {
    const canvas = $('#despesas-chart');
    if (!canvas || !window.Chart) return;
    
    const ctx = canvas.getContext('2d');
    
    if (state.despesasChart) {
        state.despesasChart.destroy();
    }
    
    // Agrupa despesas por categoria
    const categorias = {};
    state.despesas.forEach(despesa => {
        if (!categorias[despesa.categoria]) {
            categorias[despesa.categoria] = 0;
        }
        categorias[despesa.categoria] += despesa.valor || 0;
    });
    
    const labels = Object.keys(categorias);
    const data = Object.values(categorias);
    const colors = ['#1FB8CD', '#FFC185', '#B4413C', '#ECEBD5', '#5D878F', '#DB4545', '#D2BA4C', '#964325', '#944454'];
    
    try {
        state.despesasChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels.map(label => `üí∞ ${label}`),
                datasets: [{
                    data: data,
                    backgroundColor: colors.slice(0, labels.length),
                    borderWidth: 2,
                    borderColor: 'rgba(255, 255, 255, 0.1)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { padding: 20 }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${formatCurrency(context.parsed)}`;
                            }
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('‚ùå Erro ao criar gr√°fico de despesas:', error);
    }
}

// ========================== MANIPULADORES DE OR√áAMENTO ==========================
function handleAddServicoToOrcamento() {
    const servicoId = $('#orcamento-servico-select')?.value;
    const quantidade = parseInt($('#orcamento-servico-quantidade')?.value) || 1;
    
    if (!servicoId) {
        showNotification('‚ö†Ô∏è Selecione um servi√ßo', 'warning');
        return;
    }
    
    if (quantidade <= 0 || quantidade > 99) {
        showNotification('‚ö†Ô∏è Quantidade deve ser entre 1 e 99', 'warning');
        return;
    }
    
    const servico = state.servicos.find(s => s.id === servicoId);
    if (!servico) {
        showNotification('‚ùå Servi√ßo n√£o encontrado', 'error');
        return;
    }
    
    // Verifica se j√° foi adicionado
    const existingIndex = state.novoOrcamentoItens.findIndex(item => item.servico_id === servicoId);
    
    if (existingIndex >= 0) {
        state.novoOrcamentoItens[existingIndex].quantidade = quantidade;
        showNotification(`‚úÖ Quantidade do servi√ßo "${servico.descricao}" atualizada`, 'success');
    } else {
        state.novoOrcamentoItens.push({
            servico_id: servicoId,
            descricao_servico: servico.descricao,
            valor_cobrado: servico.valor,
            quantidade: quantidade
        });
        showNotification(`‚úÖ Servi√ßo "${servico.descricao}" adicionado ao or√ßamento`, 'success');
    }
    
    // Limpa sele√ß√£o
    if ($('#orcamento-servico-select')) $('#orcamento-servico-select').value = '';
    if ($('#orcamento-servico-quantidade')) $('#orcamento-servico-quantidade').value = 1;
    
    renderOrcamentoItens();
}

function handleOrcamentoSubmit(e) {
    e.preventDefault();
    
    const clienteId = $('#orcamento-cliente')?.value;
    const desconto = parseFloat($('#orcamento-desconto')?.value) || 0;
    
    // Valida√ß√µes
    if (!clienteId) {
        showNotification('‚ùå Selecione um cliente', 'error');
        return;
    }
    
    if (state.novoOrcamentoItens.length === 0) {
        showNotification('‚ùå Adicione pelo menos um servi√ßo', 'error');
        return;
    }
    
    // Verifica formas de pagamento (checkboxes)
    const formasPagamento = Array.from($$('#payment-options input[type="checkbox"]:checked')).map(cb => cb.value);
    if (formasPagamento.length === 0) {
        showNotification('‚ùå Selecione pelo menos uma forma de pagamento', 'error');
        return;
    }
    
    // Calcula valores
    const subtotal = state.novoOrcamentoItens.reduce((total, item) => {
        return total + (item.valor_cobrado * item.quantidade);
    }, 0);
    const valorTotal = Math.max(0, subtotal - desconto);
    
    // Cria or√ßamento
    const novoOrcamento = {
        id: Date.now().toString(),
        cliente_id: clienteId,
        status: 'Or√ßamento',
        desconto,
        valor_total: valorTotal,
        formas_pagamento: formasPagamento,
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString(),
        clientes: state.clientes.find(c => c.id === clienteId),
        orcamento_itens: state.novoOrcamentoItens.map((item, index) => ({
            id: `${Date.now()}_${index}`,
            servico_id: item.servico_id,
            quantidade: item.quantidade,
            valor_unitario: item.valor_cobrado,
            servicos: state.servicos.find(s => s.id === item.servico_id)
        }))
    };
    
    state.orcamentos.unshift(novoOrcamento);
    
    showNotification(`‚úÖ Or√ßamento criado com sucesso! Total: ${formatCurrency(valorTotal)}`, 'success');
    
    // Limpa formul√°rio
    e.target.reset();
    state.novoOrcamentoItens = [];
    $$('#payment-options input[type="checkbox"]').forEach(cb => cb.checked = false);
    renderOrcamentoItens();
    
    // Vai para hist√≥rico ap√≥s um delay
    setTimeout(() => {
        showTab('historico');
    }, 1500);
}

// ========================== CRUD CLIENTES ===============================
function handleClienteSubmit(e) {
    e.preventDefault();
    
    const nome = $('#cliente-nome')?.value?.trim();
    const telefone = $('#cliente-telefone')?.value?.trim();
    const carro = $('#cliente-carro')?.value?.trim();
    const placa = $('#cliente-placa')?.value?.trim();
    const clienteId = $('#cliente-id')?.value;
    
    // Valida√ß√µes
    if (!nome || nome.length < 2) {
        showNotification('‚ùå Nome deve ter pelo menos 2 caracteres', 'error');
        return;
    }
    
    if (!telefone) {
        showNotification('‚ùå Telefone √© obrigat√≥rio', 'error');
        return;
    }
    
    if (!carro || carro.length < 3) {
        showNotification('‚ùå Carro deve ter pelo menos 3 caracteres', 'error');
        return;
    }
    
    if (!placa) {
        showNotification('‚ùå Placa √© obrigat√≥ria', 'error');
        return;
    }
    
    // Verifica se a placa j√° existe (apenas para novos clientes)
    if (!clienteId) {
        const placaExistente = state.clientes.find(c => c.placa.toLowerCase() === placa.toLowerCase());
        if (placaExistente) {
            showNotification('‚ùå Placa j√° cadastrada para outro cliente', 'error');
            return;
        }
    }
    
    if (clienteId) {
        // Edi√ß√£o
        const index = state.clientes.findIndex(c => c.id === clienteId);
        if (index >= 0) {
            state.clientes[index] = {
                ...state.clientes[index],
                nome,
                telefone,
                carro,
                placa,
                updated_at: new Date().toISOString()
            };
            showNotification(`‚úÖ Cliente "${nome}" atualizado com sucesso!`, 'success');
        }
    } else {
        // Novo cliente
        const novoCliente = {
            id: Date.now().toString(),
            nome,
            telefone,
            carro,
            placa,
            created_at: new Date().toISOString()
        };
        
        state.clientes.unshift(novoCliente);
        showNotification(`‚úÖ Cliente "${nome}" cadastrado com sucesso!`, 'success');
    }
    
    // Limpa formul√°rio
    e.target.reset();
    $('#cliente-id').value = '';
    if ($('#cancelar-edicao-cliente')) $('#cancelar-edicao-cliente').style.display = 'none';
    if ($('#cliente-form-title')) $('#cliente-form-title').innerHTML = '<i class="fas fa-user-plus"></i> üë§ Cadastrar Cliente';
    
    // Atualiza lista
    renderClientes();
    renderOrcamentoOptions(); // Atualiza selects tamb√©m
}

// Tornar fun√ß√µes globais para uso nos bot√µes
window.editarCliente = function(clienteId) {
    const cliente = state.clientes.find(c => c.id === clienteId);
    if (!cliente) return;
    
    // Preenche formul√°rio
    $('#cliente-id').value = cliente.id;
    $('#cliente-nome').value = cliente.nome;
    $('#cliente-telefone').value = formatPhone(cliente.telefone);
    $('#cliente-carro').value = cliente.carro;
    $('#cliente-placa').value = cliente.placa;
    
    // Atualiza interface
    if ($('#cancelar-edicao-cliente')) $('#cancelar-edicao-cliente').style.display = 'inline-flex';
    if ($('#cliente-form-title')) $('#cliente-form-title').innerHTML = '<i class="fas fa-user-edit"></i> ‚úèÔ∏è Editar Cliente';
    
    showNotification(`‚úèÔ∏è Editando cliente "${cliente.nome}"`, 'success');
};

window.excluirCliente = function(clienteId) {
    const cliente = state.clientes.find(c => c.id === clienteId);
    if (!cliente) return;
    
    // Verifica se tem or√ßamentos
    const temOrcamentos = state.orcamentos.some(o => o.cliente_id === clienteId);
    if (temOrcamentos) {
        showNotification('‚ùå N√£o √© poss√≠vel excluir cliente com or√ßamentos', 'error');
        return;
    }
    
    if (confirm(`üóëÔ∏è Tem certeza que deseja excluir o cliente "${cliente.nome}"?`)) {
        const index = state.clientes.findIndex(c => c.id === clienteId);
        if (index >= 0) {
            state.clientes.splice(index, 1);
            renderClientes();
            renderOrcamentoOptions();
            showNotification(`üóëÔ∏è Cliente "${cliente.nome}" exclu√≠do com sucesso!`, 'success');
        }
    }
};

// ========================== CRUD SERVI√áOS ===============================
function handleServicoSubmit(e) {
    e.preventDefault();
    
    const descricao = $('#servico-descricao')?.value?.trim();
    const valor = parseFloat($('#servico-valor')?.value);
    const servicoId = $('#servico-id')?.value;
    
    // Valida√ß√µes
    if (!descricao || descricao.length < 3) {
        showNotification('‚ùå Descri√ß√£o deve ter pelo menos 3 caracteres', 'error');
        return;
    }
    
    if (!valor || valor <= 0) {
        showNotification('‚ùå Valor deve ser maior que zero', 'error');
        return;
    }
    
    if (servicoId) {
        // Edi√ß√£o
        const index = state.servicos.findIndex(s => s.id === servicoId);
        if (index >= 0) {
            state.servicos[index] = {
                ...state.servicos[index],
                descricao,
                valor,
                updated_at: new Date().toISOString()
            };
            showNotification(`‚úÖ Servi√ßo "${descricao}" atualizado com sucesso!`, 'success');
        }
    } else {
        // Novo servi√ßo
        const novoServico = {
            id: Date.now().toString(),
            descricao,
            valor,
            created_at: new Date().toISOString()
        };
        
        state.servicos.unshift(novoServico);
        showNotification(`‚úÖ Servi√ßo "${descricao}" cadastrado com sucesso!`, 'success');
    }
    
    // Limpa formul√°rio
    e.target.reset();
    $('#servico-id').value = '';
    if ($('#cancelar-edicao-servico')) $('#cancelar-edicao-servico').style.display = 'none';
    if ($('#servico-form-title')) $('#servico-form-title').innerHTML = '<i class="fas fa-plus"></i> üîß Cadastrar Servi√ßo';
    
    // Atualiza lista
    renderServicos();
    renderOrcamentoOptions(); // Atualiza selects tamb√©m
}

window.editarServico = function(servicoId) {
    const servico = state.servicos.find(s => s.id === servicoId);
    if (!servico) return;
    
    // Preenche formul√°rio
    $('#servico-id').value = servico.id;
    $('#servico-descricao').value = servico.descricao;
    $('#servico-valor').value = servico.valor;
    
    // Atualiza interface
    if ($('#cancelar-edicao-servico')) $('#cancelar-edicao-servico').style.display = 'inline-flex';
    if ($('#servico-form-title')) $('#servico-form-title').innerHTML = '<i class="fas fa-tools"></i> ‚úèÔ∏è Editar Servi√ßo';
    
    showNotification(`‚úèÔ∏è Editando servi√ßo "${servico.descricao}"`, 'success');
};

window.excluirServico = function(servicoId) {
    const servico = state.servicos.find(s => s.id === servicoId);
    if (!servico) return;
    
    if (confirm(`üóëÔ∏è Tem certeza que deseja excluir o servi√ßo "${servico.descricao}"?`)) {
        const index = state.servicos.findIndex(s => s.id === servicoId);
        if (index >= 0) {
            state.servicos.splice(index, 1);
            renderServicos();
            renderOrcamentoOptions();
            showNotification(`üóëÔ∏è Servi√ßo "${servico.descricao}" exclu√≠do com sucesso!`, 'success');
        }
    }
};

// ========================== CONFIGURA√á√ïES ==========================
function loadConfigurationForms() {
    // Carrega dados da empresa
    if ($('#empresa-nome')) $('#empresa-nome').value = state.estabelecimento.nome;
    if ($('#empresa-cnpj')) $('#empresa-cnpj').value = state.estabelecimento.cnpj;
    if ($('#empresa-telefone')) $('#empresa-telefone').value = formatPhone(state.estabelecimento.telefone);
    if ($('#empresa-endereco')) $('#empresa-endereco').value = state.estabelecimento.endereco;
    if ($('#empresa-agradecimento')) $('#empresa-agradecimento').value = state.estabelecimento.agradecimento;
    
    // Aplica tema atual
    applyTheme(state.theme);
}

function handleEmpresaSubmit(e) {
    e.preventDefault();
    
    state.estabelecimento = {
        nome: $('#empresa-nome')?.value?.trim() || '',
        cnpj: $('#empresa-cnpj')?.value?.trim() || '',
        telefone: $('#empresa-telefone')?.value?.replace(/\D/g, '') || '',
        endereco: $('#empresa-endereco')?.value?.trim() || '',
        agradecimento: $('#empresa-agradecimento')?.value?.trim() || ''
    };
    
    showNotification('‚úÖ Dados da empresa salvos com sucesso!', 'success');
}

// ========================== EVENT LISTENERS ==========================
function setupEventListeners() {
    console.log('‚öôÔ∏è Configurando event listeners...');
    
    // Navega√ß√£o entre abas - CORRIGIDO
    $$('.nav-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const tabId = e.currentTarget.dataset.tab;
            if (tabId) {
                showTab(tabId);
            }
        });
    });
    
    // Toggle de tema no header
    const themeToggleBtn = $('#theme-toggle-btn');
    if (themeToggleBtn) {
        themeToggleBtn.addEventListener('click', (e) => {
            e.preventDefault();
            toggleTheme();
        });
    }
    
    // Radio buttons de tema nas configura√ß√µes
    $$('input[name="theme-choice"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            applyTheme(e.target.value);
        });
    });
    
    // Formul√°rio da empresa
    const empresaForm = $('#empresa-form');
    if (empresaForm) {
        empresaForm.addEventListener('submit', handleEmpresaSubmit);
    }
    
    // Formul√°rio de cliente
    const clienteForm = $('#cliente-form');
    if (clienteForm) {
        clienteForm.addEventListener('submit', handleClienteSubmit);
    }
    
    // Formul√°rio de servi√ßo
    const servicoForm = $('#servico-form');
    if (servicoForm) {
        servicoForm.addEventListener('submit', handleServicoSubmit);
    }
    
    // Or√ßamento
    const addServicoBtn = $('#add-servico-btn');
    const orcamentoForm = $('#orcamento-form');
    const descontoInput = $('#orcamento-desconto');
    
    if (addServicoBtn) addServicoBtn.addEventListener('click', (e) => {
        e.preventDefault();
        handleAddServicoToOrcamento();
    });
    
    if (orcamentoForm) orcamentoForm.addEventListener('submit', handleOrcamentoSubmit);
    if (descontoInput) descontoInput.addEventListener('input', updateOrcamentoTotal);
    
    // Hist√≥rico - switcher de visualiza√ß√£o
    const detalheBtns = $$('.detalhe-view-btn');
    detalheBtns.forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            const view = e.currentTarget.dataset.view;
            
            // Remove active de todos
            detalheBtns.forEach(b => b.classList.remove('active'));
            e.currentTarget.classList.add('active');
            
            // Mostra/esconde conte√∫dos
            $('#detalhes-orcamento').style.display = view === 'orcamento' ? 'block' : 'none';
            $('#detalhes-recibo').style.display = view === 'recibo' ? 'block' : 'none';
        });
    });
    
    // Delegated events para elementos din√¢micos
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-servico-btn')) {
            e.preventDefault();
            const index = parseInt(e.target.dataset.index);
            if (index >= 0) {
                state.novoOrcamentoItens.splice(index, 1);
                renderOrcamentoItens();
                showNotification('üóëÔ∏è Servi√ßo removido do or√ßamento', 'success');
            }
        }
    });
    
    document.addEventListener('change', (e) => {
        if (e.target.type === 'number' && e.target.dataset.index !== undefined) {
            const index = parseInt(e.target.dataset.index);
            const newQuantity = parseInt(e.target.value) || 1;
            
            if (newQuantity > 0 && newQuantity <= 99 && state.novoOrcamentoItens[index]) {
                state.novoOrcamentoItens[index].quantidade = newQuantity;
                updateOrcamentoTotal();
                showNotification('‚úÖ Quantidade atualizada', 'success');
            }
        }
    });
    
    // Back to top button
    const backToTopBtn = $('#back-to-top-btn');
    if (backToTopBtn) {
        window.addEventListener('scroll', () => {
            if (window.pageYOffset > 300) {
                backToTopBtn.classList.add('show');
            } else {
                backToTopBtn.classList.remove('show');
            }
        });
        
        backToTopBtn.addEventListener('click', (e) => {
            e.preventDefault();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    }
    
    // Status de rede
    window.addEventListener('online', () => {
        const indicator = $('#offline-indicator');
        if (indicator) indicator.classList.remove('show');
        showNotification('üì∂ Conex√£o restaurada!', 'success');
    });
    
    window.addEventListener('offline', () => {
        const indicator = $('#offline-indicator');
        if (indicator) indicator.classList.add('show');
        showNotification('üì∂ Modo offline ativado', 'warning');
    });
    
    console.log('‚úÖ Event listeners configurados!');
}

// ========================== INICIALIZA√á√ÉO ==========================
document.addEventListener('DOMContentLoaded', () => {
    console.log('üöÄ Inicializando R.M. Est√©tica PRO+...');
    
    try {
        // Mostra loading
        const loadingOverlay = $('#loading-overlay');
        if (loadingOverlay) {
            loadingOverlay.style.display = 'flex';
        }
        
        setTimeout(() => {
            // Carrega dados de demonstra√ß√£o
            loadDemoData();
            
            // Aplica tema inicial (dark)
            applyTheme('dark');
            
            // Configura event listeners ANTES de configurar m√°scaras
            setupEventListeners();
            
            // Configura m√°scaras de formata√ß√£o
            setupInputMasks();
            
            // Configura real-time (se dispon√≠vel)
            setupRealtimeListeners();
            
            // Renderiza conte√∫do inicial (dashboard)
            showTab('dashboard');
            
            // Define data atual nos campos de data
            const today = new Date().toISOString().split('T')[0];
            const interactionDateEl = $('#interaction-date');
            const despesaDateEl = $('#despesa-data');
            
            if (interactionDateEl) interactionDateEl.value = today;
            if (despesaDateEl) despesaDateEl.value = today;
            
            // Esconde loading
            if (loadingOverlay) {
                setTimeout(() => {
                    loadingOverlay.style.display = 'none';
                }, 500);
            }
            
            showNotification('üöó Sistema R.M. Est√©tica PRO+ inicializado com sucesso!', 'success');
            console.log('‚úÖ Inicializa√ß√£o conclu√≠da!');
            
        }, 1000); // Simula carregamento
        
    } catch (error) {
        console.error('‚ùå Erro na inicializa√ß√£o:', error);
        showNotification('‚ùå Erro na inicializa√ß√£o: ' + error.message, 'error');
        
        // Esconde loading mesmo com erro
        const loadingOverlay = $('#loading-overlay');
        if (loadingOverlay) {
            loadingOverlay.style.display = 'none';
        }
    }
});

// Torna fun√ß√µes globais dispon√≠veis para debugging
window.selecionarOrcamentoHistorico = selecionarOrcamentoHistorico;

// Exporta fun√ß√µes globais para debugging
window.rmEstetica = {
    state,
    showTab,
    showNotification,
    formatCurrency,
    formatDate,
    formatPhone,
    formatPlaca,
    applyTheme,
    loadDemoData,
    selecionarOrcamentoHistorico,
    copyText,
    baixarPDF,
    enviarWhatsApp,
    alterarStatus,
    editarOrcamento,
    excluirOrcamento,
    editarCliente,
    excluirCliente,
    editarServico,
    excluirServico
};

console.log('üöó‚ú® R.M. Est√©tica PRO+ - Sistema completamente carregado e funcional! ‚ú®üöó');